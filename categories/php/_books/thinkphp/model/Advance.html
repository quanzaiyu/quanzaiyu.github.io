<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>高级操作 | 小昱个人网站</title>
    <meta name="description" content="小昱个人网站">
    <meta http-equiv="Expires" content="Mon,12 May 2050 00:20:00 GMT">
  <link rel="icon" href="/logo.png">
  <link rel="manifest" href="/manifest.json">
  <link rel="stylesheet" href="//at.alicdn.com/t/font_517060_lom78h954w.css">
  <link rel="stylesheet" href="https://img.xiaoyulive.top/css/animate.css">
    
    <link rel="preload" href="/assets/css/0.styles.d5495972.css" as="style"><link rel="preload" href="/assets/js/app.848d211f.js" as="script"><link rel="preload" href="/assets/js/5.cd8054ad.js" as="script"><link rel="preload" href="/assets/js/14.0c1734d9.js" as="script"><link rel="prefetch" href="/assets/js/1.639bdc9a.js"><link rel="prefetch" href="/assets/js/10.e19b7469.js"><link rel="prefetch" href="/assets/js/11.a3ae743e.js"><link rel="prefetch" href="/assets/js/12.08b75db7.js"><link rel="prefetch" href="/assets/js/13.f397ae57.js"><link rel="prefetch" href="/assets/js/15.4852bcec.js"><link rel="prefetch" href="/assets/js/2.86f54203.js"><link rel="prefetch" href="/assets/js/6.dd8cde6a.js"><link rel="prefetch" href="/assets/js/7.49c395e1.js"><link rel="prefetch" href="/assets/js/8.0f4aa4da.js"><link rel="prefetch" href="/assets/js/9.73250f91.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.0fcdbc6c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d5495972.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-38547c78><header class="navbar" data-v-38547c78><div class="navbar-content"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/" class="home-link router-link-active"><img src="/logo.png" class="logo"><span class="site-name can-hide">小昱个人网站</span></a><div class="links"><nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">开发者博客</a></div><div class="nav-item"><a href="/articles/" class="nav-link">生活漫谈</a></div><div class="nav-item"><a href="/note/" class="nav-link">阅读札记</a></div><div class="nav-item"><a href="/categories/" class="nav-link router-link-active">学无止境</a></div><div class="nav-item"><a href="/share/" class="nav-link">精品分享</a></div><div class="nav-item"><a href="/favorite/" class="nav-link">收藏夹</a></div><!----></nav><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div></div></div></header><div class="sidebar-mask" data-v-38547c78></div><div class="sidebar" data-v-38547c78><div class="sidebar-container"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">开发者博客</a></div><div class="nav-item"><a href="/articles/" class="nav-link">生活漫谈</a></div><div class="nav-item"><a href="/note/" class="nav-link">阅读札记</a></div><div class="nav-item"><a href="/categories/" class="nav-link router-link-active">学无止境</a></div><div class="nav-item"><a href="/share/" class="nav-link">精品分享</a></div><div class="nav-item"><a href="/favorite/" class="nav-link">收藏夹</a></div><!----></nav><ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading"><span>ThinkPHP 学习指南</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>基础</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>配置</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>请求和响应</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>控制器</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>模型</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/categories/php/_books/thinkphp/model/" class="sidebar-link">定义与设置</a></li><li><a href="/categories/php/_books/thinkphp/model/CURD.html" class="sidebar-link">增删改查</a></li><li><a href="/categories/php/_books/thinkphp/model/Transform.html" class="sidebar-link">自动类型转换</a></li><li><a href="/categories/php/_books/thinkphp/model/Advance.html" class="active sidebar-link">高级操作</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/categories/php/_books/thinkphp/model/Advance.html#查询构造器" class="sidebar-link">查询构造器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/categories/php/_books/thinkphp/model/Advance.html#排序-order" class="sidebar-link">排序 order</a></li><li class="sidebar-sub-header"><a href="/categories/php/_books/thinkphp/model/Advance.html#限制-limit" class="sidebar-link">限制 limit</a></li></ul></li><li class="sidebar-sub-header"><a href="/categories/php/_books/thinkphp/model/Advance.html#聚合查询" class="sidebar-link">聚合查询</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/categories/php/_books/thinkphp/model/Advance.html#count" class="sidebar-link">count</a></li><li class="sidebar-sub-header"><a href="/categories/php/_books/thinkphp/model/Advance.html#avg" class="sidebar-link">avg</a></li><li class="sidebar-sub-header"><a href="/categories/php/_books/thinkphp/model/Advance.html#max-min" class="sidebar-link">max &amp;&amp; min</a></li></ul></li><li class="sidebar-sub-header"><a href="/categories/php/_books/thinkphp/model/Advance.html#查询范围" class="sidebar-link">查询范围</a></li><li class="sidebar-sub-header"><a href="/categories/php/_books/thinkphp/model/Advance.html#全局查询范围" class="sidebar-link">全局查询范围</a></li><li class="sidebar-sub-header"><a href="/categories/php/_books/thinkphp/model/Advance.html#获取器" class="sidebar-link">获取器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/categories/php/_books/thinkphp/model/Advance.html#获取原始数据" class="sidebar-link">获取原始数据</a></li></ul></li><li class="sidebar-sub-header"><a href="/categories/php/_books/thinkphp/model/Advance.html#修改器" class="sidebar-link">修改器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/categories/php/_books/thinkphp/model/Advance.html#批量修改" class="sidebar-link">批量修改</a></li></ul></li><li class="sidebar-sub-header"><a href="/categories/php/_books/thinkphp/model/Advance.html#自动时间戳" class="sidebar-link">自动时间戳</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/categories/php/_books/thinkphp/model/Advance.html#存取和读取" class="sidebar-link">存取和读取</a></li><li class="sidebar-sub-header"><a href="/categories/php/_books/thinkphp/model/Advance.html#设置时间字段的格式化类" class="sidebar-link">设置时间字段的格式化类</a></li><li class="sidebar-sub-header"><a href="/categories/php/_books/thinkphp/model/Advance.html#动态关闭时间戳写入" class="sidebar-link">动态关闭时间戳写入</a></li></ul></li><li class="sidebar-sub-header"><a href="/categories/php/_books/thinkphp/model/Advance.html#自动完成" class="sidebar-link">自动完成</a></li><li class="sidebar-sub-header"><a href="/categories/php/_books/thinkphp/model/Advance.html#模型事件" class="sidebar-link">模型事件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/categories/php/_books/thinkphp/model/Advance.html#快捷注册" class="sidebar-link">快捷注册</a></li></ul></li></ul></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>视图</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>数据库</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>验证器</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>路由</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>扩展</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>其他</span> <span class="arrow right"></span></p> <!----></div></li></ul></div></div><div class="page" data-v-38547c78><div class="content__default"><h1 id="高级操作"><a href="#高级操作" aria-hidden="true" class="header-anchor">#</a> 高级操作</h1> <h2 id="查询构造器"><a href="#查询构造器" aria-hidden="true" class="header-anchor">#</a> 查询构造器</h2> <p>在模型中仍然可以调用数据库的链式操作和查询方法，可以充分利用数据库的查询构造器的优势。</p> <h3 id="排序-order"><a href="#排序-order" aria-hidden="true" class="header-anchor">#</a> 排序 order</h3> <div class="language-php extra-class"><pre class="language-php"><code><span class="token variable">$data</span> <span class="token operator">=</span> User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'status'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'id desc'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$data</span> <span class="token operator">=</span> User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'status'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'id asc'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>转化为 SQL 分别为</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>zh_user<span class="token punctuation">`</span> <span class="token keyword">WHERE</span> <span class="token punctuation">`</span><span class="token keyword">status</span><span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> id <span class="token keyword">desc</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>zh_user<span class="token punctuation">`</span> <span class="token keyword">WHERE</span> <span class="token punctuation">`</span><span class="token keyword">status</span><span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> id <span class="token keyword">asc</span>
</code></pre></div><h3 id="限制-limit"><a href="#限制-limit" aria-hidden="true" class="header-anchor">#</a> 限制 limit</h3> <div class="language-php extra-class"><pre class="language-php"><code><span class="token variable">$data</span> <span class="token operator">=</span> User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'status'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$data</span> <span class="token operator">=</span> User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'status'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>转化为 SQL 分别为</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>zh_user<span class="token punctuation">`</span> <span class="token keyword">WHERE</span> <span class="token punctuation">`</span><span class="token keyword">status</span><span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">LIMIT</span> <span class="token number">2</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>zh_user<span class="token punctuation">`</span> <span class="token keyword">WHERE</span> <span class="token punctuation">`</span><span class="token keyword">status</span><span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">LIMIT</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span>
</code></pre></div><p>利用 limit 语句可以很容易的实现分页操作</p> <h2 id="聚合查询"><a href="#聚合查询" aria-hidden="true" class="header-anchor">#</a> 聚合查询</h2> <p>在模型中可以调用数据库的聚合方法查询</p> <h3 id="count"><a href="#count" aria-hidden="true" class="header-anchor">#</a> count</h3> <div class="language-php extra-class"><pre class="language-php"><code>User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'status'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'&gt;'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>转化为 SQL 为</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> tp_count <span class="token keyword">FROM</span> <span class="token punctuation">`</span>zh_user<span class="token punctuation">`</span> <span class="token keyword">WHERE</span> <span class="token punctuation">`</span><span class="token keyword">status</span><span class="token punctuation">`</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">LIMIT</span> <span class="token number">1</span>
</code></pre></div><h3 id="avg"><a href="#avg" aria-hidden="true" class="header-anchor">#</a> avg</h3> <div class="language-php extra-class"><pre class="language-php"><code>User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'status'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">avg</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'score'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>转化为 SQL 为</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token function">AVG</span><span class="token punctuation">(</span><span class="token punctuation">`</span>score<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> tp_avg <span class="token keyword">FROM</span> <span class="token punctuation">`</span>zh_user<span class="token punctuation">`</span> <span class="token keyword">WHERE</span> <span class="token punctuation">`</span><span class="token keyword">status</span><span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">LIMIT</span> <span class="token number">1</span>
</code></pre></div><h3 id="max-min"><a href="#max-min" aria-hidden="true" class="header-anchor">#</a> max &amp;&amp; min</h3> <div class="language-php extra-class"><pre class="language-php"><code>User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>转化为 SQL 为</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token function">MIN</span><span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> tp_min <span class="token keyword">FROM</span> <span class="token punctuation">`</span>zh_user<span class="token punctuation">`</span> <span class="token keyword">LIMIT</span> <span class="token number">1</span>
<span class="token keyword">SELECT</span> <span class="token function">MAX</span><span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> tp_max <span class="token keyword">FROM</span> <span class="token punctuation">`</span>zh_user<span class="token punctuation">`</span> <span class="token keyword">LIMIT</span> <span class="token number">1</span>
</code></pre></div><h2 id="查询范围"><a href="#查询范围" aria-hidden="true" class="header-anchor">#</a> 查询范围</h2> <p>可以对模型的查询和写入操作进行封装，方法格式为：<code>scopeName</code>，例如：</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\</span>index<span class="token punctuation">\</span>model</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>Model</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">scopeThinkphp</span><span class="token punctuation">(</span><span class="token variable">$query</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token variable">$query</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'name'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'thinkphp'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'id,name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">scopeAge</span><span class="token punctuation">(</span><span class="token variable">$query</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token variable">$query</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'age'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'&gt;'</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>就可以进行下面的条件查询：</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// 查找 name 为 thinkphp 的用户</span>
User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">scope</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'thinkphp'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 查找年龄大于20的10个用户</span>
User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">scope</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'age'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 查找 name 为 thinkphp 的用户并且年龄大于20的10个用户</span>
User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">scope</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'thinkphp,age'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>查询范围的方法可以定义额外的参数，例如User模型类定义如下：</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\</span>index<span class="token punctuation">\</span>model</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>Model</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">scopeEmail</span><span class="token punctuation">(</span><span class="token variable">$query</span><span class="token punctuation">,</span> <span class="token variable">$email</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token variable">$query</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'email'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'like'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'%'</span> <span class="token punctuation">.</span> <span class="token variable">$email</span> <span class="token punctuation">.</span> <span class="token single-quoted-string string">'%'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">scopeScore</span><span class="token punctuation">(</span><span class="token variable">$query</span><span class="token punctuation">,</span> <span class="token variable">$score</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token variable">$query</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'score'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'&gt;'</span><span class="token punctuation">,</span> <span class="token variable">$score</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在查询的时候可以如下使用：</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// 查询 email 包含 thinkphp 和分数大于80的用户</span>
User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">email</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'thinkphp'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">score</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>可以直接使用闭包函数进行查询，例如：</p> <div class="language-php extra-class"><pre class="language-php"><code>User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">scope</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token variable">$query</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token variable">$query</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'age'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'&gt;'</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>使用查询范围后，只能使用<code>find</code>或者<code>select</code>查询。</p></div> <h2 id="全局查询范围"><a href="#全局查询范围" aria-hidden="true" class="header-anchor">#</a> 全局查询范围</h2> <p>如果你的所有查询都需要一个基础的查询范围，那么可以在模型类里面定义一个静态的<code>base</code>方法，例如：</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\</span>index<span class="token punctuation">\</span>model</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>Model</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>
  <span class="token comment">// 定义全局的查询范围</span>
  <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function">base</span><span class="token punctuation">(</span><span class="token variable">$query</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token variable">$query</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'status'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后，执行下面的代码：</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token variable">$user</span> <span class="token operator">=</span> User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>最终的查询条件会是</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">status</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">AND</span> id <span class="token operator">=</span> <span class="token number">1</span>
</code></pre></div><p>如果需要动态关闭/开启全局查询访问，可以使用：</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// 关闭全局查询范围</span>
User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">useGlobalScope</span><span class="token punctuation">(</span><span class="token boolean constant">false</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 开启全局查询范围</span>
User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">useGlobalScope</span><span class="token punctuation">(</span><span class="token boolean constant">true</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="获取器"><a href="#获取器" aria-hidden="true" class="header-anchor">#</a> 获取器</h2> <p>获取器的作用是对模型实例的（原始）数据做出自动处理。一个获取器对应模型的一个特殊方法，方法格式为：<code>getFieldNameAttr</code></p> <p><code>FieldName</code>为数据表字段的驼峰转换，定义了获取器之后会在下列情况自动触发：</p> <ul><li>模型的数据对象取值操作（<code>$model-&gt;field_name</code>）；</li> <li>模型的序列化输出操作（<code>$model-&gt;toArray()</code>及<code>toJson()</code>）；</li> <li>显式调用<code>getAttr</code>方法（<code>$this-&gt;getAttr('field_name')</code>）；</li></ul> <p>获取器的场景包括：</p> <ul><li>时间日期字段的格式化输出；</li> <li>集合或枚举类型的输出；</li> <li>数字状态字段的输出；</li> <li>组合字段的输出；</li></ul> <p>如定义如下模型 :</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\</span>common<span class="token punctuation">\</span>model</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>Model</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>
  <span class="token keyword">protected</span> <span class="token variable">$pk</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'id'</span><span class="token punctuation">;</span>
  <span class="token keyword">protected</span> <span class="token variable">$table</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'zh_user'</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getStatusAttr</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$status</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token single-quoted-string string">'删除'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token single-quoted-string string">'禁用'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token single-quoted-string string">'正常'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token single-quoted-string string">'待审核'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token variable">$status</span><span class="token punctuation">[</span><span class="token variable">$value</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其中，第一形参 $value 为从数据库中取出的原始数据。</p> <p>控制器中使用时:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token variable">$data</span> <span class="token operator">=</span> User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">dump</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">status</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// string(6) &quot;正常&quot;</span>
</code></pre></div><p>获取器还可以定义数据表中不存在的字段。</p> <p>模型中 :</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getStatusTextAttr</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">,</span><span class="token variable">$data</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token variable">$status</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token single-quoted-string string">'删除'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token single-quoted-string string">'禁用'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token single-quoted-string string">'正常'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token single-quoted-string string">'待审核'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token variable">$status</span><span class="token punctuation">[</span><span class="token variable">$data</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'status'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其中，第二参数 $data 为原始的数据行。</p> <p>控制器中:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token variable">$user</span> <span class="token operator">=</span> User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">status_text</span><span class="token punctuation">;</span> <span class="token comment">// &quot;正常&quot;</span>

<span class="token comment">// or</span>

<span class="token keyword">echo</span> <span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getAttr</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'status'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="获取原始数据"><a href="#获取原始数据" aria-hidden="true" class="header-anchor">#</a> 获取原始数据</h3> <p>如果在定义了获取器的情况下，希望获取数据表中的原始数据，可以使用：</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token variable">$user</span> <span class="token operator">=</span> User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 通过获取器获取字段</span>
<span class="token keyword">echo</span> <span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">status</span><span class="token punctuation">;</span>

<span class="token comment">// 获取原始字段数据</span>
<span class="token keyword">echo</span> <span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'status'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 获取全部原始数据</span>
<span class="token function">dump</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="修改器"><a href="#修改器" aria-hidden="true" class="header-anchor">#</a> 修改器</h2> <p>和获取器相反，修改器的主要作用是对模型设置的数据对象值进行处理。</p> <p>修改器方法的命名规范为 <code>setFieldNameAttr</code></p> <p>修改器的使用场景和读取器类似：</p> <ul><li>时间日期字段的转换写入；</li> <li>集合或枚举类型的写入；</li> <li>数字状态字段的写入；</li> <li>某个字段涉及其它字段的条件或者组合写入；</li></ul> <p>定义了修改器之后会在下列情况下触发：</p> <ul><li>模型对象赋值；</li> <li>调用模型的<code>data</code>方法，并且第二个参数传入<code>true</code>；</li> <li>调用模型的<code>save</code>方法，并且传入数据；</li> <li>显式调用模型的<code>setAttr</code>方法；</li> <li>定义了该字段的自动完成；</li></ul> <p>比如定义一个将输入数据转化为小写的修改器</p> <p>模型中</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\</span>common<span class="token punctuation">\</span>model</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>Model</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>
  <span class="token keyword">protected</span> <span class="token variable">$pk</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'id'</span><span class="token punctuation">;</span>
  <span class="token keyword">protected</span> <span class="token variable">$table</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'zh_user'</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">setNameAttr</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">strtolower</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>控制器中，使用 save 方法可以直接触发修改器 :</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token variable">$user</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token single-quoted-string string">'name'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'XIAOYU'</span><span class="token punctuation">,</span>
  <span class="token single-quoted-string string">'email'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'yu@qq.com'</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">name</span><span class="token punctuation">;</span> <span class="token comment">// xiaoyu</span>
</code></pre></div><h3 id="批量修改"><a href="#批量修改" aria-hidden="true" class="header-anchor">#</a> 批量修改</h3> <p>除了赋值的方式可以触发修改器外，还可以用下面的方法批量触发修改器：</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token variable">$user</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$data</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'XIAOYU'</span><span class="token punctuation">;</span>
<span class="token variable">$data</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'email'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'yu@qq.com'</span><span class="token punctuation">;</span>
<span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token boolean constant">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">name</span><span class="token punctuation">;</span> <span class="token comment">// xiaoyu</span>
</code></pre></div><div class="warning custom-block"><p class="custom-block-title">WARNING</p> <p>修改器方法仅对模型的写入方法有效，调用数据库的写入方法写入无效，例如下面的方式修改器无效。</p></div> <div class="language-php extra-class"><pre class="language-php"><code><span class="token variable">$user</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$data</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'XIAOYU'</span><span class="token punctuation">;</span>
<span class="token variable">$data</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'email'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'yu@qq.com'</span><span class="token punctuation">;</span>
<span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="自动时间戳"><a href="#自动时间戳" aria-hidden="true" class="header-anchor">#</a> 自动时间戳</h2> <p>全局开启: 在 配置文件 <code>database.php</code> 中配置</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token single-quoted-string string">'auto_timestamp'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean constant">true</span><span class="token punctuation">,</span>
</code></pre></div><p>局部开启: 在 指定的模型中配置</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">protected</span> <span class="token variable">$autoWriteTimestamp</span> <span class="token operator">=</span> <span class="token boolean constant">true</span><span class="token punctuation">;</span>
</code></pre></div><p>默认自动时间戳将绑定数据表中的 <code>create_time</code> 和 <code>update_time</code> 两个字段，默认为整型（int），数据写入的时候将自动写入时间戳。</p> <p>如果为 <code>datetime</code> 或 <code>timestamp</code> 类型，则需要显式声明其类型:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">protected</span> <span class="token variable">$type</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token single-quoted-string string">'update_time'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token single-quoted-string string">'datetime'</span><span class="token punctuation">,</span>
  <span class="token single-quoted-string string">'create_time'</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token single-quoted-string string">'timestamp'</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p>如果需要修改默认绑定的字段，则:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">protected</span> <span class="token variable">$createTime</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'create_at'</span><span class="token punctuation">;</span>
<span class="token keyword">protected</span> <span class="token variable">$updateTime</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'update_at'</span><span class="token punctuation">;</span>
</code></pre></div><p>如果需要关闭某一个字段的自动写入，比如关闭更新时间的自动写入:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">protected</span> <span class="token variable">$updateTime</span> <span class="token operator">=</span> <span class="token boolean constant">true</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="存取和读取"><a href="#存取和读取" aria-hidden="true" class="header-anchor">#</a> 存取和读取</h3> <p>存取数据时，不需要使用修改器，也不需要显式指定时间戳字段，将自动获取当前时间戳并写入数据库，比如:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token variable">$user</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token single-quoted-string string">'name'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'XIAOYU'</span><span class="token punctuation">,</span>
  <span class="token single-quoted-string string">'email'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'yu@qq.com'</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="imgLink" data-v-16222526><img src="https://img.xiaoyulive.top/img/shortcut/019.png" data-v-16222526></div> <p>读取数据时，不需要使用获取器，会自动将时间戳转化为可读数据，比如 :</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token variable">$user</span> <span class="token operator">=</span> User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">dump</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="imgLink" data-v-16222526><img src="https://img.xiaoyulive.top/img/shortcut/018.png" data-v-16222526></div> <h3 id="设置时间字段的格式化类"><a href="#设置时间字段的格式化类" aria-hidden="true" class="header-anchor">#</a> 设置时间字段的格式化类</h3> <p><code>datetime_format</code> 参数支持设置为一个时间类名，用于时间戳的格式化输出</p> <p>默认为</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token single-quoted-string string">'datetime_format'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'\org\util\DateTime'</span><span class="token punctuation">,</span>
</code></pre></div><p>可以修改取出数据时的时间格式，在配置文件中修改 :</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token single-quoted-string string">'datetime_format'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'Y-m-d H:i:s'</span><span class="token punctuation">,</span>
</code></pre></div><h3 id="动态关闭时间戳写入"><a href="#动态关闭时间戳写入" aria-hidden="true" class="header-anchor">#</a> 动态关闭时间戳写入</h3> <p>例如，在更新阅读数的时候不修改更新时间，可以使用 <code>isAutoWriteTimestamp</code> 方法：</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token variable">$user</span> <span class="token operator">=</span> User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">read</span> <span class="token operator">+</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">isAutoWriteTimestamp</span><span class="token punctuation">(</span><span class="token boolean constant">false</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="自动完成"><a href="#自动完成" aria-hidden="true" class="header-anchor">#</a> 自动完成</h2> <p>数据自动完成指在不需要手动赋值的情况下对字段的值进行处理后写入数据库。</p> <p>系统支持<code>auto</code>、<code>insert</code>和<code>update</code>三个属性，可以分别在写入、新增和更新的时候进行字段的自动完成机制，<code>auto</code>属性自动完成包含新增和更新操作，例如我们定义<code>User</code>模型类如下：</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\</span>index<span class="token punctuation">\</span>model</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>Model</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>
  <span class="token keyword">protected</span> <span class="token variable">$auto</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token single-quoted-string string">'name'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'ip'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">protected</span> <span class="token variable">$insert</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token single-quoted-string string">'status'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">protected</span> <span class="token variable">$update</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function">setNameAttr</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">strtolower</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function">setIpAttr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">ip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>数据自动完成如果需要写入固定的值，可以直接指定（例如上面的status字段固定写入了1），类似于数据表字段的默认值功能。</p></div> <p>在新增数据的时候，会对<code>name</code>、<code>ip</code>和 <code>status</code> 字段自动完成或者处理。</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token variable">$user</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">;</span>
<span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">name</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'ThinkPHP'</span><span class="token punctuation">;</span>
<span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">name</span><span class="token punctuation">;</span> <span class="token comment">// thinkphp</span>
<span class="token keyword">echo</span> <span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">status</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
</code></pre></div><p>在更新数据的时候，会自动处理<code>name</code>字段的值及完成<code>ip</code>字段的赋值。</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token variable">$user</span> <span class="token operator">=</span> User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">name</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'THINKPHP'</span><span class="token punctuation">;</span>
<span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">name</span><span class="token punctuation">;</span> <span class="token comment">// thinkphp</span>
<span class="token keyword">echo</span> <span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">ip</span><span class="token punctuation">;</span> <span class="token comment">// 127.0.0.1</span>
</code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>数据自动完成仍然还是调用的修改器，要注意避免数据被两次处理的可能，自动完成定义的属性不要和表单提交的冲突。</p></div> <h2 id="模型事件"><a href="#模型事件" aria-hidden="true" class="header-anchor">#</a> 模型事件</h2> <p>模型事件是指在进行模型的写入操作的时候触发的操作行为，包括模型的<code>save</code>方法和<code>delete</code>方法。</p> <div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>模型事件只在调用模型的方法生效，使用查询构造器操作是无效的</p></div> <p>模型支持如下事件：</p> <table><thead><tr><th>事件</th> <th>描述</th> <th>快捷方法</th></tr></thead> <tbody><tr><td>before_insert</td> <td>新增前</td> <td>beforeInsert</td></tr> <tr><td>after_insert</td> <td>新增后</td> <td>afterInsert</td></tr> <tr><td>before_update</td> <td>更新前</td> <td>beforeUpdate</td></tr> <tr><td>after_update</td> <td>更新后</td> <td>afterUpdate</td></tr> <tr><td>before_write</td> <td>写入前</td> <td>beforeWrite</td></tr> <tr><td>after_write</td> <td>写入后</td> <td>afterWrite</td></tr> <tr><td>before_delete</td> <td>删除前</td> <td>beforeDelete</td></tr> <tr><td>after_delete</td> <td>删除后</td> <td>afterDelete</td></tr></tbody></table> <p>使用方法如下：</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\</span>index<span class="token punctuation">\</span>model</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>Model</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">event</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'before_insert'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">!=</span> <span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">status</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean constant">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>注册的回调方法支持传入一个参数（当前的模型对象实例），但支持依赖注入的方式增加额外参数。</p> <p>并且<code>before_write</code>、<code>before_insert</code>、 <code>before_update</code> 、<code>before_delete</code>事件方法如果返回false，则不会继续执行。</p> <p>支持给一个位置注册多个回调方法，例如：</p> <div class="language-php extra-class"><pre class="language-php"><code>User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">event</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'before_insert'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">status</span> <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean constant">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 注册回调到beforeInsert函数</span>
User<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">event</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'before_insert'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'beforeInsert'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="快捷注册"><a href="#快捷注册" aria-hidden="true" class="header-anchor">#</a> 快捷注册</h3> <p>系统提供了内置的事件注册的快捷方法，你可以统一在init方法中进行模型事件定义：</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">namespace</span> <span class="token package">app<span class="token punctuation">\</span>index<span class="token punctuation">\</span>model</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>Model</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>
  <span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">beforeInsert</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$user</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">status</span> <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean constant">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div><div class="article-info"><div class="article-title">文档信息</div><p class="article-item">版权声明：著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p><p class="article-item">文章标题：高级操作</p><p class="article-item">原文链接：<a href="https://www.xiaoyulive.top/categories/php/_books/thinkphp/model/Advance.html">https://www.xiaoyulive.top/categories/php/_books/thinkphp/model/Advance.html</a></p><!----></div><!----><div class="content page-nav"><p class="inner"><span class="prev">← <a href="/categories/php/_books/thinkphp/model/Transform.html">自动类型转换</a></span><span class="next"><a href="/categories/php/_books/thinkphp/view/">视图</a>  →</span></p></div></div><div class="footers" data-v-38547c78><p data-v-38547c78><span data-v-38547c78>MIT Licensed | Copyright © 2018-present  滇ICP备16006294号</span></p><p data-v-38547c78><span data-v-38547c78>Design by <a href="/">Quanzaiyu</a> | Power by <a href="https://vuepress.vuejs.org/" target="_blank">VuePress</a> | Hosted by <a href="https://pages.coding.me" target="_blank" style="font-weight: bold">Coding Pages</a></span></p></div></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.848d211f.js" defer></script><script src="/assets/js/5.cd8054ad.js" defer></script><script src="/assets/js/14.0c1734d9.js" defer></script>
  </body>
</html>
