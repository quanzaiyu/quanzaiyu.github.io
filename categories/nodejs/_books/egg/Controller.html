<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>控制器 | 小昱个人网站</title>
    <meta name="description" content="小昱个人网站">
    <meta http-equiv="Expires" content="Mon,12 May 2050 00:20:00 GMT">
  <meta name="keywords" content="小昱,个人网站,Vue,JavaScript,HTML,CSS">
  <link rel="icon" href="/logo.png">
  <link rel="manifest" href="/manifest.json">
  <link rel="stylesheet" href="//at.alicdn.com/t/font_517060_lom78h954w.css">
  <link rel="stylesheet" href="https://img.xiaoyulive.top/css/animate.css">
    
    <link rel="preload" href="/assets/css/0.styles.e2d81a46.css" as="style"><link rel="preload" href="/assets/js/app.995ba1c2.js" as="script"><link rel="preload" href="/assets/js/5.076b18eb.js" as="script"><link rel="prefetch" href="/assets/js/1.219654e8.js"><link rel="prefetch" href="/assets/js/10.06c3c4cb.js"><link rel="prefetch" href="/assets/js/11.30e63b90.js"><link rel="prefetch" href="/assets/js/12.125063c4.js"><link rel="prefetch" href="/assets/js/13.28235efb.js"><link rel="prefetch" href="/assets/js/14.db34b04b.js"><link rel="prefetch" href="/assets/js/15.d7dc2a8d.js"><link rel="prefetch" href="/assets/js/2.f5e33894.js"><link rel="prefetch" href="/assets/js/6.38488ccb.js"><link rel="prefetch" href="/assets/js/7.e54bf328.js"><link rel="prefetch" href="/assets/js/8.55ce7697.js"><link rel="prefetch" href="/assets/js/9.9371af59.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.960111d5.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e2d81a46.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-38547c78><header class="navbar" data-v-38547c78><div class="navbar-content"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/" class="home-link router-link-active"><img src="/logo.png" class="logo"><span class="site-name can-hide">小昱个人网站</span></a><div class="links"><nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">开发者博客</a></div><div class="nav-item"><a href="/articles/" class="nav-link">生活漫谈</a></div><div class="nav-item"><a href="/note/" class="nav-link">阅读札记</a></div><div class="nav-item"><a href="/categories/" class="nav-link router-link-active">学无止境</a></div><div class="nav-item"><a href="/share/" class="nav-link">精品分享</a></div><div class="nav-item"><a href="/favorite/" class="nav-link">收藏夹</a></div><!----></nav><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div></div></div></header><div class="sidebar-mask" data-v-38547c78></div><div class="sidebar" data-v-38547c78><div class="sidebar-container"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">开发者博客</a></div><div class="nav-item"><a href="/articles/" class="nav-link">生活漫谈</a></div><div class="nav-item"><a href="/note/" class="nav-link">阅读札记</a></div><div class="nav-item"><a href="/categories/" class="nav-link router-link-active">学无止境</a></div><div class="nav-item"><a href="/share/" class="nav-link">精品分享</a></div><div class="nav-item"><a href="/favorite/" class="nav-link">收藏夹</a></div><!----></nav><ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading"><span>Egg.js</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>基础</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/categories/nodejs/_books/egg/Basis.html" class="sidebar-link">框架基础</a></li><li><a href="/categories/nodejs/_books/egg/Config.html" class="sidebar-link">配置文件</a></li><li><a href="/categories/nodejs/_books/egg/Inner_Object.html" class="sidebar-link">内置对象</a></li><li><a href="/categories/nodejs/_books/egg/Middleware.html" class="sidebar-link">中间件</a></li><li><a href="/categories/nodejs/_books/egg/Router.html" class="sidebar-link">路由</a></li><li><a href="/categories/nodejs/_books/egg/Controller.html" class="active sidebar-link">控制器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/categories/nodejs/_books/egg/Controller.html#创建控制器" class="sidebar-link">创建控制器</a></li><li class="sidebar-sub-header"><a href="/categories/nodejs/_books/egg/Controller.html#自定义-controller-基类" class="sidebar-link">自定义 Controller 基类</a></li><li class="sidebar-sub-header"><a href="/categories/nodejs/_books/egg/Controller.html#发送http相应" class="sidebar-link">发送HTTP相应</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/categories/nodejs/_books/egg/Controller.html#渲染模板" class="sidebar-link">渲染模板</a></li></ul></li><li class="sidebar-sub-header"><a href="/categories/nodejs/_books/egg/Controller.html#参数获取" class="sidebar-link">参数获取</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/categories/nodejs/_books/egg/Controller.html#通过查询字符串" class="sidebar-link">通过查询字符串</a></li><li class="sidebar-sub-header"><a href="/categories/nodejs/_books/egg/Controller.html#通过路由参数" class="sidebar-link">通过路由参数</a></li><li class="sidebar-sub-header"><a href="/categories/nodejs/_books/egg/Controller.html#表单内容的获取" class="sidebar-link">表单内容的获取</a></li><li class="sidebar-sub-header"><a href="/categories/nodejs/_books/egg/Controller.html#从请求头获取参数" class="sidebar-link">从请求头获取参数</a></li></ul></li><li class="sidebar-sub-header"><a href="/categories/nodejs/_books/egg/Controller.html#cookie-与-session" class="sidebar-link">Cookie 与 Session</a></li></ul></li><li><a href="/categories/nodejs/_books/egg/Validate.html" class="sidebar-link">验证器</a></li><li><a href="/categories/nodejs/_books/egg/View.html" class="sidebar-link">模板</a></li><li><a href="/categories/nodejs/_books/egg/Service.html" class="sidebar-link">服务</a></li><li><a href="/categories/nodejs/_books/egg/Extension.html" class="sidebar-link">扩展</a></li><li><a href="/categories/nodejs/_books/egg/Plugin.html" class="sidebar-link">插件</a></li><li><a href="/categories/nodejs/_books/egg/Schedule.html" class="sidebar-link">定时任务</a></li><li><a href="/categories/nodejs/_books/egg/Log.html" class="sidebar-link">日志</a></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>进阶</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>数据库</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>扩展</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>问题解决</span> <span class="arrow right"></span></p> <!----></div></li></ul></div></div><div class="page" data-v-38547c78><div class="content__default"><h1 id="控制器"><a href="#控制器" aria-hidden="true" class="header-anchor">#</a> 控制器</h1> <h2 id="创建控制器"><a href="#创建控制器" aria-hidden="true" class="header-anchor">#</a> 创建控制器</h2> <p>方式一: 继承Controller类</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Controller <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token function">create</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span> msg<span class="token punctuation">:</span> <span class="token string">'ok'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> BaseController<span class="token punctuation">;</span>
</code></pre></div><p>方式二: 通过定义方法直接导出</p> <div class="language-js extra-class"><pre class="language-js"><code>exports<span class="token punctuation">.</span><span class="token function-variable function">create</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span> msg<span class="token punctuation">:</span> <span class="token string">'ok'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>方式三: 通过app.Controller创建</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 从 app 实例上获取</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token keyword">extends</span> <span class="token class-name">app<span class="token punctuation">.</span>Controller</span> <span class="token punctuation">{</span>
    <span class="token comment">// implement</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="自定义-controller-基类"><a href="#自定义-controller-基类" aria-hidden="true" class="header-anchor">#</a> 自定义 Controller 基类</h2> <p>按照类的方式编写 Controller，不仅可以让我们更好的对 Controller 层代码进行抽象（例如将一些统一的处理抽象成一些私有方法），还可以通过自定义 Controller 基类的方式封装应用中常用的方法。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app/core/base_controller.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> Controller <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">BaseController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">get</span> <span class="token function">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>user<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">success</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">200</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
      success<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      data<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">notFound</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    msg <span class="token operator">=</span> msg <span class="token operator">||</span> <span class="token string">'not found'</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> BaseController<span class="token punctuation">;</span>
</code></pre></div><p>此时在编写应用的 Controller 时，可以继承 BaseController，直接使用基类上的方法：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app/controller/post.js</span>
<span class="token keyword">const</span> Controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../core/base_controller'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">PostController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> posts <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>service<span class="token punctuation">.</span><span class="token function">listByUser</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>posts<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="发送http相应"><a href="#发送http相应" aria-hidden="true" class="header-anchor">#</a> 发送HTTP相应</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">PostController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span> <span class="token comment">// 设置HTTP状态码</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token comment">// 设置响应体</span>
      msg<span class="token punctuation">:</span> <span class="token string">'ok'</span><span class="token punctuation">,</span>
      data<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
      code<span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p><code>ctx.body</code> 是 <code>ctx.response.body</code> 的简写</p> <p>响应体解析为:</p> <ul><li>作为一个 RESTful 的 API 接口 controller，我们通常会返回 Content-Type 为 <code>application/json</code> 格式的 body，内容是一个 JSON 字符串。</li> <li>作为一个 html 页面的 controller，我们通常会返回 Content-Type 为 <code>text/html</code> 格式的 body，内容是 html 代码段。</li></ul> <p>由于 Node.js 的流式特性，我们还有很多场景需要通过 Stream 返回响应，例如返回一个大文件，代理服务器直接返回上游的内容，框架也支持直接将 body 设置成一个 Stream，并会同时处理好这个 Stream 上的错误事件。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">ProxyController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">proxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">;</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">curl</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      streaming<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>header<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// result.res 是一个 stream</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> result<span class="token punctuation">.</span>res<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="渲染模板"><a href="#渲染模板" aria-hidden="true" class="header-anchor">#</a> 渲染模板</h3> <p>通过 <code>ctx.render(template)</code> 来渲染模板生成 html</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">HomeController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">;</span>
    <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'home.tpl'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'egg'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ctx.body = await ctx.renderString('hi, {{ name }}', { name: 'egg' });</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="参数获取"><a href="#参数获取" aria-hidden="true" class="header-anchor">#</a> 参数获取</h2> <h3 id="通过查询字符串"><a href="#通过查询字符串" aria-hidden="true" class="header-anchor">#</a> 通过查询字符串</h3> <p>可以通过 <code>ctx.query</code> 获取查询字符串</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// GET http://127.0.0.1:7001/search?name=egg</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">index</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token template-string"><span class="token string">`search: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>query<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>如果传递的查询字符串包括多个相同的key, 可以通过 <code>ctx.queries</code> 获取:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// GET /posts?category=egg&amp;id=1&amp;id=2&amp;id=3</span>
<span class="token keyword">class</span> <span class="token class-name">PostController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">listPosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>queries<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// {</span>
    <span class="token comment">//   category: [ 'egg' ],</span>
    <span class="token comment">//   id: [ '1', '2', '3' ],</span>
    <span class="token comment">// }</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="通过路由参数"><a href="#通过路由参数" aria-hidden="true" class="header-anchor">#</a> 通过路由参数</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app/router.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  app<span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/user/:id/:name'</span><span class="token punctuation">,</span> app<span class="token punctuation">.</span>controller<span class="token punctuation">.</span>user<span class="token punctuation">.</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>可以通过 <code>ctx.params</code> 获取路由参数</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// GET http://127.0.0.1:7001/user/123/xiaoqiao</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">info</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token template-string"><span class="token string">`user: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="表单内容的获取"><a href="#表单内容的获取" aria-hidden="true" class="header-anchor">#</a> 表单内容的获取</h3> <p>通过 <code>request.body</code> 获取 POST、PUT、DELETE 等传过来的请求体</p> <p>框架内置了 <a href="https://github.com/koajs/bodyparser" target="_blank" rel="noopener noreferrer">bodyParser<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 中间件来对这两类格式的请求 body 解析成 object 挂载到 ctx.request.body 上。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app/controller/form.js</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">post</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
    status<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    msg<span class="token punctuation">:</span> <span class="token string">'ok'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// curl -X POST http://127.0.0.1:7001/form --data '{&quot;name&quot;:&quot;controller&quot;}' --header 'Content-Type:application/json'</span>
</code></pre></div><p>框架对 bodyParser 设置了一些默认参数，配置好之后拥有以下特性：</p> <ul><li>当请求的 Content-Type 为 <code>application/json</code>，<code>application/json-patch+json</code>，<code>application/vnd.api+json</code> 和 <code>application/csp-report</code> 时，会按照 json 格式对请求 body 进行解析，并限制 body 最大长度为 100kb。</li> <li>当请求的 Content-Type 为 <code>application/x-www-form-urlencoded</code> 时，会按照 form 格式对请求 body 进行解析，并限制 body 最大长度为 100kb。</li> <li>如果解析成功，body 一定会是一个 Object（可能是一个数组）。</li></ul> <p>我们最经常调整的配置项就是变更解析时允许的最大长度，可以在 <code>config/config.default.js</code> 中覆盖框架的默认值。</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  bodyParser<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    jsonLimit<span class="token punctuation">:</span> <span class="token string">'1mb'</span><span class="token punctuation">,</span>
    formLimit<span class="token punctuation">:</span> <span class="token string">'1mb'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>如果用户的请求 body 超过了我们配置的解析最大长度，会抛出一个状态码为 413 的异常，如果用户请求的 body 解析失败（错误的 JSON），会抛出一个状态码为 400 的异常。</p> <h3 id="从请求头获取参数"><a href="#从请求头获取参数" aria-hidden="true" class="header-anchor">#</a> 从请求头获取参数</h3> <ul><li><code>ctx.headers</code>，<code>ctx.header</code>，<code>ctx.request.headers</code>，<code>ctx.request.header</code>：这几个方法是等价的，都是获取整个 header 对象。</li> <li><code>ctx.get(name)</code>，<code>ctx.request.get(name)</code>：获取请求 header 中的一个字段的值，如果这个字段不存在，会返回空字符串。</li> <li>建议用 <code>ctx.get(name)</code> 而不是 <code>ctx.headers['name']</code>，因为前者会自动处理大小写。</li></ul> <p>有些头部信息可以通过更加简洁的方式获取:</p> <ul><li><code>ctx.host</code> 默认为 <code>x-forwarded-host</code></li> <li><code>ctx.protocol</code> 默认为 <code>x-forwarded-proto</code></li> <li><code>ctx.ips</code> 默认为 <code>x-forwarded-for</code></li> <li><code>ctx.ip</code> 当 config.proxy = false 时会返回当前连接发起者的 ip 地址，ips 此时会为空数组</li></ul> <h2 id="cookie-与-session"><a href="#cookie-与-session" aria-hidden="true" class="header-anchor">#</a> Cookie 与 Session</h2> <ul><li><code>ctx.cookies.get(key)</code> 获取指定 Cookie</li> <li><code>ctx.cookies.set(key, value)</code> 设置 Cookie</li> <li>直接通过 <code>ctx.session</code> 设置或获取session值, 比如 <code>ctx.session.id=0</code>, <code>const id=ctx.session.id</code></li></ul></div><div class="article-info"><div class="article-title">文档信息</div><p class="article-item">版权声明：著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p><p class="article-item">文章标题：控制器</p><p class="article-item">原文链接：<a href="https://www.xiaoyulive.top/categories/nodejs/_books/egg/Controller.html">https://www.xiaoyulive.top/categories/nodejs/_books/egg/Controller.html</a></p><!----></div><!----><div class="content page-nav"><p class="inner"><span class="prev">← <a href="/categories/nodejs/_books/egg/Router.html">路由</a></span><span class="next"><a href="/categories/nodejs/_books/egg/Validate.html">验证器</a>  →</span></p></div></div><div class="footers" data-v-38547c78><p data-v-38547c78><span data-v-38547c78>MIT Licensed | Copyright © 2018-present  滇ICP备16006294号</span></p><p data-v-38547c78><span data-v-38547c78>Design by <a href="/">Quanzaiyu</a> | Power by <a href="https://vuepress.vuejs.org/" target="_blank">VuePress</a> | Hosted by <a href="https://pages.coding.me" target="_blank" style="font-weight: bold">Coding Pages</a></span></p></div></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.995ba1c2.js" defer></script><script src="/assets/js/5.076b18eb.js" defer></script>
  </body>
</html>
