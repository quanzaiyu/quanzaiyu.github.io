<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>内置对象 | 小昱个人网站</title>
    <meta name="description" content="小昱个人网站">
    <meta http-equiv="Expires" content="Mon,12 May 2050 00:20:00 GMT">
  <link rel="icon" href="/logo.png">
  <link rel="manifest" href="/manifest.json">
  <link rel="stylesheet" href="//at.alicdn.com/t/font_517060_lom78h954w.css">
  <link rel="stylesheet" href="https://img.xiaoyulive.top/css/animate.css">
    
    <link rel="preload" href="/assets/css/0.styles.b4f00dfd.css" as="style"><link rel="preload" href="/assets/js/app.5ed478ae.js" as="script"><link rel="preload" href="/assets/js/5.feabe54f.js" as="script"><link rel="prefetch" href="/assets/js/1.dedaff9f.js"><link rel="prefetch" href="/assets/js/10.169e23c5.js"><link rel="prefetch" href="/assets/js/11.f7098bb5.js"><link rel="prefetch" href="/assets/js/12.c76caa90.js"><link rel="prefetch" href="/assets/js/13.9f9b9f15.js"><link rel="prefetch" href="/assets/js/14.778049a5.js"><link rel="prefetch" href="/assets/js/15.9fa28897.js"><link rel="prefetch" href="/assets/js/2.dbca5474.js"><link rel="prefetch" href="/assets/js/6.2d94c0d8.js"><link rel="prefetch" href="/assets/js/7.c1decb98.js"><link rel="prefetch" href="/assets/js/8.b2f9135e.js"><link rel="prefetch" href="/assets/js/9.e91dfdf4.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.c321be08.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b4f00dfd.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-38547c78><header class="navbar" data-v-38547c78><div class="navbar-content"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/" class="home-link router-link-active"><img src="/logo.png" class="logo"><span class="site-name can-hide">小昱个人网站</span></a><div class="links"><nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">开发者博客</a></div><div class="nav-item"><a href="/articles/" class="nav-link">生活漫谈</a></div><div class="nav-item"><a href="/note/" class="nav-link">阅读札记</a></div><div class="nav-item"><a href="/categories/" class="nav-link router-link-active">学无止境</a></div><div class="nav-item"><a href="/share/" class="nav-link">精品分享</a></div><div class="nav-item"><a href="/favorite/" class="nav-link">收藏夹</a></div><!----></nav><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div></div></div></header><div class="sidebar-mask" data-v-38547c78></div><div class="sidebar" data-v-38547c78><div class="sidebar-container"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">开发者博客</a></div><div class="nav-item"><a href="/articles/" class="nav-link">生活漫谈</a></div><div class="nav-item"><a href="/note/" class="nav-link">阅读札记</a></div><div class="nav-item"><a href="/categories/" class="nav-link router-link-active">学无止境</a></div><div class="nav-item"><a href="/share/" class="nav-link">精品分享</a></div><div class="nav-item"><a href="/favorite/" class="nav-link">收藏夹</a></div><!----></nav><ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading"><span>Egg.js</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>基础</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/categories/nodejs/_books/egg/Basis.html" class="sidebar-link">框架基础</a></li><li><a href="/categories/nodejs/_books/egg/Config.html" class="sidebar-link">配置文件</a></li><li><a href="/categories/nodejs/_books/egg/Inner_Object.html" class="active sidebar-link">内置对象</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/categories/nodejs/_books/egg/Inner_Object.html#application" class="sidebar-link">Application</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/categories/nodejs/_books/egg/Inner_Object.html#获取方式" class="sidebar-link">获取方式</a></li><li class="sidebar-sub-header"><a href="/categories/nodejs/_books/egg/Inner_Object.html#事件监听" class="sidebar-link">事件监听</a></li></ul></li><li class="sidebar-sub-header"><a href="/categories/nodejs/_books/egg/Inner_Object.html#context" class="sidebar-link">Context</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/categories/nodejs/_books/egg/Inner_Object.html#获取方式-2" class="sidebar-link">获取方式</a></li></ul></li><li class="sidebar-sub-header"><a href="/categories/nodejs/_books/egg/Inner_Object.html#request-response" class="sidebar-link">Request &amp; Response</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/categories/nodejs/_books/egg/Inner_Object.html#获取方式-3" class="sidebar-link">获取方式</a></li></ul></li><li class="sidebar-sub-header"><a href="/categories/nodejs/_books/egg/Inner_Object.html#controller" class="sidebar-link">Controller</a></li><li class="sidebar-sub-header"><a href="/categories/nodejs/_books/egg/Inner_Object.html#service" class="sidebar-link">Service</a></li><li class="sidebar-sub-header"><a href="/categories/nodejs/_books/egg/Inner_Object.html#helper" class="sidebar-link">Helper</a></li><li class="sidebar-sub-header"><a href="/categories/nodejs/_books/egg/Inner_Object.html#config" class="sidebar-link">Config</a></li><li class="sidebar-sub-header"><a href="/categories/nodejs/_books/egg/Inner_Object.html#logger" class="sidebar-link">Logger</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/categories/nodejs/_books/egg/Inner_Object.html#app-logger" class="sidebar-link">App Logger</a></li><li class="sidebar-sub-header"><a href="/categories/nodejs/_books/egg/Inner_Object.html#app-corelogger" class="sidebar-link">App CoreLogger</a></li><li class="sidebar-sub-header"><a href="/categories/nodejs/_books/egg/Inner_Object.html#context-logger" class="sidebar-link">Context Logger</a></li><li class="sidebar-sub-header"><a href="/categories/nodejs/_books/egg/Inner_Object.html#context-corelogger" class="sidebar-link">Context CoreLogger</a></li><li class="sidebar-sub-header"><a href="/categories/nodejs/_books/egg/Inner_Object.html#controller-logger-service-logger" class="sidebar-link">Controller Logger &amp; Service Logger</a></li></ul></li><li class="sidebar-sub-header"><a href="/categories/nodejs/_books/egg/Inner_Object.html#subscription" class="sidebar-link">Subscription</a></li></ul></li><li><a href="/categories/nodejs/_books/egg/Middleware.html" class="sidebar-link">中间件</a></li><li><a href="/categories/nodejs/_books/egg/Router.html" class="sidebar-link">路由</a></li><li><a href="/categories/nodejs/_books/egg/Controller.html" class="sidebar-link">控制器</a></li><li><a href="/categories/nodejs/_books/egg/Validate.html" class="sidebar-link">验证器</a></li><li><a href="/categories/nodejs/_books/egg/View.html" class="sidebar-link">模板</a></li><li><a href="/categories/nodejs/_books/egg/Service.html" class="sidebar-link">服务</a></li><li><a href="/categories/nodejs/_books/egg/Extension.html" class="sidebar-link">扩展</a></li><li><a href="/categories/nodejs/_books/egg/Plugin.html" class="sidebar-link">插件</a></li><li><a href="/categories/nodejs/_books/egg/Schedule.html" class="sidebar-link">定时任务</a></li><li><a href="/categories/nodejs/_books/egg/Log.html" class="sidebar-link">日志</a></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>进阶</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>数据库</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>扩展</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>问题解决</span> <span class="arrow right"></span></p> <!----></div></li></ul></div></div><div class="page" data-v-38547c78><div class="content default"><h1 id="内置对象"><a href="#内置对象" aria-hidden="true" class="header-anchor">#</a> 内置对象</h1> <h2 id="application"><a href="#application" aria-hidden="true" class="header-anchor">#</a> Application</h2> <p>Application 为 egg 的全局应用对象, 在一个应用中只会实例化一次, Application 对象几乎可以在编写应用时的任何一个地方获取到。</p> <h3 id="获取方式"><a href="#获取方式" aria-hidden="true" class="header-anchor">#</a> 获取方式</h3> <p>几乎所有被框架 <a href="https://eggjs.org/zh-cn/advanced/loader.html" target="_blank" rel="noopener noreferrer">Loader<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 加载的文件（Controller，Service，Schedule 等），都可以 export 一个函数，这个函数会被 Loader 调用，并使用 app 作为参数：</p> <p><code>app.js</code></p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  app<span class="token punctuation">.</span>cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>在继承于 Controller, Service 基类的实例中，可以通过 <code>this.app</code> 访问到 Application 对象。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>query<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>和 <a href="http://koajs.com/" target="_blank" rel="noopener noreferrer">Koa<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 一样，在 Context 对象上，可以通过 <code>ctx.app</code> 访问到 Application 对象。以上面的 Controller 文件举例：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>app<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>query<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="事件监听"><a href="#事件监听" aria-hidden="true" class="header-anchor">#</a> 事件监听</h3> <p>在框架运行时，会在 Application 实例上触发一些事件，应用开发者或者插件开发者可以监听这些事件做一些操作。作为应用开发者，我们一般会在启动自定义脚本中进行监听。</p> <ul><li>server: 该事件一个 worker 进程只会触发一次，在 HTTP 服务完成启动后，会将 HTTP server 通过这个事件暴露出来给开发者。</li> <li>error: 运行时有任何的异常被 onerror 插件捕获后，都会触发 error 事件，将错误对象和关联的上下文（如果有）暴露给开发者，可以进行自定义的日志记录上报等处理。</li> <li>request 和 response: 应用收到请求和响应请求时，分别会触发 request 和 response 事件，并将当前请求上下文暴露出来，开发者可以监听这两个事件来进行日志记录。</li></ul> <p><code>app.js</code></p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  app<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">'server'</span><span class="token punctuation">,</span> <span class="token parameter">server</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// websocket</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  app<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// report error</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  app<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// log receive request</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  app<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'response'</span><span class="token punctuation">,</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// ctx.starttime is set by framework</span>
    <span class="token keyword">const</span> used <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> ctx<span class="token punctuation">.</span>starttime<span class="token punctuation">;</span>
    <span class="token comment">// log total cost</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="context"><a href="#context" aria-hidden="true" class="header-anchor">#</a> Context</h2> <p>Context 是一个<strong>请求级别的对象</strong>，继承自 <a href="http://koajs.com/#context" target="_blank" rel="noopener noreferrer">Koa.Context<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。在每一次收到用户请求时，框架会实例化一个 Context 对象，这个对象封装了这次用户请求的信息，并提供了许多便捷的方法来获取请求参数或者设置响应信息。框架会将所有的 Service 挂载到 Context 实例上，一些插件也会将一些其他的方法和对象挂载到它上面（<a href="https://github.com/eggjs/egg-sequelize" target="_blank" rel="noopener noreferrer">egg-sequelize<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 会将所有的 model 挂载在 Context 上）。</p> <h3 id="获取方式-2"><a href="#获取方式-2" aria-hidden="true" class="header-anchor">#</a> 获取方式</h3> <p>最常见的 Context 实例获取方式是在 Middleware, Controller 以及 Service 中。Controller 中的获取方式在上面的例子中已经展示过了，在 Service 中获取和 Controller 中获取的方式一样，在 Middleware 中获取 Context 实例则和 <a href="http://koajs.com/" target="_blank" rel="noopener noreferrer">Koa<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 框架在中间件中获取 Context 对象的方式一致。</p> <p>框架的 <a href="/categories/nodejs/_books/egg/Middleware.html">Middleware</a> 同时支持 Koa v1 和 Koa v2 两种不同的中间件写法，根据不同的写法，获取 Context 实例的方式也稍有不同：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Koa v1</span>
<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">middleware</span><span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// this is instance of Context</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">yield</span> next<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Koa v2</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">middleware</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ctx is instance of Context</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>除了在请求时可以获取 Context 实例之外， 在有些非用户请求的场景下我们需要访问 service / model 等 Context 实例上的对象，我们可以通过 <code>Application.createAnonymousContext()</code> 方法创建一个匿名 Context 实例：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  app<span class="token punctuation">.</span><span class="token function">beforeStart</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ctx <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">createAnonymousContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// preload before app start</span>
    <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>posts<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在<a href="/categories/nodejs/_books/egg/Schedule.html">定时任务</a>中的每一个 task 都接受一个 Context 实例作为参数，以便我们更方便的执行一些定时的业务逻辑：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app/schedule/refresh.js</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">task</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>posts<span class="token punctuation">.</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="request-response"><a href="#request-response" aria-hidden="true" class="header-anchor">#</a> Request &amp; Response</h2> <p>Request 是一个<strong>请求级别的对象</strong>，继承自 <a href="http://koajs.com/#request" target="_blank" rel="noopener noreferrer">Koa.Request<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。封装了 Node.js 原生的 HTTP Request 对象，提供了一系列辅助方法获取 HTTP 请求常用参数。</p> <p>Response 是一个<strong>请求级别的对象</strong>，继承自 <a href="http://koajs.com/#response" target="_blank" rel="noopener noreferrer">Koa.Response<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。封装了 Node.js 原生的 HTTP Response 对象，提供了一系列辅助方法设置 HTTP 响应。</p> <h3 id="获取方式-3"><a href="#获取方式-3" aria-hidden="true" class="header-anchor">#</a> 获取方式</h3> <p>可以在 Context 的实例上获取到当前请求的 Request(<code>ctx.request</code>) 和 Response(<code>ctx.response</code>) 实例。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app/controller/user.js</span>
<span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> id <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>query<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>body <span class="token operator">=</span> app<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><a href="http://koajs.com/" target="_blank" rel="noopener noreferrer">Koa<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 会在 Context 上代理一部分 Request 和 Response 上的方法和属性，参见 <a href="http://koajs.com/#context" target="_blank" rel="noopener noreferrer">Koa.Context<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</li> <li>如上面例子中的 <code>ctx.request.query.id</code> 和 <code>ctx.query.id</code> 是等价的，<code>ctx.response.body=</code> 和 <code>ctx.body=</code> 是等价的。</li> <li>需要注意的是，获取 POST 的 body 应该使用 <code>ctx.request.body</code>，而不是 <code>ctx.body</code>。</li></ul> <h2 id="controller"><a href="#controller" aria-hidden="true" class="header-anchor">#</a> Controller</h2> <p>框架提供了一个 Controller 基类，并推荐所有的 Controller 都继承于该基类实现。这个 Controller 基类有下列属性：</p> <ul><li><code>ctx</code> - 当前请求的 Context 实例。</li> <li><code>app</code> - 应用的 Application 实例。</li> <li><code>config</code> - 应用的配置。</li> <li><code>service</code> - 应用所有的 service。</li> <li><code>logger</code> - 为当前 controller 封装的 logger 对象。</li></ul> <p>详见 <a href="/categories/nodejs/_books/egg/Controller.html">控制器</a></p> <h2 id="service"><a href="#service" aria-hidden="true" class="header-anchor">#</a> Service</h2> <p>框架提供了一个 Service 基类，并推荐所有的 Service 都继承于该基类实现。</p> <p>Service 基类的属性和 Controller 基类属性一致，访问方式也类似：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app/service/user.js</span>

<span class="token comment">// 从 egg 上获取（推荐）</span>
<span class="token keyword">const</span> Service <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Service<span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token keyword">extends</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span>
  <span class="token comment">// implement</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> UserService<span class="token punctuation">;</span>

<span class="token comment">// 从 app 实例上获取</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token keyword">extends</span> <span class="token class-name">app<span class="token punctuation">.</span>Service</span> <span class="token punctuation">{</span>
    <span class="token comment">// implement</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>创建和获取方式参考 <a href="/categories/nodejs/_books/egg/Service.html">服务</a></p> <h2 id="helper"><a href="#helper" aria-hidden="true" class="header-anchor">#</a> Helper</h2> <p>Helper 用来提供一些实用的 utility 函数。它的作用在于我们可以将一些常用的动作抽离在 helper.js 里面成为一个独立的函数，这样可以用 JavaScript 来写复杂的逻辑，避免逻辑分散各处，同时可以更好的编写测试用例。</p> <p>Helper 自身是一个类，有和 <a href="https://eggjs.org/zh-cn/basics/objects.html#controller" target="_blank" rel="noopener noreferrer">Controller<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 基类一样的属性，它也会在每次请求时进行实例化，因此 Helper 上的所有函数也能获取到当前请求相关的上下文信息。</p> <p>创建和获取方式参考 <a href="/categories/nodejs/_books/egg/Extension.html#助手函数扩展">助手函数扩展</a></p> <h2 id="config"><a href="#config" aria-hidden="true" class="header-anchor">#</a> Config</h2> <p>我们推荐应用开发遵循配置和代码分离的原则，将一些需要硬编码的业务配置都放到配置文件中，同时配置文件支持各个不同的运行环境使用不同的配置，使用起来也非常方便，所有框架、插件和应用级别的配置都可以通过 Config 对象获取到，关于框架的配置，可以详细阅读 <a href="https://eggjs.org/zh-cn/basics/config.html" target="_blank" rel="noopener noreferrer">Config 配置<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>章节。</p> <p>获取方式参考 <a href="/categories/nodejs/_books/egg/Config.html#获取方式">Config 的获取方式</a></p> <h2 id="logger"><a href="#logger" aria-hidden="true" class="header-anchor">#</a> Logger</h2> <p>框架内置了功能强大的<a href="https://eggjs.org/zh-cn/core/logger.html" target="_blank" rel="noopener noreferrer">日志功能<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，可以非常方便的打印各种级别的日志到对应的日志文件中，每一个 logger 对象都提供了 4 个级别的方法：</p> <ul><li><code>logger.debug()</code></li> <li><code>logger.info()</code></li> <li><code>logger.warn()</code></li> <li><code>logger.error()</code></li></ul> <p>在框架中提供了多个 Logger 对象，下面我们简单的介绍一下各个 Logger 对象的获取方式和使用场景。</p> <h3 id="app-logger"><a href="#app-logger" aria-hidden="true" class="header-anchor">#</a> App Logger</h3> <p>我们可以通过 <code>app.logger</code> 来获取到它，如果我们想做一些应用级别的日志记录，如记录启动阶段的一些数据信息，记录一些业务上与请求无关的信息，都可以通过 App Logger 来完成。</p> <h3 id="app-corelogger"><a href="#app-corelogger" aria-hidden="true" class="header-anchor">#</a> App CoreLogger</h3> <p>我们可以通过 <code>app.coreLogger</code> 来获取到它，一般我们在开发应用时都不应该通过 CoreLogger 打印日志，而框架和插件则需要通过它来打印应用级别的日志，这样可以更清晰的区分应用和框架打印的日志，通过 CoreLogger 打印的日志会放到和 Logger 不同的文件中。</p> <h3 id="context-logger"><a href="#context-logger" aria-hidden="true" class="header-anchor">#</a> Context Logger</h3> <p>我们可以通过 <code>ctx.logger</code> 从 Context 实例上获取到它，从访问方式上我们可以看出来，Context Logger 一定是与请求相关的，它打印的日志都会在前面带上一些当前请求相关的信息（如 <code>[$userId/$ip/$traceId/${cost}ms $method $url]</code>），通过这些信息，我们可以从日志快速定位请求，并串联一次请求中的所有的日志。</p> <h3 id="context-corelogger"><a href="#context-corelogger" aria-hidden="true" class="header-anchor">#</a> Context CoreLogger</h3> <p>我们可以通过 <code>ctx.coreLogger</code> 获取到它，和 Context Logger 的区别是一般只有插件和框架会通过它来记录日志。</p> <h3 id="controller-logger-service-logger"><a href="#controller-logger-service-logger" aria-hidden="true" class="header-anchor">#</a> Controller Logger &amp; Service Logger</h3> <p>我们可以在 Controller 和 Service 实例上通过 <code>this.logger</code> 获取到它们，它们本质上就是一个 Context Logger，不过在打印日志的时候还会额外的加上文件路径，方便定位日志的打印位置。</p> <h2 id="subscription"><a href="#subscription" aria-hidden="true" class="header-anchor">#</a> Subscription</h2> <p>订阅模型是一种比较常见的开发模式，譬如消息中间件的消费者或调度任务。因此我们提供了 Subscription 基类来规范化这个模式。</p> <p>可以通过以下方式来引用 Subscription 基类：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Subscription <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Subscription<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Schedule</span> <span class="token keyword">extends</span> <span class="token class-name">Subscription</span> <span class="token punctuation">{</span>
  <span class="token comment">// 需要实现此方法</span>
  <span class="token comment">// subscribe 可以为 async function 或 generator function</span>
  <span class="token keyword">async</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>插件开发者可以根据自己的需求基于它定制订阅规范，如<a href="/categories/nodejs/_books/egg/Schedule.html">定时任务</a>就是使用这种规范实现的。</p></div><div class="article-info"><div class="article-title">文档信息</div><p class="article-item">版权声明：著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p><p class="article-item">文章标题：内置对象</p><p class="article-item">原文链接：<a href="https://www.xiaoyulive.top/categories/nodejs/_books/egg/Inner_Object.html">https://www.xiaoyulive.top/categories/nodejs/_books/egg/Inner_Object.html</a></p><!----></div><!----><div class="content page-nav"><p class="inner"><span class="prev">← <a href="/categories/nodejs/_books/egg/Config.html">配置文件</a></span><span class="next"><a href="/categories/nodejs/_books/egg/Middleware.html">中间件</a>  →</span></p></div></div><div class="footers" data-v-38547c78><p data-v-38547c78><span data-v-38547c78>MIT Licensed | Copyright © 2018-present  滇ICP备16006294号</span></p><p data-v-38547c78><span data-v-38547c78>Design by <a href="/">Quanzaiyu</a> | Power by <a href="https://vuepress.vuejs.org/" target="_blank">VuePress</a> | Hosted by <a href="https://pages.coding.me" target="_blank" style="font-weight: bold">Coding Pages</a></span></p></div></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.5ed478ae.js" defer></script><script src="/assets/js/5.feabe54f.js" defer></script>
  </body>
</html>
