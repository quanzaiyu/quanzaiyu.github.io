<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>内置模块 - crypto | 小昱个人网站</title>
    <meta name="description" content="小昱个人网站">
    <meta http-equiv="Expires" content="Mon,12 May 2050 00:20:00 GMT">
  <link rel="icon" href="/logo.png">
  <link rel="manifest" href="/manifest.json">
  <link rel="stylesheet" href="//at.alicdn.com/t/font_517060_lom78h954w.css">
  <link rel="stylesheet" href="https://img.xiaoyulive.top/css/animate.css">
    
    <link rel="preload" href="/assets/css/0.styles.9c61c892.css" as="style"><link rel="preload" href="/assets/js/app.6d543b11.js" as="script"><link rel="preload" href="/assets/js/5.9e615a5d.js" as="script"><link rel="prefetch" href="/assets/js/1.3530781f.js"><link rel="prefetch" href="/assets/js/10.11dcbe7b.js"><link rel="prefetch" href="/assets/js/11.e1ed45e0.js"><link rel="prefetch" href="/assets/js/12.511b711b.js"><link rel="prefetch" href="/assets/js/13.776b02ff.js"><link rel="prefetch" href="/assets/js/14.9bfac5f2.js"><link rel="prefetch" href="/assets/js/15.70a29f75.js"><link rel="prefetch" href="/assets/js/16.866ebf81.js"><link rel="prefetch" href="/assets/js/2.78c40e8d.js"><link rel="prefetch" href="/assets/js/6.6cfd8194.js"><link rel="prefetch" href="/assets/js/7.4d7e86f5.js"><link rel="prefetch" href="/assets/js/8.af207216.js"><link rel="prefetch" href="/assets/js/9.9ceb6f45.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.28d51d8e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9c61c892.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-38547c78><header class="navbar" data-v-38547c78><div class="navbar-content"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/" class="home-link router-link-active"><img src="/logo.png" class="logo"><span class="site-name can-hide">小昱个人网站</span></a><div class="links"><nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">开发者博客</a></div><div class="nav-item"><a href="/articles/" class="nav-link">生活漫谈</a></div><div class="nav-item"><a href="/note/" class="nav-link">阅读札记</a></div><div class="nav-item"><a href="/categories/" class="nav-link router-link-active">学无止境</a></div><div class="nav-item"><a href="/share/" class="nav-link">精品分享</a></div><div class="nav-item"><a href="/favorite/" class="nav-link">收藏夹</a></div><!----></nav><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div></div></div></header><div class="sidebar-mask" data-v-38547c78></div><div class="sidebar" data-v-38547c78><div class="sidebar-container"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">开发者博客</a></div><div class="nav-item"><a href="/articles/" class="nav-link">生活漫谈</a></div><div class="nav-item"><a href="/note/" class="nav-link">阅读札记</a></div><div class="nav-item"><a href="/categories/" class="nav-link router-link-active">学无止境</a></div><div class="nav-item"><a href="/share/" class="nav-link">精品分享</a></div><div class="nav-item"><a href="/favorite/" class="nav-link">收藏夹</a></div><!----></nav><ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading"><span>Node.js</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>基础</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>模块</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/categories/nodejs/_books/node/Module.html" class="sidebar-link">模块</a></li><li><a href="/categories/nodejs/_books/node/This.html" class="sidebar-link">Node 中的 this</a></li><li><a href="/categories/nodejs/_books/node/Inner_Module_Global.html" class="sidebar-link">全局对象 global</a></li><li><a href="/categories/nodejs/_books/node/Inner_Module_Console.html" class="sidebar-link">全局对象 console</a></li><li><a href="/categories/nodejs/_books/node/Inner_Module_Process.html" class="sidebar-link">全局对象 process</a></li><li><a href="/categories/nodejs/_books/node/Inner_Module_Crypto.html" class="active sidebar-link">内置模块 - crypto</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/categories/nodejs/_books/node/Inner_Module_Crypto.html#md5" class="sidebar-link">MD5</a></li><li class="sidebar-sub-header"><a href="/categories/nodejs/_books/node/Inner_Module_Crypto.html#hmac" class="sidebar-link">hmac</a></li><li class="sidebar-sub-header"><a href="/categories/nodejs/_books/node/Inner_Module_Crypto.html#aes" class="sidebar-link">AES</a></li><li class="sidebar-sub-header"><a href="/categories/nodejs/_books/node/Inner_Module_Crypto.html#diffie-hellman" class="sidebar-link">Diffie-Hellman</a></li><li class="sidebar-sub-header"><a href="/categories/nodejs/_books/node/Inner_Module_Crypto.html#证书" class="sidebar-link">证书</a></li></ul></li><li><a href="/categories/nodejs/_books/node/IO.html" class="sidebar-link">IO编程</a></li><li><a href="/categories/nodejs/_books/node/HTTP.html" class="sidebar-link">网络编程</a></li><li><a href="/categories/nodejs/_books/node/Database.html" class="sidebar-link">数据库编程</a></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>参考资料</span> <span class="arrow right"></span></p> <!----></div></li></ul></div></div><div class="page" data-v-38547c78><div class="content__default"><h1 id="内置模块-crypto"><a href="#内置模块-crypto" aria-hidden="true" class="header-anchor">#</a> 内置模块 - crypto</h1> <p>crypto模块的目的是为了提供通用的加密和哈希算法。用纯JavaScript代码实现这些功能不是不可能，但速度会非常慢。Nodejs用C/C++实现这些算法后，通过cypto这个模块暴露为JavaScript接口，这样用起来方便，运行速度也快。</p> <h2 id="md5"><a href="#md5" aria-hidden="true" class="header-anchor">#</a> MD5</h2> <p>MD5是一种常用的哈希算法，用于给任意数据一个“签名”。这个签名通常用一个十六进制的字符串表示：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> hash <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createHash</span><span class="token punctuation">(</span><span class="token string">'md5'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 可任意多次调用update():</span>
hash<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token string">'Hello, world!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hash<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token string">'Hello, nodejs!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>hash<span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 7e1977739c748beac0c0fd14fd26a544</span>
</code></pre></div><p><code>update()</code>方法默认字符串编码为<code>UTF-8</code>，也可以传入Buffer。</p> <p>如果要计算SHA1，只需要把<code>'md5'</code>改成<code>'sha1'</code>，就可以得到SHA1的结果<code>1f32b9c9932c02227819a4151feed43e131aca40</code>。</p> <p>还可以使用更安全的<code>sha256</code>和<code>sha512</code>。</p> <h2 id="hmac"><a href="#hmac" aria-hidden="true" class="header-anchor">#</a> hmac</h2> <p>Hmac算法也是一种哈希算法，它可以利用MD5或SHA1等哈希算法。不同的是，Hmac还需要一个密钥，只要密钥发生了变化，那么同样的输入数据也会得到不同的签名，因此，可以把Hmac理解为用随机数“增强”的哈希算法。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> hmac <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createHmac</span><span class="token punctuation">(</span><span class="token string">'sha256'</span><span class="token punctuation">,</span> <span class="token string">'secret-key'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

hmac<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token string">'Hello, world!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hmac<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token string">'Hello, nodejs!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>hmac<span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 80f7e22570...</span>
</code></pre></div><h2 id="aes"><a href="#aes" aria-hidden="true" class="header-anchor">#</a> AES</h2> <p>AES是一种常用的对称加密算法，加解密都用同一个密钥。crypto模块提供了AES支持，但是需要自己封装好函数，便于使用。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 加密</span>
<span class="token keyword">function</span> <span class="token function">aesEncrypt</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> cipher <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createCipher</span><span class="token punctuation">(</span><span class="token string">'aes192'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> crypted <span class="token operator">=</span> cipher<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">,</span> <span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    crypted <span class="token operator">+=</span> cipher<span class="token punctuation">.</span><span class="token function">final</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> crypted<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 解密</span>
<span class="token keyword">function</span> <span class="token function">aesDecrypt</span><span class="token punctuation">(</span><span class="token parameter">encrypted<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> decipher <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createDecipher</span><span class="token punctuation">(</span><span class="token string">'aes192'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> decrypted <span class="token operator">=</span> decipher<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">,</span> <span class="token string">'hex'</span><span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    decrypted <span class="token operator">+=</span> decipher<span class="token punctuation">.</span><span class="token function">final</span><span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> decrypted<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token string">'Hello, this is a secret message!'</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> key <span class="token operator">=</span> <span class="token string">'Password!'</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> encrypted <span class="token operator">=</span> <span class="token function">aesEncrypt</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> decrypted <span class="token operator">=</span> <span class="token function">aesDecrypt</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Plain text: '</span> <span class="token operator">+</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Encrypted text: '</span> <span class="token operator">+</span> encrypted<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Decrypted text: '</span> <span class="token operator">+</span> decrypted<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>输出</p> <div class="language-js extra-class"><pre class="language-js"><code>Plain text<span class="token punctuation">:</span> Hello<span class="token punctuation">,</span> <span class="token keyword">this</span> is a secret message<span class="token operator">!</span>
Encrypted text<span class="token punctuation">:</span> <span class="token number">8</span>a944d97bdabc157a5b7a40cb180e713f901d2eb454220d6aaa1984831e17231f87799ef334e3825123658c80e0e5d0c
Decrypted text<span class="token punctuation">:</span> Hello<span class="token punctuation">,</span> <span class="token keyword">this</span> is a secret message<span class="token operator">!</span>
</code></pre></div><h2 id="diffie-hellman"><a href="#diffie-hellman" aria-hidden="true" class="header-anchor">#</a> Diffie-Hellman</h2> <p>DH算法是一种密钥交换协议，它可以让双方在不泄漏密钥的情况下协商出一个密钥来。DH算法基于数学原理，比如小明和小红想要协商一个密钥，可以这么做：</p> <ol><li>小明先选一个素数和一个底数，例如，素数<code>p=23</code>，底数<code>g=5</code>（底数可以任选），再选择一个秘密整数<code>a=6</code>，计算<code>A=g^a mod p=8</code>，然后大声告诉小红：<code>p=23，g=5，A=8</code>；</li> <li>小红收到小明发来的<code>p</code>，<code>g</code>，<code>A</code>后，也选一个秘密整数<code>b=15</code>，然后计算<code>B=g^b mod p=19</code>，并大声告诉小明：<code>B=19</code>；</li> <li>小明自己计算出<code>s=B^a mod p=2</code>，小红也自己计算出<code>s=A^b mod p=2</code>，因此，最终协商的密钥<code>s</code>为<code>2</code>。</li></ol> <p>在这个过程中，密钥<code>2</code>并不是小明告诉小红的，也不是小红告诉小明的，而是双方协商计算出来的。第三方只能知道<code>p=23</code>，<code>g=5</code>，<code>A=8</code>，<code>B=19</code>，由于不知道双方选的秘密整数<code>a=6</code>和<code>b=15</code>，因此无法计算出密钥<code>2</code>。</p> <p>用crypto模块实现DH算法如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// xiaoming's keys:</span>
<span class="token keyword">var</span> ming <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createDiffieHellman</span><span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> ming_keys <span class="token operator">=</span> ming<span class="token punctuation">.</span><span class="token function">generateKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> prime <span class="token operator">=</span> ming<span class="token punctuation">.</span><span class="token function">getPrime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> generator <span class="token operator">=</span> ming<span class="token punctuation">.</span><span class="token function">getGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Prime: '</span> <span class="token operator">+</span> prime<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Generator: '</span> <span class="token operator">+</span> generator<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// xiaohong's keys:</span>
<span class="token keyword">var</span> hong <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createDiffieHellman</span><span class="token punctuation">(</span>prime<span class="token punctuation">,</span> generator<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> hong_keys <span class="token operator">=</span> hong<span class="token punctuation">.</span><span class="token function">generateKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// exchange and generate secret:</span>
<span class="token keyword">var</span> ming_secret <span class="token operator">=</span> ming<span class="token punctuation">.</span><span class="token function">computeSecret</span><span class="token punctuation">(</span>hong_keys<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> hong_secret <span class="token operator">=</span> hong<span class="token punctuation">.</span><span class="token function">computeSecret</span><span class="token punctuation">(</span>ming_keys<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// print secret:</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Secret of Xiao Ming: '</span> <span class="token operator">+</span> ming_secret<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Secret of Xiao Hong: '</span> <span class="token operator">+</span> hong_secret<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>注意每次输出都不一样，因为素数的选择是随机的。</p> <h2 id="证书"><a href="#证书" aria-hidden="true" class="header-anchor">#</a> 证书</h2> <p>crypto模块也可以处理数字证书。数字证书通常用在SSL连接，也就是Web的https连接。一般情况下，https连接只需要处理服务器端的单向认证，如无特殊需求（例如自己作为Root给客户发认证证书），建议用反向代理服务器如Nginx等Web服务器去处理证书。</p></div><div class="article-info"><div class="article-title">文档信息</div><p class="article-item">版权声明：著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p><p class="article-item">文章标题：内置模块 - crypto</p><p class="article-item">原文链接：<a href="https://www.xiaoyulive.top/categories/nodejs/_books/node/Inner_Module_Crypto.html">https://www.xiaoyulive.top/categories/nodejs/_books/node/Inner_Module_Crypto.html</a></p><!----></div><!----><div class="content page-nav"><p class="inner"><span class="prev">← <a href="/categories/nodejs/_books/node/Inner_Module_Process.html">全局对象 process</a></span><span class="next"><a href="/categories/nodejs/_books/node/IO.html">IO编程</a>  →</span></p></div></div><div class="footers" data-v-38547c78><p data-v-38547c78><span data-v-38547c78>MIT Licensed | Copyright © 2018-present  滇ICP备16006294号</span></p><p data-v-38547c78><span data-v-38547c78>Design by <a href="/">Quanzaiyu</a> | Power by <a href="https://vuepress.vuejs.org/" target="_blank">VuePress</a> | Hosted by <a href="https://pages.coding.me" target="_blank" style="font-weight: bold">Coding Pages</a></span></p></div></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.6d543b11.js" defer></script><script src="/assets/js/5.9e615a5d.js" defer></script>
  </body>
</html>
