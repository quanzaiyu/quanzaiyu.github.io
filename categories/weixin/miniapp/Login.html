<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>微信小程序登录及授权 | 小昱个人网站</title>
    <meta name="description" content="小昱个人网站">
    <meta http-equiv="Expires" content="Mon,12 May 2050 00:20:00 GMT">
  <link rel="icon" href="/logo.png">
  <link rel="manifest" href="/manifest.json">
  <link rel="stylesheet" href="//at.alicdn.com/t/font_517060_lom78h954w.css">
  <link rel="stylesheet" href="https://img.xiaoyulive.top/css/animate.css">
    
    <link rel="preload" href="/assets/css/0.styles.24fc6e4b.css" as="style"><link rel="preload" href="/assets/js/app.b0c069a3.js" as="script"><link rel="preload" href="/assets/js/5.bf9ad07a.js" as="script"><link rel="preload" href="/assets/js/10.0030d769.js" as="script"><link rel="prefetch" href="/assets/js/1.3da9caaf.js"><link rel="prefetch" href="/assets/js/11.a942ca69.js"><link rel="prefetch" href="/assets/js/12.1e367ada.js"><link rel="prefetch" href="/assets/js/13.930ed366.js"><link rel="prefetch" href="/assets/js/14.527e72dc.js"><link rel="prefetch" href="/assets/js/15.8f9a8a59.js"><link rel="prefetch" href="/assets/js/2.8fe36322.js"><link rel="prefetch" href="/assets/js/6.e84be67d.js"><link rel="prefetch" href="/assets/js/7.df9720f7.js"><link rel="prefetch" href="/assets/js/8.b12e7d24.js"><link rel="prefetch" href="/assets/js/9.908b9ffb.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.50c33dc1.js">
    <link rel="stylesheet" href="/assets/css/0.styles.24fc6e4b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-38547c78><header class="navbar" data-v-38547c78><div class="navbar-content"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/" class="home-link router-link-active"><img src="/logo.png" class="logo"><span class="site-name can-hide">小昱个人网站</span></a><div class="links"><nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">开发者博客</a></div><div class="nav-item"><a href="/articles/" class="nav-link">生活漫谈</a></div><div class="nav-item"><a href="/note/" class="nav-link">阅读札记</a></div><div class="nav-item"><a href="/categories/" class="nav-link router-link-active">学无止境</a></div><div class="nav-item"><a href="/share/" class="nav-link">精品分享</a></div><div class="nav-item"><a href="/favorite/" class="nav-link">收藏夹</a></div><!----></nav><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div></div></div></header><div class="sidebar-mask" data-v-38547c78></div><div class="sidebar" data-v-38547c78><div class="sidebar-container"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">开发者博客</a></div><div class="nav-item"><a href="/articles/" class="nav-link">生活漫谈</a></div><div class="nav-item"><a href="/note/" class="nav-link">阅读札记</a></div><div class="nav-item"><a href="/categories/" class="nav-link router-link-active">学无止境</a></div><div class="nav-item"><a href="/share/" class="nav-link">精品分享</a></div><div class="nav-item"><a href="/favorite/" class="nav-link">收藏夹</a></div><!----></nav><ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>微信小程序登录及授权</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/categories/weixin/miniapp/Login.html#授权登录" class="sidebar-link">授权登录</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/categories/weixin/miniapp/Login.html#获取用户信息" class="sidebar-link">获取用户信息</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/categories/weixin/miniapp/Login.html#获取-openid-和-unionid" class="sidebar-link">获取 openid 和 unionid</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/categories/weixin/miniapp/Login.html#获取授权" class="sidebar-link">获取授权</a><ul class="sidebar-sub-headers"></ul></li></ul></div></li></ul></div></div><div class="page" data-v-38547c78><div class="content default"><h1 id="微信小程序登录及授权"><a href="#微信小程序登录及授权" aria-hidden="true" class="header-anchor">#</a> 微信小程序登录及授权</h1> <h2 id="授权登录"><a href="#授权登录" aria-hidden="true" class="header-anchor">#</a> 授权登录</h2> <p>小程序可以直接登录，获取到code, 再通过后端接口换取用户openid及unionid。</p> <div class="language-js extra-class"><pre class="language-js"><code>wx<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">success</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 使用code换取openid</span>
      wx<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        url<span class="token punctuation">:</span> <span class="token string">'https://test.com/login'</span><span class="token punctuation">,</span>
        data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          code<span class="token punctuation">:</span> res<span class="token punctuation">.</span>code
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'登录失败！'</span> <span class="token operator">+</span> res<span class="token punctuation">.</span>errMsg<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="获取用户信息"><a href="#获取用户信息" aria-hidden="true" class="header-anchor">#</a> 获取用户信息</h2> <p>使用 <code>wx.getUserInfo</code> 可获取用户信息：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 必须是在用户已经授权的情况下调用</span>
wx<span class="token punctuation">.</span><span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function-variable function">success</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> userInfo <span class="token operator">=</span> res<span class="token punctuation">.</span>userInfo
    <span class="token keyword">var</span> nickName <span class="token operator">=</span> userInfo<span class="token punctuation">.</span>nickName
    <span class="token keyword">var</span> avatarUrl <span class="token operator">=</span> userInfo<span class="token punctuation">.</span>avatarUrl
    <span class="token keyword">var</span> gender <span class="token operator">=</span> userInfo<span class="token punctuation">.</span>gender <span class="token comment">//性别 0：未知、1：男、2：女</span>
    <span class="token keyword">var</span> province <span class="token operator">=</span> userInfo<span class="token punctuation">.</span>province
    <span class="token keyword">var</span> city <span class="token operator">=</span> userInfo<span class="token punctuation">.</span>city
    <span class="token keyword">var</span> country <span class="token operator">=</span> userInfo<span class="token punctuation">.</span>country
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>返回的数据包括：</p> <ul><li><strong>userInfo</strong> <span class="badge tip middle" data-v-26c46ba7>UserInfo</span> 用户信息对象，不包含 openid 等敏感信息</li> <li><strong>rawData</strong> <span class="badge tip middle" data-v-26c46ba7>string</span> 不包括敏感信息的原始数据字符串，用于计算签名</li> <li><strong>signature</strong> <span class="badge tip middle" data-v-26c46ba7>string</span> 使用 sha1( rawData + sessionkey ) 得到字符串，用于校验用户信息，详见 用户数据的签名验证和加解密</li> <li><strong>encryptedData</strong> <span class="badge tip middle" data-v-26c46ba7>string</span> 包括敏感数据在内的完整用户信息的加密数据，详见 用户数据的签名验证和加解密</li> <li><strong>iv</strong> <span class="badge tip middle" data-v-26c46ba7>string</span> 加密算法的初始向量，详见 用户数据的签名验证和加解密</li></ul> <p>其中 userInfo 包括以下信息：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  avatarUrl<span class="token punctuation">:</span> <span class="token string">&quot;AVATARURL&quot;</span><span class="token punctuation">,</span>
  city<span class="token punctuation">:</span> <span class="token string">&quot;CITY&quot;</span><span class="token punctuation">,</span>
  country<span class="token punctuation">:</span> <span class="token string">&quot;COUNTRY&quot;</span><span class="token punctuation">,</span>
  gender<span class="token punctuation">:</span> <span class="token constant">GENDER</span><span class="token punctuation">,</span> <span class="token comment">// 1 男 2 女</span>
  language<span class="token punctuation">:</span> <span class="token string">&quot;LANGUAGE&quot;</span><span class="token punctuation">,</span>
  nickName<span class="token punctuation">:</span> <span class="token string">&quot;NICKNAME&quot;</span><span class="token punctuation">,</span>
  province<span class="token punctuation">:</span> <span class="token string">&quot;PROVINCE&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其中 encryptedData 解密后包括以下信息：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;openId&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;OPENID&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;nickName&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;NICKNAME&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;gender&quot;</span><span class="token punctuation">:</span> <span class="token constant">GENDER</span><span class="token punctuation">,</span>
  <span class="token string">&quot;city&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;CITY&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;province&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;PROVINCE&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;country&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;COUNTRY&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;avatarUrl&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;AVATARURL&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;unionId&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;UNIONID&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;watermark&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;appid&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;APPID&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;timestamp&quot;</span><span class="token punctuation">:</span> <span class="token constant">TIMESTAMP</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>参考：</p> <ul><li><a href="https://developers.weixin.qq.com/miniprogram/dev/api/open-api/user-info/wx.getUserInfo.html" target="_blank" rel="noopener noreferrer">wx.getUserInfo<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/signature.html#%E5%8A%A0%E5%AF%86%E6%95%B0%E6%8D%AE%E8%A7%A3%E5%AF%86%E7%AE%97%E6%B3%95" target="_blank" rel="noopener noreferrer">加密数据解密算法<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <p>以前第一次进入小程序，使用 <code>wx.getUserInfo</code> 可以直接跳出用户登录弹框，最近微信对其核心API进行了修改，不允许自动弹出授权登录框，必须用户点击按钮手动触发。</p> <p>如果第一次用户已经同意获取用户信息，则之后进入小程序 <code>wx.getUserInfo</code> 都会默认成功获取用户信息。如果第一次直接使用此接口或者之前没有同意，则默认返回失败。</p> <p>详见文章：<a href="https://developers.weixin.qq.com/community/develop/doc/0000a26e1aca6012e896a517556c01" target="_blank" rel="noopener noreferrer">小程序与小游戏获取用户信息接口调整，请开发者注意升级。<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><strong>解决方案1</strong></p> <p>使用 button 组件，并将 open-type 指定为 getUserInfo 类型，获取用户基本信息。</p> <div class="language-pug extra-class"><pre class="language-pug"><code><span class="token tag">button<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">open-type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;getUserInfo&quot;</span> lang<span class="token operator">=</span><span class="token string">&quot;zh_CN&quot;</span> bindgetuserinfo<span class="token operator">=</span><span class="token string">&quot;onGotUserInfo&quot;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">获取用户信息</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token function">onGotUserInfo</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在 button 中使用 bindgetuserinfo，以绑定用户信息，用户必须手动点击才能触发。</p> <p>详见文章：<a href="https://developers.weixin.qq.com/miniprogram/dev/component/button.html" target="_blank" rel="noopener noreferrer">button<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><strong>解决方案2</strong></p> <p>如果只是展示用户头像昵称，可以使用 open-data 组件，直接获取到用户基本信息。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>open-data</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>groupName<span class="token punctuation">&quot;</span></span> <span class="token attr-name">open-gid</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>xxxxxx<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>open-data</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>open-data</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>userAvatarUrl<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>open-data</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>open-data</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>userNickName<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>open-data</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>open-data</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>userCity<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>open-data</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>open-data</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>userProvince<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>open-data</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>open-data</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>userCountry<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>open-data</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>open-data</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>userLanguage<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>open-data</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="tip custom-block"><p class="custom-block-title">提示</p> <p>type=&quot;groupName&quot;时，open-gid 指定群id，用只有当前用户在此群内才能拉取到群名称。</p> <p>详见文章：<a href="https://developers.weixin.qq.com/miniprogram/dev/api/share/wx.getShareInfo.html" target="_blank" rel="noopener noreferrer">wx.getShareInfo<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <h2 id="获取-openid-和-unionid"><a href="#获取-openid-和-unionid" aria-hidden="true" class="header-anchor">#</a> 获取 openid 和 unionid</h2> <p><strong>方式一</strong></p> <p>使用 code2Session 接口可以获取 openid 和 unionid</p> <p>请求地址：</p> <div class="language- extra-class"><pre class="language-text"><code>GET https://api.weixin.qq.com/sns/jscode2session?appid=APPID&amp;secret=SECRET&amp;js_code=JSCODE&amp;grant_type=authorization_code
</code></pre></div><p>其中 js_code 就是 wx.login 登录后拿到的 code。</p> <p>成功获取数据的返回：</p> <ul><li><strong>openid</strong> <span class="badge tip middle" data-v-26c46ba7>string</span> 用户唯一标识</li> <li><strong>session_key</strong> <span class="badge tip middle" data-v-26c46ba7>string</span> 会话密钥</li> <li><strong>unionid</strong> <span class="badge tip middle" data-v-26c46ba7>string</span> 用户在开放平台的唯一标识符，在满足 UnionID 下发条件的情况下会返回</li></ul> <p>失败的返回：</p> <ul><li><strong>errcode</strong> <span class="badge tip middle" data-v-26c46ba7>number</span> 错误码</li> <li><strong>errMsg</strong> <span class="badge tip middle" data-v-26c46ba7>string</span> 错误信息</li></ul> <p><strong>方式二</strong></p> <p>获取用户信息接口（getUserInfo）拿到的 encryptedData 字段，通过解密获取 openid 和 unionid</p> <p>参考：</p> <ul><li><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/union-id.html" target="_blank" rel="noopener noreferrer">UnionID 机制说明<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/code2Session.html" target="_blank" rel="noopener noreferrer">code2Session<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h2 id="获取授权"><a href="#获取授权" aria-hidden="true" class="header-anchor">#</a> 获取授权</h2> <p>开发者可以使用 <code>wx.getSetting</code> 获取用户当前的授权状态。</p> <div class="language-js extra-class"><pre class="language-js"><code>wx<span class="token punctuation">.</span><span class="token function">getSetting</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">success</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>authSetting<span class="token punctuation">)</span>
    <span class="token comment">// res.authSetting = {</span>
    <span class="token comment">//   &quot;scope.userInfo&quot;: true,</span>
    <span class="token comment">//   &quot;scope.userLocation&quot;: true</span>
    <span class="token comment">// }</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>使用 <code>wx.authorize</code> 提前向用户发起授权请求。调用后会立刻弹窗询问用户是否同意授权小程序使用某项功能或获取用户的某些数据，但不会实际调用对应接口。如果用户之前已经同意授权，则不会出现弹窗，直接返回成功。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 可以通过 wx.getSetting 先查询一下用户是否授权了 &quot;scope.record&quot; 这个 scope</span>
wx<span class="token punctuation">.</span><span class="token function">getSetting</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">success</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">.</span>authSetting<span class="token punctuation">[</span><span class="token string">'scope.record'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      wx<span class="token punctuation">.</span><span class="token function">authorize</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        scope<span class="token punctuation">:</span> <span class="token string">'scope.record'</span><span class="token punctuation">,</span>
        <span class="token function">success</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 用户已经同意小程序使用录音功能，后续调用 wx.startRecord 接口不会弹窗询问</span>
          wx<span class="token punctuation">.</span><span class="token function">startRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>参考:</p> <ul><li><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/authorize.html" target="_blank" rel="noopener noreferrer">授权<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://developers.weixin.qq.com/miniprogram/dev/api/open-api/setting/wx.getSetting.html" target="_blank" rel="noopener noreferrer">wx.getSetting<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://developers.weixin.qq.com/miniprogram/dev/api/open-api/authorize/wx.authorize.html" target="_blank" rel="noopener noreferrer">wx.authorize<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><div class="article-info"><div class="article-title">文档信息</div><p class="article-item">版权声明：著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p><p class="article-item">文章标题：微信小程序登录及授权</p><p class="article-item">原文链接：<a href="https://www.xiaoyulive.top/categories/weixin/miniapp/Login.html">https://www.xiaoyulive.top/categories/weixin/miniapp/Login.html</a></p><p class="article-item">发表日期：2019-04-22</p></div><!----><!----></div><div class="footers" data-v-38547c78><p data-v-38547c78><span data-v-38547c78>MIT Licensed | Copyright © 2018-present  滇ICP备16006294号</span></p><p data-v-38547c78><span data-v-38547c78>Design by <a href="/">Quanzaiyu</a> | Power by <a href="https://vuepress.vuejs.org/" target="_blank">VuePress</a> | Hosted by <a href="https://pages.coding.me" target="_blank" style="font-weight: bold">Coding Pages</a></span></p></div></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.b0c069a3.js" defer></script><script src="/assets/js/5.bf9ad07a.js" defer></script><script src="/assets/js/10.0030d769.js" defer></script>
  </body>
</html>
