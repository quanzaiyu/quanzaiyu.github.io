<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>深入探索 XMLHttpRequest2 | 小昱个人网站</title>
    <meta name="description" content="小昱个人网站">
    <meta http-equiv="Expires" content="Mon,12 May 2050 00:20:00 GMT">
  <link rel="icon" href="/logo.png">
  <link rel="manifest" href="/manifest.json">
  <link rel="stylesheet" href="//at.alicdn.com/t/font_517060_lom78h954w.css">
  <link rel="stylesheet" href="https://img.xiaoyulive.top/css/animate.css">
    
    <link rel="preload" href="/assets/css/0.styles.24fc6e4b.css" as="style"><link rel="preload" href="/assets/js/app.c6175002.js" as="script"><link rel="preload" href="/assets/js/5.8474f2bf.js" as="script"><link rel="preload" href="/assets/js/14.1dd8ad75.js" as="script"><link rel="prefetch" href="/assets/js/1.5073f6ca.js"><link rel="prefetch" href="/assets/js/10.44f88964.js"><link rel="prefetch" href="/assets/js/11.7c5c22fe.js"><link rel="prefetch" href="/assets/js/12.a3cf7fca.js"><link rel="prefetch" href="/assets/js/13.41373e59.js"><link rel="prefetch" href="/assets/js/15.0bb48379.js"><link rel="prefetch" href="/assets/js/2.26128e82.js"><link rel="prefetch" href="/assets/js/6.b18bc722.js"><link rel="prefetch" href="/assets/js/7.bec27a74.js"><link rel="prefetch" href="/assets/js/8.de03dbe8.js"><link rel="prefetch" href="/assets/js/9.7e72cc63.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.396ee2e3.js">
    <link rel="stylesheet" href="/assets/css/0.styles.24fc6e4b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-38547c78><header class="navbar" data-v-38547c78><div class="navbar-content"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/" class="home-link router-link-active"><img src="/logo.png" class="logo"><span class="site-name can-hide">小昱个人网站</span></a><div class="links"><nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">开发者博客</a></div><div class="nav-item"><a href="/articles/" class="nav-link">生活漫谈</a></div><div class="nav-item"><a href="/note/" class="nav-link">阅读札记</a></div><div class="nav-item"><a href="/categories/" class="nav-link router-link-active">学无止境</a></div><div class="nav-item"><a href="/share/" class="nav-link">精品分享</a></div><div class="nav-item"><a href="/favorite/" class="nav-link">收藏夹</a></div><!----></nav><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div></div></div></header><div class="sidebar-mask" data-v-38547c78></div><div class="sidebar" data-v-38547c78><div class="sidebar-container"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">开发者博客</a></div><div class="nav-item"><a href="/articles/" class="nav-link">生活漫谈</a></div><div class="nav-item"><a href="/note/" class="nav-link">阅读札记</a></div><div class="nav-item"><a href="/categories/" class="nav-link router-link-active">学无止境</a></div><div class="nav-item"><a href="/share/" class="nav-link">精品分享</a></div><div class="nav-item"><a href="/favorite/" class="nav-link">收藏夹</a></div><!----></nav><ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>深入探索 XMLHttpRequest2</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/categories/front-end/js/_pages/XMLHttpRequest2.html#前言" class="sidebar-link">前言</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/categories/front-end/js/_pages/XMLHttpRequest2.html#老版本的使用" class="sidebar-link">老版本的使用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/categories/front-end/js/_pages/XMLHttpRequest2.html#请求一段文本内容" class="sidebar-link">请求一段文本内容</a></li><li class="sidebar-sub-header"><a href="/categories/front-end/js/_pages/XMLHttpRequest2.html#请求json格式的数据" class="sidebar-link">请求JSON格式的数据</a></li><li class="sidebar-sub-header"><a href="/categories/front-end/js/_pages/XMLHttpRequest2.html#针对数据乱码的处理" class="sidebar-link">针对数据乱码的处理</a></li><li class="sidebar-sub-header"><a href="/categories/front-end/js/_pages/XMLHttpRequest2.html#老版本的缺点" class="sidebar-link">老版本的缺点</a></li></ul></li><li><a href="/categories/front-end/js/_pages/XMLHttpRequest2.html#新版本的功能" class="sidebar-link">新版本的功能</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/categories/front-end/js/_pages/XMLHttpRequest2.html#设置请求头" class="sidebar-link">设置请求头</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/categories/front-end/js/_pages/XMLHttpRequest2.html#请求类型" class="sidebar-link">请求类型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/categories/front-end/js/_pages/XMLHttpRequest2.html#domstring-text-plain" class="sidebar-link">DOMString(text/plain)</a></li><li class="sidebar-sub-header"><a href="/categories/front-end/js/_pages/XMLHttpRequest2.html#json-application-json" class="sidebar-link">JSON(application/json)</a></li><li class="sidebar-sub-header"><a href="/categories/front-end/js/_pages/XMLHttpRequest2.html#formdata" class="sidebar-link">FormData</a></li><li class="sidebar-sub-header"><a href="/categories/front-end/js/_pages/XMLHttpRequest2.html#上传文件" class="sidebar-link">上传文件</a></li></ul></li><li><a href="/categories/front-end/js/_pages/XMLHttpRequest2.html#事件响应" class="sidebar-link">事件响应</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/categories/front-end/js/_pages/XMLHttpRequest2.html#事件触发的时机" class="sidebar-link">事件触发的时机</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/categories/front-end/js/_pages/XMLHttpRequest2.html#onload" class="sidebar-link">onload</a></li><li class="sidebar-sub-header"><a href="/categories/front-end/js/_pages/XMLHttpRequest2.html#ontimeout" class="sidebar-link">ontimeout</a></li><li class="sidebar-sub-header"><a href="/categories/front-end/js/_pages/XMLHttpRequest2.html#event对象" class="sidebar-link">event对象</a></li><li class="sidebar-sub-header"><a href="/categories/front-end/js/_pages/XMLHttpRequest2.html#进度信息" class="sidebar-link">进度信息</a></li><li class="sidebar-sub-header"><a href="/categories/front-end/js/_pages/XMLHttpRequest2.html#readystate" class="sidebar-link">readyState</a></li><li class="sidebar-sub-header"><a href="/categories/front-end/js/_pages/XMLHttpRequest2.html#http状态信息" class="sidebar-link">HTTP状态信息</a></li></ul></li><li><a href="/categories/front-end/js/_pages/XMLHttpRequest2.html#获取响应头" class="sidebar-link">获取响应头</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/categories/front-end/js/_pages/XMLHttpRequest2.html#响应类型" class="sidebar-link">响应类型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/categories/front-end/js/_pages/XMLHttpRequest2.html#blob" class="sidebar-link">Blob</a></li><li class="sidebar-sub-header"><a href="/categories/front-end/js/_pages/XMLHttpRequest2.html#arraybuffer" class="sidebar-link">ArrayBuffer</a></li><li class="sidebar-sub-header"><a href="/categories/front-end/js/_pages/XMLHttpRequest2.html#document" class="sidebar-link">Document</a></li></ul></li><li><a href="/categories/front-end/js/_pages/XMLHttpRequest2.html#cors跨域请求" class="sidebar-link">CORS跨域请求</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/categories/front-end/js/_pages/XMLHttpRequest2.html#在php中设置" class="sidebar-link">在PHP中设置</a></li><li class="sidebar-sub-header"><a href="/categories/front-end/js/_pages/XMLHttpRequest2.html#在apache中设置" class="sidebar-link">在Apache中设置</a></li><li class="sidebar-sub-header"><a href="/categories/front-end/js/_pages/XMLHttpRequest2.html#在nginx中设置" class="sidebar-link">在Nginx中设置</a></li></ul></li><li><a href="/categories/front-end/js/_pages/XMLHttpRequest2.html#参考资料" class="sidebar-link">参考资料</a><ul class="sidebar-sub-headers"></ul></li></ul></div></li></ul></div></div><div class="page" data-v-38547c78><div class="content default"><h1 id="深入探索-xmlhttprequest2"><a href="#深入探索-xmlhttprequest2" aria-hidden="true" class="header-anchor">#</a> 深入探索 XMLHttpRequest2</h1> <h2 id="前言"><a href="#前言" aria-hidden="true" class="header-anchor">#</a> 前言</h2> <p>web2.0出现很多年了，<code>XMLHttpRequest</code>也由此诞生，一代的<code>XMLHttpRequest</code>使用至今出现了诸多不足。作为其升级版的二代 <code>XMLHttpRequest</code> 引入了大量的新功能（例如跨源请求、上传进度事件以及对上传/下载二进制数据的支持等），而且 <code>AJAX</code> 可以与很多尖端的 <code>HTML5 API</code> 一起使用。</p> <h2 id="老版本的使用"><a href="#老版本的使用" aria-hidden="true" class="header-anchor">#</a> 老版本的使用</h2> <p>在介绍新版本之前，我们先回顾一下老版本的用法。</p> <p>首先，新建一个XMLHttpRequest的实例。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>然后，向远程主机发出一个HTTP请求。</p> <div class="language-js extra-class"><pre class="language-js"><code>xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'example.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>接着，就等待远程主机做出回应。这时需要监控XMLHttpRequest对象的状态变化，指定回调函数。</p> <div class="language-js extra-class"><pre class="language-js"><code>xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> xhr<span class="token punctuation">.</span>readyState <span class="token operator">==</span> <span class="token number">4</span> <span class="token operator">&amp;&amp;</span> xhr<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token number">200</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span> xhr<span class="token punctuation">.</span>responseText <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span> xhr<span class="token punctuation">.</span>statusText <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>上面的代码包含了老版本XMLHttpRequest对象的主要属性：</p> <ul><li><code>xhr.readyState</code> XMLHttpRequest对象的状态，等于4表示数据已经接收完毕。</li> <li><code>xhr.status</code> 服务器返回的状态码，等于200表示一切正常。</li> <li><code>xhr.responseText</code> 服务器返回的文本数据</li> <li><code>xhr.responseXML</code> 服务器返回的XML格式的数据</li> <li><code>xhr.statusText</code> 服务器返回的状态文本。</li></ul> <h3 id="请求一段文本内容"><a href="#请求一段文本内容" aria-hidden="true" class="header-anchor">#</a> 请求一段文本内容</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> xhr<span class="token punctuation">;</span>
<span class="token keyword">var</span> url <span class="token operator">=</span> <span class="token string">'http://localhost/test.txt'</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>XMLHttpRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//  IE7+, Firefox, Chrome, Opera, Safari 浏览器执行代码</span>
  xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">// IE6, IE5 浏览器执行代码</span>
  xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActiveXObject</span><span class="token punctuation">(</span><span class="token string">&quot;Microsoft.XMLHTTP&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span>responseType <span class="token operator">=</span> <span class="token string">'text'</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>xhr<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">===</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//处理数据</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">//其它操作</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="imgLink" data-v-16222526><img src="https://img.xiaoyulive.top/img/articles/0038.png" data-v-16222526></div> <p>请求流程为:</p> <ol><li>判断浏览器是否包含<code>XMLHttpRequest</code>对象，再创建一个浏览器对应的<code>XMLHttpRequest</code>(IE为<code>ActiveXObject</code>)对象</li> <li>使用<code>open</code>方法打开一个链接，指定请求方式和是否异步请求</li> <li>指定<code>responseType</code>返回数据类型为<code>text</code>，不指定则默认为<code>empty string</code></li> <li>使用<code>send</code>发送请求</li> <li>监听<code>onreadystatechange</code>事件，判断其<code>readyState</code>是否为4且<code>status</code>是否为200，如果是则代表请求成功</li> <li>使用<code>responseText</code>返回请求的数据</li></ol> <h3 id="请求json格式的数据"><a href="#请求json格式的数据" aria-hidden="true" class="header-anchor">#</a> 请求JSON格式的数据</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> url <span class="token operator">=</span> <span class="token string">'http://localhost/test.json'</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span>responseType <span class="token operator">=</span> <span class="token string">'json'</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>xhr<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">===</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>response<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="imgLink" data-v-16222526><img src="https://img.xiaoyulive.top/img/articles/0045.png" data-v-16222526></div> <p>请求<code>JSON</code>数据，返回的<code>response</code>就为此<code>JSON</code>的内容。</p> <h3 id="针对数据乱码的处理"><a href="#针对数据乱码的处理" aria-hidden="true" class="header-anchor">#</a> 针对数据乱码的处理</h3> <p>在请求头中添加设置编码的方法，如</p> <div class="language-js extra-class"><pre class="language-js"><code>xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Type&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;charset=gb2312&quot;</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="老版本的缺点"><a href="#老版本的缺点" aria-hidden="true" class="header-anchor">#</a> 老版本的缺点</h3> <p>老版本的XMLHttpRequest对象有以下几个缺点：</p> <ul><li>只支持文本数据的传送，无法用来读取和上传二进制文件。</li> <li>传送和接收数据时，没有进度信息，只能提示有没有完成。</li> <li>受到&quot;同域限制&quot;（Same Origin Policy），只能向同一域名的服务器请求数据。</li></ul> <h2 id="新版本的功能"><a href="#新版本的功能" aria-hidden="true" class="header-anchor">#</a> 新版本的功能</h2> <p>新版本的XMLHttpRequest对象，针对老版本的缺点，做出了大幅改进。</p> <ul><li>可以设置HTTP请求的时限。</li> <li>可以使用FormData对象管理表单数据。</li> <li>可以上传文件。</li> <li>可以请求不同域名下的数据（跨域请求）。</li> <li>可以获取服务器端的二进制数据。</li> <li>可以获得数据传输的进度信息。</li></ul> <h2 id="设置请求头"><a href="#设置请求头" aria-hidden="true" class="header-anchor">#</a> 设置请求头</h2> <p>setRequestHeader方法用于向请求添加HTTP头，其定义如下:</p> <div class="language- extra-class"><pre class="language-text"><code>setRequestHeader(name, value)
</code></pre></div><ul><li>参数name定义HTTP请求头部的名称</li> <li>参数value定义HTTP请求头部的值</li></ul> <p>比如:</p> <div class="language-js extra-class"><pre class="language-js"><code>xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Type&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;application/x-www-form-urlencoded; charset=gb2312&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>注意:</p> <ol><li>setRequestHeader方法必须在open方法调用之后、send方法之前调用，否则会出现异常</li> <li>setRequestHeader方法可以连续调用多次，如果已经存在同名的HTTP头时，最终结果是追加而不是覆盖</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//例子1</span>
xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">'X-Test'</span><span class="token punctuation">,</span> <span class="token string">'one'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">'X-Test'</span><span class="token punctuation">,</span> <span class="token string">'two'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//最后的结果为X-Test: one, two</span>

<span class="token comment">//例子2</span>
xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">'X-Test'</span><span class="token punctuation">,</span> <span class="token string">'one'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">'X-Test'</span><span class="token punctuation">,</span> <span class="token string">'one'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//最后的结果为X-Test: one, one</span>
</code></pre></div><h2 id="请求类型"><a href="#请求类型" aria-hidden="true" class="header-anchor">#</a> 请求类型</h2> <h3 id="domstring-text-plain"><a href="#domstring-text-plain" aria-hidden="true" class="header-anchor">#</a> DOMString(text/plain)</h3> <p>发送一段普通的字符串。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> url <span class="token operator">=</span> <span class="token string">'http://localhost/getInfo.php'</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'POST'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span>responseType <span class="token operator">=</span> <span class="token string">'json'</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Hello Ajax'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="imgLink" data-v-16222526><img src="https://img.xiaoyulive.top/img/articles/0051.png" data-v-16222526></div> <h3 id="json-application-json"><a href="#json-application-json" aria-hidden="true" class="header-anchor">#</a> JSON(application/json)</h3> <p>发送一段json数据，注意发送之前需要使用<code>JSON.stringify()</code>将<code>json</code>字符串化。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> url <span class="token operator">=</span> <span class="token string">'http://localhost/getInfo.php'</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> json <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token punctuation">:</span> <span class="token string">'xiaoyu'</span><span class="token punctuation">,</span>
  age<span class="token punctuation">:</span> <span class="token number">18</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'POST'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span>responseType <span class="token operator">=</span> <span class="token string">'json'</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="imgLink" data-v-16222526><img src="https://img.xiaoyulive.top/img/articles/0047.png" data-v-16222526></div> <h3 id="formdata"><a href="#formdata" aria-hidden="true" class="header-anchor">#</a> FormData</h3> <p>XMLHttpRequest2添加了一个新的接口<code>FormData</code>。利用<code>FormData</code>对象，我们可以通过JavaScript用一些键值对来模拟一系列表单控件，我们还可以使用XMLHttpRequest的<code>send()</code>方法来异步的提交这个”表单”。比起普通的ajax, 使用<code>FormData</code>的最大优点就是我们可以异步上传一个二进制文件。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> url <span class="token operator">=</span> <span class="token string">'http://localhost/getInfo.php'</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> formData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">'xiaoyu'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 注意，传递的时候会作为字符串处理</span>

<span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'POST'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span>responseType <span class="token operator">=</span> <span class="token string">'json'</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>formData<span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="imgLink" data-v-16222526><img src="https://img.xiaoyulive.top/img/articles/0048.png" data-v-16222526></div> <h3 id="上传文件"><a href="#上传文件" aria-hidden="true" class="header-anchor">#</a> 上传文件</h3> <p>新版XMLHttpRequest对象，不仅可以发送文本信息，还可以上传文件。</p> <p>假定files是一个&quot;选择文件&quot;的表单元素（input[type=&quot;file&quot;]），我们将它装入FormData对象。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> formData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> files<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'files[]'</span><span class="token punctuation">,</span> files<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后，发送这个FormData对象。</p> <div class="language-js extra-class"><pre class="language-js"><code>xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>formData<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="事件响应"><a href="#事件响应" aria-hidden="true" class="header-anchor">#</a> 事件响应</h2> <p>接口定义语言描述了跟XHR相关的事件接口定义:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">interface</span> <span class="token class-name">XMLHttpRequestEventTarget</span> <span class="token punctuation">:</span> EventTarget <span class="token punctuation">{</span>
  <span class="token comment">// event handlers</span>
  attribute EventHandler onloadstart<span class="token punctuation">;</span>
  attribute EventHandler onprogress<span class="token punctuation">;</span>
  attribute EventHandler onabort<span class="token punctuation">;</span>
  attribute EventHandler onerror<span class="token punctuation">;</span>
  attribute EventHandler onload<span class="token punctuation">;</span>
  attribute EventHandler ontimeout<span class="token punctuation">;</span>
  attribute EventHandler onloadend<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">interface</span> <span class="token class-name">XMLHttpRequestUpload</span> <span class="token punctuation">:</span> XMLHttpRequestEventTarget <span class="token punctuation">{</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">interface</span> <span class="token class-name">XMLHttpRequest</span> <span class="token punctuation">:</span> XMLHttpRequestEventTarget <span class="token punctuation">{</span>
  <span class="token comment">// event handler</span>
  attribute EventHandler onreadystatechange<span class="token punctuation">;</span>
  <span class="token comment">// states</span>
  <span class="token comment">//XHR的状态定义</span>
  <span class="token keyword">const</span> unsigned short <span class="token constant">UNSENT</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> unsigned short <span class="token constant">OPENED</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> unsigned short <span class="token constant">HEADERS_RECEIVED</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> unsigned short <span class="token constant">LOADING</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> unsigned short <span class="token constant">DONE</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
  <span class="token comment">//用于描述XHR的状态</span>
  <span class="token keyword">readonly</span> attribute unsigned short readyState<span class="token punctuation">;</span>
  <span class="token comment">// request</span>
  <span class="token punctuation">[</span>SameObject<span class="token punctuation">]</span> <span class="token keyword">readonly</span> attribute XMLHttpRequestUpload upload<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="事件触发的时机"><a href="#事件触发的时机" aria-hidden="true" class="header-anchor">#</a> 事件触发的时机</h2> <p>upload的回调方法会在数据上传的过程中触发，XHR的回调方法大多在响应数据下载的过程中触发，具体的触发时机见下表：</p> <table><thead><tr><th>事件</th> <th>触发时机</th></tr></thead> <tbody><tr><td>onreadystatechange</td> <td>当readyState的值改变时触发，除了当它从非0变成0时</td></tr> <tr><td>onloadstart</td> <td>当调用send方法时会触发 <code>xhr.onloadstart</code>,然后会触发 <code>xhr.upload.onloadstart</code>，代表开始上传数据</td></tr> <tr><td>onprogress</td> <td>上传数据过程中会触发 <code>xhr.upload.onprogress</code>，下载数据过程中会触发 <code>xhr.onprogress</code>，onprogress每50ms会触发一次</td></tr> <tr><td>onabort</td> <td>调用abort方法后会触发</td></tr> <tr><td>onerror</td> <td>当发生网络异常的时候会触发，如果上传数据的过程还未结束，此时会先触发 <code>xhr.upload.onerror</code>，然后再触发 <code>xhr.onerror</code>；如果上传数据的过程已经结束，此时只会触发 <code>xhr.onerror</code></td></tr> <tr><td>onload</td> <td>上传数据成功，会触发 <code>xhr.upload.onload</code>；下载数据成功会触发 <code>xhr.onload</code></td></tr> <tr><td>ontimeout</td> <td>当服务端响应的时间超过指定的timeout时间时，会触发此事件</td></tr> <tr><td>onloadend</td> <td>上传数据完成（成功或者失败）时会触发 <code>xhr.upload.onloadend</code>；下载数据完成（成功或失败）会触发 <code>xhr.onloadend</code></td></tr></tbody></table> <h3 id="onload"><a href="#onload" aria-hidden="true" class="header-anchor">#</a> onload</h3> <p>onload会在数据上传成功后调用</p> <div class="language-js extra-class"><pre class="language-js"><code>xhr<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//处理数据</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">//其它操作</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="ontimeout"><a href="#ontimeout" aria-hidden="true" class="header-anchor">#</a> ontimeout</h3> <p><code>xhr.timeout</code> 属性用于设置HTTP请求的超时时间，单位毫秒。</p> <p>当发生超时时，会触发 <code>ontimeout</code> 事件。</p> <h3 id="event对象"><a href="#event对象" aria-hidden="true" class="header-anchor">#</a> event对象</h3> <p>同普通的交互事件一样，<code>xhr</code>的事件中也包含一个<code>event</code>对象:</p> <div class="language-js extra-class"><pre class="language-js"><code>xhr<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="imgLink" data-v-16222526><img src="https://img.xiaoyulive.top/img/articles/0046.png" data-v-16222526></div> <p>可以看到此对象中也包含响应的数据，不过一般都不会使用<code>event</code>去获取数据。</p> <h3 id="进度信息"><a href="#进度信息" aria-hidden="true" class="header-anchor">#</a> 进度信息</h3> <p>新版本的XMLHttpRequest对象，传送数据的时候，有一个progress事件，用来返回进度信息。</p> <p>它分成上传和下载两种情况。下载的progress事件属于XMLHttpRequest对象，上传的progress事件属于XMLHttpRequest.upload对象。</p> <p>我们先定义progress事件的回调函数。</p> <div class="language-js extra-class"><pre class="language-js"><code>xhr<span class="token punctuation">.</span>onprogress <span class="token operator">=</span> updateProgress<span class="token punctuation">;</span>

xhr<span class="token punctuation">.</span>upload<span class="token punctuation">.</span>onprogress <span class="token operator">=</span> updateProgress<span class="token punctuation">;</span>
</code></pre></div><p>然后，在回调函数里面，使用这个事件的一些属性。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">updateProgress</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>lengthComputable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> percentComplete <span class="token operator">=</span> event<span class="token punctuation">.</span>loaded <span class="token operator">/</span> event<span class="token punctuation">.</span>total<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面的代码中，event.total是需要传输的总字节，event.loaded是已经传输的字节。如果event.lengthComputable不为真，则event.total等于0。</p> <p>与progress事件相关的，还有其他五个事件，可以分别指定回调函数：</p> <ul><li>load事件：传输成功完成。</li> <li>abort事件：传输被用户取消。</li> <li>error事件：传输中出现错误。</li> <li>loadstart事件：传输开始。</li> <li>loadEnd事件：传输结束，但是不知道成功还是失败。</li></ul> <h3 id="readystate"><a href="#readystate" aria-hidden="true" class="header-anchor">#</a> readyState</h3> <p>当一个XMLHttpRequest初次创建时，这个属性的值是从0开始，知道接收完整的HTTP响应，这个值增加到4。有五种状态：</p> <ul><li>状态<strong>0</strong> (未初始化)： (XMLHttpRequest)对象已经创建或已被abort()方法重置，但还没有调用open()方法；</li> <li>状态<strong>1</strong> (载入)：已经调用open() 方法，但是send()方法未调用，尚未发送请求；</li> <li>状态<strong>2</strong> (载入完成)： send()方法已调用，HTTP请求已发送到web服务器，请求已经发送完成，未接收到响应；</li> <li>状态<strong>3</strong> (交互)：所有响应头部都已经接收到。响应体开始接收但未完成，即可以接收到部分响应数据；</li> <li>状态<strong>4</strong> (完成)：已经接收到了全部数据，并且连接已经关闭。</li></ul> <p><code>onreadystatechange</code>事件可以监测到<code>readyState</code>的状态变化。</p> <h3 id="http状态信息"><a href="#http状态信息" aria-hidden="true" class="header-anchor">#</a> HTTP状态信息</h3> <ul><li>status: 这是HTTP的状态码，比如: 200为成功，404为找不到页面，500为服务器错误。</li> <li>statusText: 表示HTTP响应状态的描述文本，即OK、Not Found等</li></ul> <h2 id="获取响应头"><a href="#获取响应头" aria-hidden="true" class="header-anchor">#</a> 获取响应头</h2> <ul><li><code>xhr.getAllResponseHeaders()</code>可以获取响应头的所有内容</li> <li><code>xhr.getResponseHeader(name)</code>可以获取指定的响应头内容</li></ul> <p>如:</p> <div class="language-js extra-class"><pre class="language-js"><code>xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">===</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span><span class="token function">getAllResponseHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span><span class="token function">getResponseHeader</span><span class="token punctuation">(</span><span class="token string">'date'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>response<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="响应类型"><a href="#响应类型" aria-hidden="true" class="header-anchor">#</a> 响应类型</h2> <p>responseType 有以下几种响应类型</p> <table><thead><tr><th>类型</th> <th>描述</th></tr></thead> <tbody><tr><td>empty string</td> <td>空字符串，这是默认值</td></tr> <tr><td>arraybuffer</td> <td>二进制缓冲数组</td></tr> <tr><td>blob</td> <td>二进制大对象</td></tr> <tr><td>document</td> <td>文档类型</td></tr> <tr><td>json</td> <td>JSON类型</td></tr> <tr><td>text</td> <td>文本类型</td></tr></tbody></table> <p>注意:</p> <ul><li>当<code>responseType</code>为<code>text</code>或者<code>empty string</code>类型时可以使用<code>responseText</code>属性，为其它类型时调用<code>responseText</code>会发生异常；</li> <li>当<code>responseType</code>为<code>document</code>或者<code>empty string</code>类型时可以使用<code>responseXML</code>属性，为其它类型时调用<code>responseXML</code>会发生异常；</li> <li>当<code>responseType</code>不是<code>empty string</code>、<code>text</code>、<code>document</code>类型时，需要转换成具体的类型进行解析。</li></ul> <h3 id="blob"><a href="#blob" aria-hidden="true" class="header-anchor">#</a> Blob</h3> <p>前段时间做项目，需要请求二进制数据，在服务器中存储的是多媒体文件形式。此时需要将<code>responseType</code>指定为<code>blob</code>，才能正确接收。</p> <p>在控制台打印出响应内容:</p> <div class="imgLink" data-v-16222526><img src="https://img.xiaoyulive.top/img/articles/0037.png" data-v-16222526></div> <p>注意到此时<code>xhr</code>没有了<code>responseText</code>属性，而是直接使用<code>response</code>接收，返回的是一个<code>Blob</code>二进制数据。</p> <h4 id="处理图像类型文件"><a href="#处理图像类型文件" aria-hidden="true" class="header-anchor">#</a> 处理图像类型文件</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> url <span class="token operator">=</span> <span class="token string">'http://localhost/test.png'</span><span class="token punctuation">;</span>
window<span class="token punctuation">.</span><span class="token constant">URL</span> <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token constant">URL</span> <span class="token operator">||</span> window<span class="token punctuation">.</span>webkitURL<span class="token punctuation">;</span>

<span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span>responseType <span class="token operator">=</span> <span class="token string">'blob'</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> blob <span class="token operator">=</span> xhr<span class="token punctuation">.</span>response<span class="token punctuation">;</span>
  <span class="token keyword">var</span> img <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  img<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span><span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">revokeObjectURL</span><span class="token punctuation">(</span>img<span class="token punctuation">.</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  img<span class="token punctuation">.</span>src <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span><span class="token punctuation">;</span>
  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/URL/createObjectURL" target="_blank" rel="noopener noreferrer">URL.createObjectURL()<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></strong> 会创建一个 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/DOMString" target="_blank" rel="noopener noreferrer"><code>DOMString</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，其中包含一个表示参数中给出的对象的URL。这个 URL 的生命周期和创建它的窗口中的 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Document" target="_blank" rel="noopener noreferrer"><code>document</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 绑定。这个新的URL 对象表示指定的 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/File" target="_blank" rel="noopener noreferrer"><code>File</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 对象或 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Blob" target="_blank" rel="noopener noreferrer"><code>Blob</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 对象。</p> <p><strong><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/URL/revokeObjectURL" target="_blank" rel="noopener noreferrer">URL.revokeObjectURL()<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></strong> 用来释放一个之前通过调用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/URL/createObjectURL" target="_blank" rel="noopener noreferrer"><code>URL.createObjectURL()</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 创建的已经存在的 URL 对象。当你结束使用某个 URL 对象时，应该通过调用这个方法来让浏览器知道不再需要保持这个文件的引用了。</p> <p>你可以在sourceopen被处理之后的任何时候调用revokeObjectURL()。这是因为createObjectURL()仅仅意味着将一个媒体元素的src属性关联到一个 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/MediaSource" target="_blank" rel="noopener noreferrer"><code>MediaSource</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 对象。调用<code>revokeObjectURL()</code> 使这个潜在的对象保留在原来的地方，允许平台在合适的时机进行垃圾收集。</p> <h4 id="处理音频类型文件"><a href="#处理音频类型文件" aria-hidden="true" class="header-anchor">#</a> 处理音频类型文件</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> url <span class="token operator">=</span> <span class="token string">'http://localhost/audio.mp3'</span><span class="token punctuation">;</span>
window<span class="token punctuation">.</span><span class="token constant">URL</span> <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token constant">URL</span> <span class="token operator">||</span> window<span class="token punctuation">.</span>webkitURL<span class="token punctuation">;</span>

<span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span>responseType <span class="token operator">=</span> <span class="token string">'blob'</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> blob <span class="token operator">=</span> xhr<span class="token punctuation">.</span>response<span class="token punctuation">;</span>
  <span class="token keyword">var</span> audio <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'audio'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  audio<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span><span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">revokeObjectURL</span><span class="token punctuation">(</span>audio<span class="token punctuation">.</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  audio<span class="token punctuation">.</span>src <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span><span class="token punctuation">;</span>
  audio<span class="token punctuation">.</span>controls <span class="token operator">=</span> <span class="token string">'controls'</span><span class="token punctuation">;</span>
  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>audio<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>注意: HTML5直接支持的音频文件类型只有: <code>mp3</code>、<code>ogg</code>、<code>wav</code></p> <h4 id="处理视频类型文件"><a href="#处理视频类型文件" aria-hidden="true" class="header-anchor">#</a> 处理视频类型文件</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> url <span class="token operator">=</span> <span class="token string">'http://localhost/test.mp4'</span><span class="token punctuation">;</span>
window<span class="token punctuation">.</span><span class="token constant">URL</span> <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token constant">URL</span> <span class="token operator">||</span> window<span class="token punctuation">.</span>webkitURL<span class="token punctuation">;</span>

<span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span>responseType <span class="token operator">=</span> <span class="token string">'blob'</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> blob <span class="token operator">=</span> xhr<span class="token punctuation">.</span>response<span class="token punctuation">;</span>
  <span class="token comment">/*
  * let res = 'response' in xhr ? xhr.response : xhr.responseText
  */</span>
  <span class="token keyword">var</span> video <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'video'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  video<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span><span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">revokeObjectURL</span><span class="token punctuation">(</span>video<span class="token punctuation">.</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  video<span class="token punctuation">.</span>src <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span><span class="token punctuation">;</span>
  video<span class="token punctuation">.</span>controls <span class="token operator">=</span> <span class="token string">'controls'</span><span class="token punctuation">;</span>
  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>video<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>注意: HTML5直接支持的视频文件类型只有: <code>MP4</code>、<code>WebM</code>、<code>Ogg</code></p> <h3 id="arraybuffer"><a href="#arraybuffer" aria-hidden="true" class="header-anchor">#</a> ArrayBuffer</h3> <p><a href="https://developer.mozilla.org/en/JavaScript_typed_arrays/ArrayBuffer" target="_blank" rel="noopener noreferrer"><code>ArrayBuffer</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 是二进制数据通用的固定长度容器。如果您需要原始数据的通用缓冲区，ArrayBuffer 就非常好用，但是它真正强大的功能是让您使用 JavaScript 类型数组创建底层数据的“视图”。实际上，可以通过单个<code>ArrayBuffer</code> 来源创建多个视图。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> url <span class="token operator">=</span> <span class="token string">'http://localhost/test.png'</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span>responseType <span class="token operator">=</span> <span class="token string">'arraybuffer'</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> blob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span>xhr<span class="token punctuation">.</span>response<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>type<span class="token punctuation">:</span> <span class="token string">'image/png'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 之后的处理参考 Blob</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="imgLink" data-v-16222526><img src="https://img.xiaoyulive.top/img/articles/0049.png" data-v-16222526></div> <p>将<code>responseType</code>设置为<code>arraybuffer</code>即可返回<code>arraybuffer</code>类型的数据。</p> <p>可以使用<code>Blob</code>构造函数将<code>arraybuffer</code>的数据转化为<code>Blob</code>，注意得加上中括号<code>[]</code>。</p> <p>注意：</p> <p>以前有一个BlobBuilder对象，用于处理将ArrayBuffer转化为Blob格式，不过我测试的时候所有浏览器都报错，查了下MDN发现此对象已经废弃。所以开发的时候最好还是看W3C文档或者MDN，有助于了解API的实时更新。</p> <h4 id="类型化数组"><a href="#类型化数组" aria-hidden="true" class="header-anchor">#</a> 类型化数组</h4> <p>类型化数组(Typed Arrays)是JavaScript中新出现的一个概念，专为访问原始的二进制数据而生。</p> <p>类型数组的类型有：</p> <table><thead><tr><th>名称</th> <th>大小 (以字节为单位)</th> <th>说明</th></tr></thead> <tbody><tr><td><strong>Int8Array</strong></td> <td>1</td> <td>8位有符号整数</td></tr> <tr><td><strong>Uint8Array</strong></td> <td>1</td> <td>8位无符号整数</td></tr> <tr><td><strong>Int16Array</strong></td> <td>2</td> <td>16位有符号整数</td></tr> <tr><td><strong>Uint16Array</strong></td> <td>2</td> <td>16位无符号整数</td></tr> <tr><td><strong>Int32Array</strong></td> <td>4</td> <td>32位有符号整数</td></tr> <tr><td><strong>Uint32Array</strong></td> <td>4</td> <td>32位无符号整数</td></tr> <tr><td><strong>Float32Array</strong></td> <td>4</td> <td>32位浮点数</td></tr> <tr><td><strong>Float64Array</strong></td> <td>8</td> <td>64位浮点数</td></tr></tbody></table> <p>本质上，类型化数组和ArrayBuffer是一样的。不过一个可读写（脱掉buffer限制），一个当数据源的命。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> url <span class="token operator">=</span> <span class="token string">'http://localhost/test.png'</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span>responseType <span class="token operator">=</span> <span class="token string">'arraybuffer'</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>response<span class="token punctuation">)</span>
  <span class="token keyword">var</span> uInt8Array <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>response<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>uInt8Array<span class="token punctuation">)</span>
  <span class="token keyword">var</span> int8Array <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Int8Array</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>response<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>int8Array<span class="token punctuation">)</span>
  <span class="token keyword">var</span> uInt16Array <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint16Array</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>response<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>uInt16Array<span class="token punctuation">)</span>
  <span class="token keyword">var</span> int16Array <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Int16Array</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>response<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>int16Array<span class="token punctuation">)</span>
  <span class="token keyword">var</span> int32Array <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Int32Array</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>response<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>int32Array<span class="token punctuation">)</span>
  <span class="token keyword">var</span> float32Array <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>response<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>float32Array<span class="token punctuation">)</span>
  <span class="token keyword">var</span> float64Array <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float64Array</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>response<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>float64Array<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="imgLink" data-v-16222526><img src="https://img.xiaoyulive.top/img/articles/0050.png" data-v-16222526></div> <h3 id="document"><a href="#document" aria-hidden="true" class="header-anchor">#</a> Document</h3> <p>当请求一段具有格式的<code>html</code>或<code>xml</code>格式的数据时，可以指定<code>responseType</code>为<code>Document</code>，解析为一段文档。如:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> url <span class="token operator">=</span> <span class="token string">'http://localhost/test.html'</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span>responseType <span class="token operator">=</span> <span class="token string">'document'</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>xhr<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">===</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>response<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看到控制台打印:</p> <div class="imgLink" data-v-16222526><img src="https://img.xiaoyulive.top/img/articles/0039.png" data-v-16222526></div> <p>注意到此时<code>xhr</code>多了一个<code>responseXML</code>属性:</p> <div class="imgLink" data-v-16222526><img src="https://img.xiaoyulive.top/img/articles/0040.png" data-v-16222526></div> <p>其中比较有用的属性有:</p> <p><strong>responseXML.all</strong></p> <div class="imgLink" data-v-16222526><img src="https://img.xiaoyulive.top/img/articles/0041.png" data-v-16222526></div> <p><strong>responseXML.doctype</strong></p> <div class="imgLink" data-v-16222526><img src="https://img.xiaoyulive.top/img/articles/0043.png" data-v-16222526></div> <p><strong>responseXML.documentElement</strong></p> <div class="imgLink" data-v-16222526><img src="https://img.xiaoyulive.top/img/articles/0044.png" data-v-16222526></div> <p>其他可能有用的属性</p> <p>返回<code>HTMLCollection</code>类型的属性:</p> <div class="language- extra-class"><pre class="language-text"><code>childNodes、children、images、forms、links、plugins、scripts、embeds
</code></pre></div><p>返回<code>StyleSheetList</code>类型的属性:</p> <div class="language- extra-class"><pre class="language-text"><code>styleSheets
</code></pre></div><p>返回<code>NodeList</code>类型的属性:</p> <div class="language- extra-class"><pre class="language-text"><code>childNodes
</code></pre></div><p>其他属性慢慢探索。</p> <h2 id="cors跨域请求"><a href="#cors跨域请求" aria-hidden="true" class="header-anchor">#</a> CORS跨域请求</h2> <p>以前都是使用<code>jsonp</code>动态生成<code>script</code>标签进行跨域资源获取，而<code>XMLHttpRequest2</code>可以使用<code>CORS</code>(跨域资源共享，Cross-Origin Resource Sharing)实现跨域请求。</p> <p>通常在后端语言(如: PHP)或者是服务器(如: Apache)配置文件中都可以设置<code>CORS</code>。</p> <div class="language- extra-class"><pre class="language-text"><code>Access-Control-Allow-Origin: *
Access-Control-Allow-Methods: POST, GET, OPTIONS
Access-Control-Allow-Headers: X-PINGOTHER, Content-Type
</code></pre></div><h3 id="在php中设置"><a href="#在php中设置" aria-hidden="true" class="header-anchor">#</a> 在PHP中设置</h3> <div class="language-php extra-class"><pre class="language-php"><code><span class="token function">header</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;Access-Control-Allow-Origin:*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="在apache中设置"><a href="#在apache中设置" aria-hidden="true" class="header-anchor">#</a> 在Apache中设置</h3> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Directory</span> <span class="token punctuation">/&gt;</span></span>
	Options FollowSymLinks
	AllowOverride None
	Header set Access-Control-Allow-Origin *
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Directory</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><code>service httpd restart</code>重启服务</p> <h3 id="在nginx中设置"><a href="#在nginx中设置" aria-hidden="true" class="header-anchor">#</a> 在Nginx中设置</h3> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment">#</span>
<span class="token comment"># Wide-open CORS config for nginx</span>
<span class="token comment">#</span>
location / <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$request_method</span> <span class="token operator">=</span> <span class="token string">'OPTIONS'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    add_header <span class="token string">'Access-Control-Allow-Origin'</span> <span class="token string">'*'</span><span class="token punctuation">;</span>
    add_header <span class="token string">'Access-Control-Allow-Methods'</span> <span class="token string">'GET, POST, OPTIONS'</span><span class="token punctuation">;</span>
    <span class="token comment">#</span>
    <span class="token comment"># Custom headers and headers various browsers *should* be OK with but aren't</span>
    <span class="token comment">#</span>
    add_header <span class="token string">'Access-Control-Allow-Headers'</span> <span class="token string">'DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type'</span><span class="token punctuation">;</span>
    <span class="token comment">#</span>
    <span class="token comment"># Tell client that this pre-flight info is valid for 20 days</span>
    <span class="token comment">#</span>
    add_header <span class="token string">'Access-Control-Max-Age'</span> 1728000<span class="token punctuation">;</span>
    add_header <span class="token string">'Content-Type'</span> <span class="token string">'text/plain charset=UTF-8'</span><span class="token punctuation">;</span>
    add_header <span class="token string">'Content-Length'</span> 0<span class="token punctuation">;</span>
    <span class="token keyword">return</span> 204<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$request_method</span> <span class="token operator">=</span> <span class="token string">'POST'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    add_header <span class="token string">'Access-Control-Allow-Origin'</span> <span class="token string">'*'</span><span class="token punctuation">;</span>
    add_header <span class="token string">'Access-Control-Allow-Methods'</span> <span class="token string">'GET, POST, OPTIONS'</span><span class="token punctuation">;</span>
    add_header <span class="token string">'Access-Control-Allow-Headers'</span> <span class="token string">'DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$request_method</span> <span class="token operator">=</span> <span class="token string">'GET'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    add_header <span class="token string">'Access-Control-Allow-Origin'</span> <span class="token string">'*'</span><span class="token punctuation">;</span>
    add_header <span class="token string">'Access-Control-Allow-Methods'</span> <span class="token string">'GET, POST, OPTIONS'</span><span class="token punctuation">;</span>
    add_header <span class="token string">'Access-Control-Allow-Headers'</span> <span class="token string">'DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="参考资料"><a href="#参考资料" aria-hidden="true" class="header-anchor">#</a> 参考资料</h2> <ul><li><a href="http://www.ruanyifeng.com/blog/2012/09/xmlhttprequest_level_2.html" target="_blank" rel="noopener noreferrer">XMLHttpRequest Level 2 使用指南<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://blog.csdn.net/hills/article/details/41246939" target="_blank" rel="noopener noreferrer">XMLHttpRequest2 新技巧<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://blog.csdn.net/huang_cai_yuan/article/details/54881407" target="_blank" rel="noopener noreferrer">史上最全的AJAX之XMLHttpRequest方法和属性详解<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://blog.csdn.net/qq_31915745/article/details/72867784" target="_blank" rel="noopener noreferrer">JSONP跨域请求数据报错 “Unexpected token :”的解决办法<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <p>MDN文档</p> <ul><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS" target="_blank" rel="noopener noreferrer">HTTP访问控制（CORS） - MDN<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/FormData/Using_FormData_Objects" target="_blank" rel="noopener noreferrer">FormData 对象的使用 - MDN<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/URL" target="_blank" rel="noopener noreferrer">window.URL - MDN<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <p>CORS</p> <ul><li><a href="http://www.ruanyifeng.com/blog/2016/04/cors.html" target="_blank" rel="noopener noreferrer">跨域资源共享 CORS 详解 - 阮一峰<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://www.cnblogs.com/sloong/p/cors.html" target="_blank" rel="noopener noreferrer">CORS跨域 实现思路及相关解决方案<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://blog.csdn.net/lzhlzz/article/details/53302863" target="_blank" rel="noopener noreferrer">Apache2 同源策略解决方案 - 配置 CORS<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><div class="article-info"><div class="article-title">文档信息</div><p class="article-item">版权声明：著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p><p class="article-item">文章标题：深入探索 XMLHttpRequest2</p><p class="article-item">原文链接：<a href="https://www.xiaoyulive.top/categories/front-end/js/_pages/XMLHttpRequest2.html">https://www.xiaoyulive.top/categories/front-end/js/_pages/XMLHttpRequest2.html</a></p><p class="article-item">发表日期：2018-09-25</p></div><!----><!----></div><div class="footers" data-v-38547c78><p data-v-38547c78><span data-v-38547c78>MIT Licensed | Copyright © 2018-present  滇ICP备16006294号</span></p><p data-v-38547c78><span data-v-38547c78>Design by <a href="/">Quanzaiyu</a> | Power by <a href="https://vuepress.vuejs.org/" target="_blank">VuePress</a> | Hosted by <a href="https://pages.coding.me" target="_blank" style="font-weight: bold">Coding Pages</a></span></p></div></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.c6175002.js" defer></script><script src="/assets/js/5.8474f2bf.js" defer></script><script src="/assets/js/14.1dd8ad75.js" defer></script>
  </body>
</html>
