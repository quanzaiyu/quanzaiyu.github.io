<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>使用 SSH 私钥登录 Linux 系统 | 小昱个人网站</title>
    <meta name="description" content="小昱个人网站">
    <meta http-equiv="Expires" content="Mon,12 May 2050 00:20:00 GMT">
  <link rel="icon" href="/logo.png">
  <link rel="manifest" href="/manifest.json">
  <link rel="stylesheet" href="//at.alicdn.com/t/font_517060_lom78h954w.css">
  <link rel="stylesheet" href="https://img.xiaoyulive.top/css/animate.css">
    
    <link rel="preload" href="/assets/css/0.styles.a3b4d9d0.css" as="style"><link rel="preload" href="/assets/js/app.7e1a04b4.js" as="script"><link rel="preload" href="/assets/js/5.65637494.js" as="script"><link rel="preload" href="/assets/js/14.b0ee95fc.js" as="script"><link rel="prefetch" href="/assets/js/1.66e518e0.js"><link rel="prefetch" href="/assets/js/10.6e7d06dd.js"><link rel="prefetch" href="/assets/js/11.983ad301.js"><link rel="prefetch" href="/assets/js/12.0fc2584c.js"><link rel="prefetch" href="/assets/js/13.a069f399.js"><link rel="prefetch" href="/assets/js/15.3947c9a6.js"><link rel="prefetch" href="/assets/js/2.0e80cefa.js"><link rel="prefetch" href="/assets/js/6.6cf1fdcf.js"><link rel="prefetch" href="/assets/js/7.5812f34b.js"><link rel="prefetch" href="/assets/js/8.0995b58f.js"><link rel="prefetch" href="/assets/js/9.ffbfa400.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.7bbdb288.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a3b4d9d0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-38547c78><header class="navbar" data-v-38547c78><div class="navbar-content"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/" class="home-link router-link-active"><img src="/logo.png" class="logo"><span class="site-name can-hide">小昱个人网站</span></a><div class="links"><nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">开发者博客</a></div><div class="nav-item"><a href="/articles/" class="nav-link">生活漫谈</a></div><div class="nav-item"><a href="/note/" class="nav-link">阅读札记</a></div><div class="nav-item"><a href="/categories/" class="nav-link router-link-active">学无止境</a></div><div class="nav-item"><a href="/share/" class="nav-link">精品分享</a></div><div class="nav-item"><a href="/favorite/" class="nav-link">收藏夹</a></div><!----></nav><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div></div></div></header><div class="sidebar-mask" data-v-38547c78></div><div class="sidebar" data-v-38547c78><div class="sidebar-container"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">开发者博客</a></div><div class="nav-item"><a href="/articles/" class="nav-link">生活漫谈</a></div><div class="nav-item"><a href="/note/" class="nav-link">阅读札记</a></div><div class="nav-item"><a href="/categories/" class="nav-link router-link-active">学无止境</a></div><div class="nav-item"><a href="/share/" class="nav-link">精品分享</a></div><div class="nav-item"><a href="/favorite/" class="nav-link">收藏夹</a></div><!----></nav><ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>使用 SSH 私钥登录 Linux 系统</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/categories/os/linux/_pages/SSH_Login.html#配置虚拟主机" class="sidebar-link">配置虚拟主机</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/categories/os/linux/_pages/SSH_Login.html#客户端配置" class="sidebar-link">客户端配置</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/categories/os/linux/_pages/SSH_Login.html#服务器端配置" class="sidebar-link">服务器端配置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/categories/os/linux/_pages/SSH_Login.html#使用命令提交" class="sidebar-link">使用命令提交</a></li><li class="sidebar-sub-header"><a href="/categories/os/linux/_pages/SSH_Login.html#手动复制文件内容到-authorized-keys" class="sidebar-link">手动复制文件内容到 authorized_keys</a></li><li class="sidebar-sub-header"><a href="/categories/os/linux/_pages/SSH_Login.html#通过-scp-发送到服务器" class="sidebar-link">通过 scp 发送到服务器</a></li></ul></li><li><a href="/categories/os/linux/_pages/SSH_Login.html#关闭密码验证" class="sidebar-link">关闭密码验证</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/categories/os/linux/_pages/SSH_Login.html#多台主机命名" class="sidebar-link">多台主机命名</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/categories/os/linux/_pages/SSH_Login.html#权限问题" class="sidebar-link">权限问题</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/categories/os/linux/_pages/SSH_Login.html#参考资料" class="sidebar-link">参考资料</a><ul class="sidebar-sub-headers"></ul></li></ul></div></li></ul></div></div><div class="page" data-v-38547c78><div class="content default"><h1 id="使用-ssh-私钥登录-linux-系统"><a href="#使用-ssh-私钥登录-linux-系统" aria-hidden="true" class="header-anchor">#</a> 使用 SSH 私钥登录 Linux 系统</h1> <h2 id="配置虚拟主机"><a href="#配置虚拟主机" aria-hidden="true" class="header-anchor">#</a> 配置虚拟主机</h2> <p>先修改 hosts 文件，位于 <code>/etc/hosts</code>，比如</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">vim</span> /etc/hosts
192.168.0.15 node1
</code></pre></div><p>使用 ssh 连接到指定虚拟主机，如果没有秘钥，则或提示输入密码</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">ssh</span> node1
The authenticity of <span class="token function">host</span> <span class="token string">'node1 (192.168.42.130)'</span> can<span class="token string">'t be established.
ECDSA key fingerprint is SHA256:ahhG7mkVk4N5uuIkeXBHoqM6i5i54DRvAeCCf2RJxcM.
ECDSA key fingerprint is MD5:a5:fc:3f:43:70:ec:03:ca:5b:b1:f3:99:01:b9:8c:86.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '</span>node1,192.168.42.130<span class="token string">' (ECDSA) to the list of known hosts.
root@node1'</span>s password:
Permission denied, please try again.
root@node1<span class="token string">'s password:
Permission denied, please try again.
root@node1'</span>s password:
Permission denied <span class="token punctuation">(</span>publickey,gssapi-keyex,gssapi-with-mic,password<span class="token punctuation">)</span>.
</code></pre></div><h2 id="客户端配置"><a href="#客户端配置" aria-hidden="true" class="header-anchor">#</a> 客户端配置</h2> <p>在客户端使用 <code>ssh-keygen -t rsa</code> 或 <code>ssh-keygen -t rsa -C &quot;你的email地址&quot;</code> ，会在 <code>~/.ssh/id_rsa.pub</code> 生成公钥</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ ssh-keygen
Generating public/private rsa key pair.
Enter <span class="token function">file</span> <span class="token keyword">in</span> <span class="token function">which</span> to save the key <span class="token punctuation">(</span>/root/.ssh/id_rsa<span class="token punctuation">)</span>:
Enter passphrase <span class="token punctuation">(</span>empty <span class="token keyword">for</span> no passphrase<span class="token punctuation">)</span>:
Enter same passphrase again:
Your identification has been saved <span class="token keyword">in</span> /root/.ssh/id_rsa.
Your public key has been saved <span class="token keyword">in</span> /root/.ssh/id_rsa.pub.
The key fingerprint is:
SHA256:oGHYvzpaHaFCSxghVKQ5GR6WbZmzm24jMVSOwfMjSmo root@node1
The key's randomart image is:
+---<span class="token punctuation">[</span>RSA 2048<span class="token punctuation">]</span>----+
<span class="token operator">|</span>**<span class="token operator">=</span>oo            <span class="token operator">|</span>
<span class="token operator">|</span>+B*X             <span class="token operator">|</span>
<span class="token operator">|</span>.*% * o          <span class="token operator">|</span>
<span class="token operator">|</span> B.B <span class="token operator">=</span> o         <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">=</span> + * o S        <span class="token operator">|</span>
<span class="token operator">|</span>oE + <span class="token keyword">.</span> o         <span class="token operator">|</span>
<span class="token operator">|</span><span class="token keyword">.</span> + <span class="token keyword">.</span> o          <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token keyword">.</span> <span class="token operator">=</span><span class="token punctuation">..</span>           <span class="token operator">|</span>
<span class="token operator">|</span>  +.o.           <span class="token operator">|</span>
+----<span class="token punctuation">[</span>SHA256<span class="token punctuation">]</span>-----+
</code></pre></div><h2 id="服务器端配置"><a href="#服务器端配置" aria-hidden="true" class="header-anchor">#</a> 服务器端配置</h2> <p>生成 key 后，可以直接将公钥复制到服务器，也可使用命令提交到服务器</p> <h3 id="使用命令提交"><a href="#使用命令提交" aria-hidden="true" class="header-anchor">#</a> 使用命令提交</h3> <p>使用 <code>ssh-copy-id</code> 命令将生成好的秘钥推给服务器，输入一次密码即可：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ ssh-copy-id node1
/usr/bin/ssh-copy-id: INFO: Source of key<span class="token punctuation">(</span>s<span class="token punctuation">)</span> to be installed: <span class="token string">&quot;/root/.ssh/id_rsa.pub&quot;</span>
/usr/bin/ssh-copy-id: INFO: attempting to log <span class="token keyword">in</span> with the new key<span class="token punctuation">(</span>s<span class="token punctuation">)</span>, to filter out any that are already installed
/usr/bin/ssh-copy-id: INFO: 1 key<span class="token punctuation">(</span>s<span class="token punctuation">)</span> remain to be installed -- <span class="token keyword">if</span> you are prompted now it is to <span class="token function">install</span> the new keys
root@node1<span class="token string">'s password:

Number of key(s) added: 1

Now try logging into the machine, with:   &quot;ssh '</span>node1'&quot;
and check to <span class="token function">make</span> sure that only the key<span class="token punctuation">(</span>s<span class="token punctuation">)</span> you wanted were added.
</code></pre></div><p>再次登录，不需要输入密码：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">ssh</span> node1
Last failed login: Wed Oct 24 21:38:38 CST 2018 from node1 on ssh:notty
There were 5 failed login attempts since the last successful login.
Last login: Wed Oct 24 20:18:50 2018 from 192.168.42.1
<span class="token punctuation">[</span>admin@node1 ~<span class="token punctuation">]</span>$ <span class="token keyword">exit</span>
</code></pre></div><h3 id="手动复制文件内容到-authorized-keys"><a href="#手动复制文件内容到-authorized-keys" aria-hidden="true" class="header-anchor">#</a> 手动复制文件内容到 authorized_keys</h3> <p>在Windows下，没有 <code>ssh-copy-id</code> 命令，则可以使用文件复制的方式提交到服务器。</p> <p>将 <code>id_rsa.pub</code> 文件里面的内容复制，保存到服务器端需要登录的用户根目录下 <code>.ssh/authorized_keys</code> 文件中，比如 <code>/root/.ssh/authorized_keys</code>、<code>/home/user/.ssh/authorized_keys</code> 即可。</p> <p>或者通过FTP等方式将文件弄到服务器, 使用以下命令安全追加:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">[</span>admin@node1 .ssh<span class="token punctuation">]</span>$ <span class="token function">cat</span> id_rsa.pub <span class="token operator">&gt;&gt;</span> authorized_keys
</code></pre></div><p>修改 <code>/etc/ssh/sshd_config</code>，开启 RSA 和 公钥认证</p> <div class="language- extra-class"><pre class="language-text"><code>RSAAuthentication yes
PubkeyAuthentication yes
AuthorizedKeysFile      .ssh/authorized_keys
</code></pre></div><h3 id="通过-scp-发送到服务器"><a href="#通过-scp-发送到服务器" aria-hidden="true" class="header-anchor">#</a> 通过 scp 发送到服务器</h3> <p>如果通过以上方式不能解决, 可以通过 scp 命令发送公钥到服务器, 然后再在服务器中配置:</p> <p>客户机</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">scp</span> ./id_rsa.pub admin@sshk2:~
id_rsa.pub     100%  410     1.5MB/s   00:00
</code></pre></div><p>需要远程登录的服务器</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">cat</span> id_rsa.pub <span class="token operator">&gt;&gt;</span> ~/.ssh/authorized_keys
</code></pre></div><h2 id="关闭密码验证"><a href="#关闭密码验证" aria-hidden="true" class="header-anchor">#</a> 关闭密码验证</h2> <p>为了安全起见，关闭密码认证，修改 <code>/etc/ssh/sshd_config</code></p> <div class="language- extra-class"><pre class="language-text"><code>PasswordAuthentication no
</code></pre></div><p>重启 ssh 服务即可</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ systemctl restart sshd
</code></pre></div><p>此时，就可以在客户端使用私钥进行 SSH 登录, git 克隆什么的也不需要输入密码了</p> <div class="imgLink" data-v-16222526><img src="https://img.xiaoyulive.top/img/articles/009.jpg" data-v-16222526></div> <h2 id="多台主机命名"><a href="#多台主机命名" aria-hidden="true" class="header-anchor">#</a> 多台主机命名</h2> <p>当使用多台主机的时候, 如果使用默认主机名, 将很难区分其名字, 可以使用以下命令进行重命名主机名:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">hostname</span> node1
</code></pre></div><p>以上修改, 将在服务器不重启的条件下生效, 若服务器重启将恢复默认主机名。</p> <p>或者修改配置文件 <code>/etc/hostname</code>, 配置将在重启服务器后生效:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">vim</span> /etc/hostname
node1
</code></pre></div><h2 id="权限问题"><a href="#权限问题" aria-hidden="true" class="header-anchor">#</a> 权限问题</h2> <p>如果配置了 ssh, 仍然登录不上, 那就得看看目录权限是否有问题了。</p> <p>SSH对公钥，私钥的权限和所有权的要求是非常严格的，总结如下：</p> <ol><li>用户家目录及其 .ssh 目录所有权必须是登录用户本身，所属组也应该是登录用户本身，权限必须为700</li></ol> <ul><li><code>chmod 700 ~</code></li> <li><code>chmod 700 ~/.ssh</code></li></ul> <ol start="2"><li>公钥文件的所有权必须是登录用户本身，所属组也必须是登录用户本身，权限必须是644或600</li></ol> <ul><li><code>chmod 644 ~/.ssh/authorized_keys</code></li></ul> <ol start="3"><li>为了防止篡改, 建议把 <code>id_rsa</code> 和 <code>id_rsa.pub</code> 设置为 400 (不强制)</li></ol> <p>如果权限不对，会造成不能正常登录，报错信息：<code>Permission denied (publickey,gssapi-with-mic.....)</code></p> <div class="language- extra-class"><pre class="language-text"><code>[root@sshk1 .ssh]# ll -a
total 24
drwx------   2 root root 4096 Dec 27 18:24 .
drwx------. 16 root root 4096 Dec 27 18:24 ..
-rw-------   1 root root  406 Dec 27 18:24 authorized_keys
-r--------   1 root root 1679 Dec 25 16:47 id_rsa
-r--------   1 root root  410 Dec 25 16:47 id_rsa.pub
-rw-------   1 root root  537 Dec 25 16:59 known_hosts
</code></pre></div><p>使用 <code>man sshd</code>, 搜索 <code>authorized_keys</code> 可以看出端倪:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>~/.ssh/authorized_keys
        Lists the public keys <span class="token punctuation">(</span>DSA, ECDSA, Ed25519, RSA<span class="token punctuation">)</span> that can be used <span class="token keyword">for</span> logging <span class="token keyword">in</span> as this user.  The <span class="token function">format</span> of this <span class="token function">file</span> is described above.  The content of the <span class="token function">file</span> is not highly sensitive,
        but the recommended permissions are read/write <span class="token keyword">for</span> the user, and not accessible by others.

        If this file, the ~/.ssh directory, or the user's home directory are writable by other users, <span class="token keyword">then</span> the <span class="token function">file</span> could be modified or replaced by unauthorized users.  In this case, sshd will not
        allow it to be used unless the StrictModes option has been <span class="token keyword">set</span> to “no”.
</code></pre></div><h2 id="参考资料"><a href="#参考资料" aria-hidden="true" class="header-anchor">#</a> 参考资料</h2> <ul><li><a href="https://blog.csdn.net/m0_37876550/article/details/80521241" target="_blank" rel="noopener noreferrer">sshpass 使用方法<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><div class="article-info"><div class="article-title">文档信息</div><p class="article-item">版权声明：著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p><p class="article-item">文章标题：使用 SSH 私钥登录 Linux 系统</p><p class="article-item">原文链接：<a href="https://www.xiaoyulive.top/categories/os/linux/_pages/SSH_Login.html">https://www.xiaoyulive.top/categories/os/linux/_pages/SSH_Login.html</a></p><p class="article-item">发表日期：2017-03-10</p></div><!----><!----></div><div class="footers" data-v-38547c78><p data-v-38547c78><span data-v-38547c78>MIT Licensed | Copyright © 2018-present  滇ICP备16006294号</span></p><p data-v-38547c78><span data-v-38547c78>Design by <a href="/">Quanzaiyu</a> | Power by <a href="https://vuepress.vuejs.org/" target="_blank">VuePress</a> | Hosted by <a href="https://pages.coding.me" target="_blank" style="font-weight: bold">Coding Pages</a></span></p></div></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.7e1a04b4.js" defer></script><script src="/assets/js/5.65637494.js" defer></script><script src="/assets/js/14.b0ee95fc.js" defer></script>
  </body>
</html>
