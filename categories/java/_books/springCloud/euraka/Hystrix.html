<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Hystrix 监控和断路器 | 小昱个人网站</title>
    <meta name="description" content="小昱个人网站">
    <meta http-equiv="Expires" content="Mon,12 May 2050 00:20:00 GMT">
  <meta name="keywords" content="小昱,个人网站,Vue,JavaScript,HTML,CSS">
  <link rel="icon" href="/logo.png">
  <link rel="manifest" href="/manifest.json">
  <link rel="stylesheet" href="//at.alicdn.com/t/font_517060_lom78h954w.css">
  <link rel="stylesheet" href="https://img.xiaoyulive.top/css/animate.css">
    
    <link rel="preload" href="/assets/css/0.styles.e2d81a46.css" as="style"><link rel="preload" href="/assets/js/app.9ed971f3.js" as="script"><link rel="preload" href="/assets/js/5.02c6f39a.js" as="script"><link rel="preload" href="/assets/js/14.06787ef0.js" as="script"><link rel="prefetch" href="/assets/js/1.afaaabe7.js"><link rel="prefetch" href="/assets/js/10.aa82e34b.js"><link rel="prefetch" href="/assets/js/11.8ecfdfba.js"><link rel="prefetch" href="/assets/js/12.e029831b.js"><link rel="prefetch" href="/assets/js/13.63420ebd.js"><link rel="prefetch" href="/assets/js/15.77a51247.js"><link rel="prefetch" href="/assets/js/2.09c78e88.js"><link rel="prefetch" href="/assets/js/6.48d6b923.js"><link rel="prefetch" href="/assets/js/7.341d3c18.js"><link rel="prefetch" href="/assets/js/8.3dd7f6da.js"><link rel="prefetch" href="/assets/js/9.35682099.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.333a44c7.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e2d81a46.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-38547c78><header class="navbar" data-v-38547c78><div class="navbar-content"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/" class="home-link router-link-active"><img src="/logo.png" class="logo"><span class="site-name can-hide">小昱个人网站</span></a><div class="links"><nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">开发者博客</a></div><div class="nav-item"><a href="/articles/" class="nav-link">生活漫谈</a></div><div class="nav-item"><a href="/note/" class="nav-link">阅读札记</a></div><div class="nav-item"><a href="/categories/" class="nav-link router-link-active">学无止境</a></div><div class="nav-item"><a href="/share/" class="nav-link">精品分享</a></div><div class="nav-item"><a href="/favorite/" class="nav-link">收藏夹</a></div><!----></nav><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div></div></div></header><div class="sidebar-mask" data-v-38547c78></div><div class="sidebar" data-v-38547c78><div class="sidebar-container"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">开发者博客</a></div><div class="nav-item"><a href="/articles/" class="nav-link">生活漫谈</a></div><div class="nav-item"><a href="/note/" class="nav-link">阅读札记</a></div><div class="nav-item"><a href="/categories/" class="nav-link router-link-active">学无止境</a></div><div class="nav-item"><a href="/share/" class="nav-link">精品分享</a></div><div class="nav-item"><a href="/favorite/" class="nav-link">收藏夹</a></div><!----></nav><ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading"><span>SpringCloud 开发笔记</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>Eureka</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/categories/java/_books/springCloud/euraka/" class="sidebar-link">Eureka</a></li><li><a href="/categories/java/_books/springCloud/euraka/Cluster.html" class="sidebar-link">eureka集群配置</a></li><li><a href="/categories/java/_books/springCloud/euraka/Register.html" class="sidebar-link">注册中心</a></li><li><a href="/categories/java/_books/springCloud/euraka/Producer.html" class="sidebar-link">服务提供者</a></li><li><a href="/categories/java/_books/springCloud/euraka/Ribbon.html" class="sidebar-link">Ribbon 服务调用者</a></li><li><a href="/categories/java/_books/springCloud/euraka/Feign.html" class="sidebar-link">Feign 服务调用者</a></li><li><a href="/categories/java/_books/springCloud/euraka/Hystrix.html" class="active sidebar-link">Hystrix 监控和断路器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/categories/java/_books/springCloud/euraka/Hystrix.html#feign开启hystrix" class="sidebar-link">Feign开启Hystrix</a></li><li class="sidebar-sub-header"><a href="/categories/java/_books/springCloud/euraka/Hystrix.html#_1-修改yaml" class="sidebar-link">1. 修改yaml</a></li><li class="sidebar-sub-header"><a href="/categories/java/_books/springCloud/euraka/Hystrix.html#_2-修改服务" class="sidebar-link">2. 修改服务</a></li><li class="sidebar-sub-header"><a href="/categories/java/_books/springCloud/euraka/Hystrix.html#_3-创建服务实现类" class="sidebar-link">3. 创建服务实现类</a></li><li class="sidebar-sub-header"><a href="/categories/java/_books/springCloud/euraka/Hystrix.html#_4-测试熔断服务" class="sidebar-link">4.测试熔断服务</a></li></ul></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>其他</span> <span class="arrow right"></span></p> <!----></div></li></ul></div></div><div class="page" data-v-38547c78><div class="content__default"><h1 id="hystrix-监控和断路器"><a href="#hystrix-监控和断路器" aria-hidden="true" class="header-anchor">#</a> Hystrix 监控和断路器</h1> <p>断路器模式源于Martin Fowler的Circuit Breaker一文。“断路器”本身是一种开关装置，用于在电路上保护线路过载，当线路中有电器发生短路时，“断路器”能够及时的切断故障电路，防止发生过载、发热、甚至起火等严重后果。</p> <p>在分布式架构中，断路器模式的作用也是类似的，当某个服务单元发生故障（类似用电器发生短路）之后，通过断路器的故障监控（类似熔断保险丝），直接切断原来的主逻辑调用。但是，在Hystrix中的断路器除了切断主逻辑的功能之外，还有更复杂的逻辑。</p> <p>正常情况下，当整个服务环境中，某一个服务提供方由于网络原因、数据库原因或者性能原因等，造成响应很慢的话，调用方就有可能短时间内累计大量的请求线程，最终造成调用方down，甚至整个系统崩溃。而加入hystrix之后，如果hystrix发现某个服务的某台机器调用非常缓慢或者多次调用失败，就会短时间内把这条路断掉，所有的请求都不会再发到这台机器上。</p> <p>如果某个服务所有的机器都挂了，hystrix会迅速失败，马上返回，保证被调用方不会有大量的线程堆积。</p> <p>使用eureka时，当一个服务提供方挂掉以后，服务订阅者最长可能30s以后才知道，那这30s就会出现大量的调用失败。如果在系统里面集成了hystrix，就会马上把挂掉的这台服务提供方断路掉，让请求不再转发到这台机器上，大量减少调用失败。
hystrix执行断路操作以后，并不表示这条路就永远断了，而是会一定时间间隔内缓慢尝试去请求这条路，如果能请求成功，断路就会恢复。</p> <p>有一点需要注意的是hystrix在做断路时，默认所有的调用请求都会放在一个的线程池中进行，线程池的作用很明显，有隔离性。比如gateway，集成了5个子业务系统，可能其中一个系统的调用量非常大，而另外四个系统的调用很小，如果没有线程池的话，显然第一个系统的大量调用会影响到后面四个系统的调用性能。hystrix的线程池和java标准线程池一样，可以配置一些参数：coreSize、maximumSize、maxQueueSize、queueSizeRejectionThreshold、allowMaximumSizeToDivergeFromCoreSize、keepAliveTimeMinutes等，如果某一个子系统的调用量突然激增，超过了线程池的容量，也会迅速失败，直接返回，起到降级和保护系统本身的作用。当然hystrix也支持非线程池的方式，在本地请求线程中做调用，即semaphore模式，官方不建议，除非系统qps真的很大。</p> <h2 id="feign开启hystrix"><a href="#feign开启hystrix" aria-hidden="true" class="header-anchor">#</a> Feign开启Hystrix</h2> <p>Feign默认集成了Hystrix。我们可以在上一个模块 <code>service-consumer-feign</code> 中增加熔断特性。</p> <h2 id="_1-修改yaml"><a href="#_1-修改yaml" aria-hidden="true" class="header-anchor">#</a> 1. 修改yaml</h2> <p>修改 <code>service-consumer-feign</code> 模块下的 <code>resource/application.yaml</code></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> service<span class="token punctuation">-</span>consumer<span class="token punctuation">-</span>feign

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token comment"># 设置与Eureka Server交互的地址，查询服务和注册服务都需要依赖这个地址。默认是http://localhost:8761/eureka ；多个地址可使用 , 分隔。</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>8761/eureka/<span class="token punctuation">,</span>http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>8762/eureka/<span class="token punctuation">,</span>http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>8763/eureka/

<span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token key atrule">hystrix</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre></div><h2 id="_2-修改服务"><a href="#_2-修改服务" aria-hidden="true" class="header-anchor">#</a> 2. 修改服务</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>test<span class="token punctuation">.</span>feign<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>test<span class="token punctuation">.</span>feign<span class="token punctuation">.</span>service</span><span class="token punctuation">.</span><span class="token class-name">Impl</span><span class="token punctuation">.</span><span class="token class-name">TestServiceImpl</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign</span><span class="token punctuation">.</span><span class="token class-name">FeignClient</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation</span><span class="token punctuation">.</span><span class="token class-name">GetMapping</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation</span><span class="token punctuation">.</span><span class="token class-name">RequestParam</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;service-producer&quot;</span><span class="token punctuation">,</span> fallback <span class="token operator">=</span> <span class="token class-name">TestServiceImpl</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">TestService</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span>
  <span class="token class-name">String</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里, 添加了 fallback, 指定熔断后的回调类</p> <h2 id="_3-创建服务实现类"><a href="#_3-创建服务实现类" aria-hidden="true" class="header-anchor">#</a> 3. 创建服务实现类</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>test<span class="token punctuation">.</span>feign<span class="token punctuation">.</span>service</span><span class="token punctuation">.</span><span class="token class-name">Impl</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>test<span class="token punctuation">.</span>feign<span class="token punctuation">.</span>service</span><span class="token punctuation">.</span><span class="token class-name">TestService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype</span><span class="token punctuation">.</span><span class="token class-name">Component</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation</span><span class="token punctuation">.</span><span class="token class-name">RequestParam</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">TestService</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;sorry &quot;</span><span class="token operator">+</span>name<span class="token operator">+</span><span class="token string">&quot;，service has fail!&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>创建熔断后的回调类, 实现 TestService 接口</p> <h2 id="_4-测试熔断服务"><a href="#_4-测试熔断服务" aria-hidden="true" class="header-anchor">#</a> 4.测试熔断服务</h2> <p>启动 <code>service-consumer-feign</code> 服务, 关闭 <code>service-producer</code> 服务, 在浏览器访问 <code>http://localhost:8080/hello/xiaoyu</code>, 屏幕上应该打印出:</p> <div class="language- extra-class"><pre class="language-text"><code>sorry xiaoyu，service has fail!
</code></pre></div><div class="imgLink" data-v-16222526><img src="https://img.xiaoyulive.top/img/date/20190607/001.png" data-v-16222526></div> <hr> <p>参考:</p> <p><a href="https://blog.csdn.net/weixin_43430036/article/details/83865813" target="_blank" rel="noopener noreferrer">走进Spring Cloud之六 Hystrix（监控和断路器）（Greenwich版本）<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div><div class="article-info"><div class="article-title">文档信息</div><p class="article-item">版权声明：著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p><p class="article-item">文章标题：Hystrix 监控和断路器</p><p class="article-item">原文链接：<a href="https://www.xiaoyulive.top/categories/java/_books/springCloud/euraka/Hystrix.html">https://www.xiaoyulive.top/categories/java/_books/springCloud/euraka/Hystrix.html</a></p><!----></div><!----><div class="content page-nav"><p class="inner"><span class="prev">← <a href="/categories/java/_books/springCloud/euraka/Feign.html">Feign 服务调用者</a></span><span class="next"><a href="/categories/java/_books/springCloud/Reference.html">参考资料</a>  →</span></p></div></div><div class="footers" data-v-38547c78><p data-v-38547c78><span data-v-38547c78>MIT Licensed | Copyright © 2018-present  滇ICP备16006294号</span></p><p data-v-38547c78><span data-v-38547c78>Design by <a href="/">Quanzaiyu</a> | Power by <a href="https://vuepress.vuejs.org/" target="_blank">VuePress</a> | Hosted by <a href="https://pages.coding.me" target="_blank" style="font-weight: bold">Coding Pages</a></span></p></div></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.9ed971f3.js" defer></script><script src="/assets/js/5.02c6f39a.js" defer></script><script src="/assets/js/14.06787ef0.js" defer></script>
  </body>
</html>
