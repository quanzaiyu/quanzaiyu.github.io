<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MySQL 事务详解 | 小昱个人网站</title>
    <meta name="description" content="小昱个人网站">
    <meta http-equiv="Expires" content="Mon,12 May 2050 00:20:00 GMT">
  <link rel="icon" href="/logo.png">
  <link rel="manifest" href="/manifest.json">
  <link rel="stylesheet" href="//at.alicdn.com/t/font_517060_lom78h954w.css">
  <link rel="stylesheet" href="https://img.xiaoyulive.top/css/animate.css">
    
    <link rel="preload" href="/assets/css/0.styles.a54b61f3.css" as="style"><link rel="preload" href="/assets/js/app.18f33b4c.js" as="script"><link rel="preload" href="/assets/js/5.2b629961.js" as="script"><link rel="prefetch" href="/assets/js/1.8095ab00.js"><link rel="prefetch" href="/assets/js/10.9532bb63.js"><link rel="prefetch" href="/assets/js/11.625b5a66.js"><link rel="prefetch" href="/assets/js/12.4d151698.js"><link rel="prefetch" href="/assets/js/13.3a31a12a.js"><link rel="prefetch" href="/assets/js/14.fd8d2641.js"><link rel="prefetch" href="/assets/js/15.f91c6a57.js"><link rel="prefetch" href="/assets/js/2.12888179.js"><link rel="prefetch" href="/assets/js/6.8a92dcea.js"><link rel="prefetch" href="/assets/js/7.e1fcd8a7.js"><link rel="prefetch" href="/assets/js/8.c5595756.js"><link rel="prefetch" href="/assets/js/9.2f94d982.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.ba35f035.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a54b61f3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-38547c78><header class="navbar" data-v-38547c78><div class="navbar-content"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/" class="home-link router-link-active"><img src="/logo.png" class="logo"><span class="site-name can-hide">小昱个人网站</span></a><div class="links"><nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">开发者博客</a></div><div class="nav-item"><a href="/articles/" class="nav-link">生活漫谈</a></div><div class="nav-item"><a href="/note/" class="nav-link">阅读札记</a></div><div class="nav-item"><a href="/categories/" class="nav-link router-link-active">学无止境</a></div><div class="nav-item"><a href="/share/" class="nav-link">精品分享</a></div><div class="nav-item"><a href="/favorite/" class="nav-link">收藏夹</a></div><!----></nav><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div></div></div></header><div class="sidebar-mask" data-v-38547c78></div><div class="sidebar" data-v-38547c78><div class="sidebar-container"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">开发者博客</a></div><div class="nav-item"><a href="/articles/" class="nav-link">生活漫谈</a></div><div class="nav-item"><a href="/note/" class="nav-link">阅读札记</a></div><div class="nav-item"><a href="/categories/" class="nav-link router-link-active">学无止境</a></div><div class="nav-item"><a href="/share/" class="nav-link">精品分享</a></div><div class="nav-item"><a href="/favorite/" class="nav-link">收藏夹</a></div><!----></nav><ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>MySQL 事务详解</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/categories/mysql/_pages/Transaction.html#事务的特性" class="sidebar-link">事务的特性</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/categories/mysql/_pages/Transaction.html#事务控制语句" class="sidebar-link">事务控制语句</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/categories/mysql/_pages/Transaction.html#mysql-事务处理主要有两种方法" class="sidebar-link">MYSQL 事务处理主要有两种方法</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/categories/mysql/_pages/Transaction.html#事务测试" class="sidebar-link">事务测试</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/categories/mysql/_pages/Transaction.html#php中使用事务实例" class="sidebar-link">PHP中使用事务实例</a><ul class="sidebar-sub-headers"></ul></li></ul></div></li></ul></div></div><div class="page" data-v-38547c78><div class="content default"><h1 id="mysql-事务详解"><a href="#mysql-事务详解" aria-hidden="true" class="header-anchor">#</a> MySQL 事务详解</h1> <p>MySQL 事务主要用于处理操作量大，复杂度高的数据。比如说，在人员管理系统中，你删除一个人员，你即需要删除人员的基本资料，也要删除和该人员相关的信息，如信箱，文章等等，这样，这些数据库操作语句就构成一个事务！</p> <ul><li>在 MySQL 中只有使用了 Innodb 数据库引擎的数据库或表才支持事务。</li> <li>事务处理可以用来维护数据库的完整性，保证成批的 SQL 语句要么全部执行，要么全部不执行。</li> <li>事务用来管理 insert,update,delete 语句</li></ul> <h2 id="事务的特性"><a href="#事务的特性" aria-hidden="true" class="header-anchor">#</a> 事务的特性</h2> <p>一般来说，事务是必须满足4个条件（ACID）：原子性（Atomicity，或称不可分割性）、一致性（Consistency）、隔离性（Isolation，又称独立性）、持久性（Durability）。</p> <ul><li><strong>原子性：</strong> 一个事务（transaction）中的所有操作，要么全部完成，要么全部不完成，不会结束在中间某个环节。事务在执行过程中发生错误，会被回滚（Rollback）到事务开始前的状态，就像这个事务从来没有执行过一样。</li> <li><strong>一致性：</strong> 在事务开始之前和事务结束以后，数据库的完整性没有被破坏。这表示写入的资料必须完全符合所有的预设规则，这包含资料的精确度、串联性以及后续数据库可以自发性地完成预定的工作。</li> <li><strong>隔离性：</strong> 数据库允许多个并发事务同时对其数据进行读写和修改的能力，隔离性可以防止多个事务并发执行时由于交叉执行而导致数据的不一致。事务隔离分为不同级别，包括读未提交（Read uncommitted）、读提交（read committed）、可重复读（repeatable read）和串行化（Serializable）。</li> <li><strong>持久性：</strong> 事务处理结束后，对数据的修改就是永久的，即便系统故障也不会丢失。</li></ul> <blockquote><p>在 MySQL 命令行的默认设置下，事务都是自动提交的，即执行 SQL 语句后就会马上执行 COMMIT 操作。因此要显式地开启一个事务务须使用命令 BEGIN 或 START TRANSACTION，或者执行命令 SET AUTOCOMMIT=0，用来禁止使用当前会话的自动提交。</p></blockquote> <h2 id="事务控制语句"><a href="#事务控制语句" aria-hidden="true" class="header-anchor">#</a> 事务控制语句</h2> <ul><li><strong>BEGIN TRANSACTION</strong> 或 <strong>START TRANSACTION</strong>：显式地开启一个事务；</li> <li><strong>COMMIT</strong>：也可以使用 COMMIT WORK，不过二者是等价的。COMMIT 会提交事务，并使已对数据库进行的所有修改成为永久性的；</li> <li><strong>ROLLBACK</strong>：有可以使用 ROLLBACK WORK，不过二者是等价的。回滚会结束用户的事务，并撤销正在进行的所有未提交的修改；</li> <li><strong>SAVEPOINT identifier</strong>：SAVEPOINT 允许在事务中创建一个保存点，一个事务中可以有多个 SAVEPOINT；</li> <li><strong>RELEASE SAVEPOINT identifier</strong>：删除一个事务的保存点，当没有指定的保存点时，执行该语句会抛出一个异常；</li> <li><strong>ROLLBACK TO identifier</strong>：把事务回滚到标记点；</li> <li><strong>SET TRANSACTION</strong>：用来设置事务的隔离级别。InnoDB 存储引擎提供事务的隔离级别有 READ UNCOMMITTED、READ COMMITTED、REPEATABLE READ 和 SERIALIZABLE。</li></ul> <h2 id="mysql-事务处理主要有两种方法"><a href="#mysql-事务处理主要有两种方法" aria-hidden="true" class="header-anchor">#</a> MYSQL 事务处理主要有两种方法</h2> <p>1、用 BEGIN, ROLLBACK, COMMIT 来实现</p> <ul><li><strong>BEGIN</strong> 开始一个事务</li> <li><strong>ROLLBACK</strong> 事务回滚</li> <li><strong>COMMIT</strong> 事务确认</li></ul> <p>2、直接用 SET 来改变 MySQL 的自动提交模式</p> <ul><li><strong>SET AUTOCOMMIT=0</strong> 禁止自动提交</li> <li><strong>SET AUTOCOMMIT=1</strong> 开启自动提交</li></ul> <h2 id="事务测试"><a href="#事务测试" aria-hidden="true" class="header-anchor">#</a> 事务测试</h2> <div class="language-bash extra-class"><pre class="language-bash"><code>mysql<span class="token operator">&gt;</span> use RUNOOB<span class="token punctuation">;</span>
Database changed
mysql<span class="token operator">&gt;</span> CREATE TABLE runoob_transaction_test<span class="token punctuation">(</span> <span class="token function">id</span> int<span class="token punctuation">(</span>5<span class="token punctuation">))</span> engine<span class="token operator">=</span>innodb<span class="token punctuation">;</span>  <span class="token comment"># 创建数据表</span>
Query OK, 0 rows affected <span class="token punctuation">(</span>0.04 sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> * from runoob_transaction_test<span class="token punctuation">;</span>
Empty <span class="token keyword">set</span> <span class="token punctuation">(</span>0.01 sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> begin<span class="token punctuation">;</span>  <span class="token comment"># 开始事务</span>
Query OK, 0 rows affected <span class="token punctuation">(</span>0.00 sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> insert into runoob_transaction_test value<span class="token punctuation">(</span>5<span class="token punctuation">)</span><span class="token punctuation">;</span>
Query OK, 1 rows affected <span class="token punctuation">(</span>0.01 sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> insert into runoob_transaction_test value<span class="token punctuation">(</span>6<span class="token punctuation">)</span><span class="token punctuation">;</span>
Query OK, 1 rows affected <span class="token punctuation">(</span>0.00 sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> commit<span class="token punctuation">;</span> <span class="token comment"># 提交事务</span>
Query OK, 0 rows affected <span class="token punctuation">(</span>0.01 sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span>  <span class="token keyword">select</span> * from runoob_transaction_test<span class="token punctuation">;</span>
+------+
<span class="token operator">|</span> <span class="token function">id</span>   <span class="token operator">|</span>
+------+
<span class="token operator">|</span> 5    <span class="token operator">|</span>
<span class="token operator">|</span> 6    <span class="token operator">|</span>
+------+
2 rows <span class="token keyword">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span>0.01 sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> begin<span class="token punctuation">;</span>    <span class="token comment"># 开始事务</span>
Query OK, 0 rows affected <span class="token punctuation">(</span>0.00 sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span>  insert into runoob_transaction_test values<span class="token punctuation">(</span>7<span class="token punctuation">)</span><span class="token punctuation">;</span>
Query OK, 1 rows affected <span class="token punctuation">(</span>0.00 sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> rollback<span class="token punctuation">;</span>   <span class="token comment"># 回滚</span>
Query OK, 0 rows affected <span class="token punctuation">(</span>0.00 sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span>   <span class="token keyword">select</span> * from runoob_transaction_test<span class="token punctuation">;</span>   <span class="token comment"># 因为回滚所以数据没有插入</span>
+------+
<span class="token operator">|</span> <span class="token function">id</span>   <span class="token operator">|</span>
+------+
<span class="token operator">|</span> 5    <span class="token operator">|</span>
<span class="token operator">|</span> 6    <span class="token operator">|</span>
+------+
2 rows <span class="token keyword">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span>0.01 sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span>
</code></pre></div><h2 id="php中使用事务实例"><a href="#php中使用事务实例" aria-hidden="true" class="header-anchor">#</a> PHP中使用事务实例</h2> <div class="language-php extra-class"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$dbhost</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'localhost:3306'</span><span class="token punctuation">;</span>  <span class="token comment">// mysql服务器主机地址</span>
<span class="token variable">$dbuser</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'root'</span><span class="token punctuation">;</span>            <span class="token comment">// mysql用户名</span>
<span class="token variable">$dbpass</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'123456'</span><span class="token punctuation">;</span>          <span class="token comment">// mysql用户名密码</span>
<span class="token variable">$conn</span> <span class="token operator">=</span> <span class="token function">mysqli_connect</span><span class="token punctuation">(</span><span class="token variable">$dbhost</span><span class="token punctuation">,</span> <span class="token variable">$dbuser</span><span class="token punctuation">,</span> <span class="token variable">$dbpass</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span> <span class="token variable">$conn</span> <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'连接失败: '</span> <span class="token punctuation">.</span> <span class="token function">mysqli_error</span><span class="token punctuation">(</span><span class="token variable">$conn</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 设置编码，防止中文乱码</span>
<span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$conn</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">&quot;set names utf8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">mysqli_select_db</span><span class="token punctuation">(</span> <span class="token variable">$conn</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'RUNOOB'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$conn</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">&quot;SET AUTOCOMMIT=0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置为不自动提交，因为MYSQL默认立即执行</span>
<span class="token function">mysqli_begin_transaction</span><span class="token punctuation">(</span><span class="token variable">$conn</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 开始事务定义</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$conn</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">&quot;insert into runoob_transaction_test (id) values(8)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$conn</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">&quot;ROLLBACK&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 判断当执行失败时回滚</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$conn</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">&quot;insert into runoob_transaction_test (id) values(9)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$conn</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">&quot;ROLLBACK&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 判断执行失败时回滚</span>
<span class="token punctuation">}</span>
<span class="token function">mysqli_commit</span><span class="token punctuation">(</span><span class="token variable">$conn</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//执行事务</span>
<span class="token function">mysqli_close</span><span class="token punctuation">(</span><span class="token variable">$conn</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?&gt;</span></span>
</code></pre></div></div><div class="article-info"><div class="article-title">文档信息</div><p class="article-item">版权声明：著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p><p class="article-item">文章标题：MySQL 事务详解</p><p class="article-item">原文链接：<a href="https://www.xiaoyulive.top/categories/mysql/_pages/Transaction.html">https://www.xiaoyulive.top/categories/mysql/_pages/Transaction.html</a></p><p class="article-item">发表日期：2018-07-17</p></div><!----><!----></div><div class="footers" data-v-38547c78><p data-v-38547c78><span data-v-38547c78>MIT Licensed | Copyright © 2018-present  滇ICP备16006294号</span></p><p data-v-38547c78><span data-v-38547c78>Design by <a href="/">Quanzaiyu</a> | Power by <a href="https://vuepress.vuejs.org/" target="_blank">VuePress</a> | Hosted by <a href="https://pages.coding.me" target="_blank" style="font-weight: bold">Coding Pages</a></span></p></div></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.18f33b4c.js" defer></script><script src="/assets/js/5.2b629961.js" defer></script>
  </body>
</html>
