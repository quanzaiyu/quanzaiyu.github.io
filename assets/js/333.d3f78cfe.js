(window.webpackJsonp=window.webpackJsonp||[]).push([[333],{1084:function(s,t,a){"use strict";a.r(t);var n=a(1),e=Object(n.a)({},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("div",{staticClass:"content"},[a("h1",{attrs:{id:"nginx-服务器中-php-调用本地接口失败的解决方案"}},[s._v("Nginx 服务器中 PHP 调用本地接口失败的解决方案")]),s._v(" "),a("h2",{attrs:{id:"问题现象"}},[s._v("问题现象")]),s._v(" "),a("p",[s._v("当在同一个 PHP 项目中访问同一个项目中的接口的时候，会出现访问超时、加载不出数据甚至卡死的问题。")]),s._v(" "),a("h2",{attrs:{id:"问题原因"}},[s._v("问题原因")]),s._v(" "),a("p",[s._v("NGINX 中，看 PHP 文件块 fastcig-pass 的设置值(127.0.0.1:9000)。设置都是以 keepalive 方式请求，接收到 PHP 文件时，交于后端过程 PHPCGI 解析处理(127.0.0.1:9000)，等待响应。")]),s._v(" "),a("p",[s._v("而在本地文件以 CURL 请求本地环境中 PHP 文件时，之前的 PHP 还在等待 CURL 后的结果，这时 9000 端口已经被占用。导致 CURL 一直在处于等待状态。不设置 timeout 超时，程序就会卡死。")]),s._v(" "),a("h2",{attrs:{id:"解决方案"}},[s._v("解决方案")]),s._v(" "),a("p",[s._v("第一步，使用负载均衡的方式为 php-cgi 设置多个端口，比如:")]),s._v(" "),s._m(0),a("p",[s._v("第二步，重启 nginx，并新开启一个 phpcgi 进程监听不同端口，比如:")]),s._v(" "),s._m(1),s._m(2),s._v(" "),a("h2",{attrs:{id:"参考资料"}},[s._v("参考资料")]),s._v(" "),a("p",[a("a",{attrs:{href:"https://www.cnblogs.com/wamptao/p/6381913.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("PHP----------用curl方式请求接口在同一个项目里面的时候不能请求的情况"),a("OutboundLink")],1)]),s._v(" "),a("p",[a("a",{attrs:{href:"https://blog.csdn.net/yicixing7/article/details/77323706",target:"_blank",rel:"noopener noreferrer"}},[s._v("为什么本地开发时使用CURL请求本地URL会卡死"),a("OutboundLink")],1)]),s._v(" "),a("p",[a("a",{attrs:{href:"https://blog.csdn.net/php_younger/article/details/54890136",target:"_blank",rel:"noopener noreferrer"}},[s._v("搭建nginx负载均衡"),a("OutboundLink")],1)])])},[function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("div",{staticClass:"language-nginx line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{attrs:{class:"token keyword"}},[s._v("upstream")]),s._v(" backend"),a("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{attrs:{class:"token keyword"}},[s._v("server")]),s._v(" "),a("span",{attrs:{class:"token number"}},[s._v("127.0")]),a("span",{attrs:{class:"token number"}},[s._v(".0")]),a("span",{attrs:{class:"token number"}},[s._v(".1")]),a("span",{attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{attrs:{class:"token number"}},[s._v("9000")]),a("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{attrs:{class:"token keyword"}},[s._v("server")]),s._v(" "),a("span",{attrs:{class:"token number"}},[s._v("127.0")]),a("span",{attrs:{class:"token number"}},[s._v(".0")]),a("span",{attrs:{class:"token number"}},[s._v(".1")]),a("span",{attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{attrs:{class:"token number"}},[s._v("9001")]),a("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{attrs:{class:"token keyword"}},[s._v("server")]),s._v(" "),a("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{attrs:{class:"token keyword"}},[s._v("listen")]),s._v(" "),a("span",{attrs:{class:"token number"}},[s._v("80")]),a("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{attrs:{class:"token keyword"}},[s._v("server_name")]),s._v("  www"),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("dyt_api"),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com "),a("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{attrs:{class:"token keyword"}},[s._v("root")]),s._v("   "),a("span",{attrs:{class:"token string"}},[s._v('"D:/projects/dyt_api/public"')]),a("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{attrs:{class:"token keyword"}},[s._v("location")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),a("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{attrs:{class:"token keyword"}},[s._v("index")]),s._v("  "),a("span",{attrs:{class:"token keyword"}},[s._v("index")]),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("html "),a("span",{attrs:{class:"token keyword"}},[s._v("index")]),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("htm "),a("span",{attrs:{class:"token keyword"}},[s._v("index")]),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("php"),a("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{attrs:{class:"token comment"}},[s._v("#autoindex  on;")]),s._v("\n    "),a("span",{attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{attrs:{class:"token operator"}},[s._v("!")]),a("span",{attrs:{class:"token operator"}},[s._v("-")]),s._v("e "),a("span",{attrs:{class:"token variable"}},[s._v("$request_filename")]),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),a("span",{attrs:{class:"token keyword"}},[s._v("rewrite")]),s._v("  "),a("span",{attrs:{class:"token operator"}},[s._v("^")]),a("span",{attrs:{class:"token operator"}},[s._v("/")]),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{attrs:{class:"token operator"}},[s._v("*")]),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("$  "),a("span",{attrs:{class:"token operator"}},[s._v("/")]),a("span",{attrs:{class:"token keyword"}},[s._v("index")]),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("php"),a("span",{attrs:{class:"token operator"}},[s._v("/")]),s._v("$"),a("span",{attrs:{class:"token number"}},[s._v("1")]),s._v("  last"),a("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n      "),a("span",{attrs:{class:"token keyword"}},[s._v("break")]),a("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),a("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),a("span",{attrs:{class:"token keyword"}},[s._v("location")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("~")]),s._v(" \\"),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{attrs:{class:"token function"}},[s._v("php")]),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{attrs:{class:"token operator"}},[s._v("*")]),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("$ "),a("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{attrs:{class:"token keyword"}},[s._v("fastcgi_pass")]),s._v("   backend"),a("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{attrs:{class:"token keyword"}},[s._v("fastcgi_index")]),s._v("  "),a("span",{attrs:{class:"token keyword"}},[s._v("index")]),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("php"),a("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{attrs:{class:"token keyword"}},[s._v("fastcgi_split_path_info")]),s._v("  "),a("span",{attrs:{class:"token operator"}},[s._v("^")]),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{attrs:{class:"token operator"}},[s._v("?")]),s._v("U"),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{attrs:{class:"token operator"}},[s._v("+")]),s._v("\\"),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("php"),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{attrs:{class:"token operator"}},[s._v("/")]),a("span",{attrs:{class:"token operator"}},[s._v("?")]),a("span",{attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{attrs:{class:"token operator"}},[s._v("+")]),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("$"),a("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{attrs:{class:"token keyword"}},[s._v("fastcgi_param")]),s._v("  SCRIPT_FILENAME  "),a("span",{attrs:{class:"token variable"}},[s._v("$document_root")]),a("span",{attrs:{class:"token variable"}},[s._v("$fastcgi_script_name")]),a("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{attrs:{class:"token keyword"}},[s._v("fastcgi_param")]),s._v("  PATH_INFO  "),a("span",{attrs:{class:"token variable"}},[s._v("$fastcgi_path_info")]),a("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{attrs:{class:"token keyword"}},[s._v("fastcgi_param")]),s._v("  PATH_TRANSLATED  "),a("span",{attrs:{class:"token variable"}},[s._v("$document_root")]),a("span",{attrs:{class:"token variable"}},[s._v("$fastcgi_path_info")]),a("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{attrs:{class:"token keyword"}},[s._v("include")]),s._v("        fastcgi_params"),a("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[this._v("D:\\phpStudy\\php70n\\php-cgi.exe -b 127.0.0.1:9001 -c D:\\phpStudy\\php70n\\php.ini\n")])]),this._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[this._v("1")]),t("br")])])},function(){var s=this.$createElement,t=this._self._c||s;return t("p",[this._v("使用 "),t("code",[this._v("netstat -no")]),this._v(" 命令查看端口是否工作正常。")])}],!1,null,null,null);t.default=e.exports}}]);