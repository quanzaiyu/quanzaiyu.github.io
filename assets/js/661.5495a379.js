(window.webpackJsonp=window.webpackJsonp||[]).push([[661],{921:function(t,s,a){"use strict";a.r(s);var n={props:["slot-key"],mounted(){this.$nextTick(function(){this.$vuepress.$emit("AsyncMarkdownContentMounted",this.slotKey)})}},e=a(0),o=Object(e.a)(n,function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.slotKey}},[a("h1",{attrs:{id:"service-worker-更新"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#service-worker-更新","aria-hidden":"true"}},[t._v("#")]),t._v(" Service Worker 更新")]),t._v(" "),a("p",[t._v("Service Worker 的更新也会影响到 Service Worker 的注册，在这里，重点剖析一下 Service Worker 更新的问题。")]),t._v(" "),a("p",[t._v("当页面注册好了一个 Service Worker 之后，Service Worker 会被安装、激活、通过 "),a("code",[t._v("fetch")]),t._v(" 事件监听作用域下站点的网络请求等等行为，为了 Web App 的首屏体验，"),a("a",{attrs:{href:"https://lavas.baidu.com/doc/architecture/the-app-shell-model",target:"_blank",rel:"noopener noreferrer"}},[t._v("AppShell"),a("OutboundLink")],1),t._v(" 作为最小优先展现单元，其中的 html 页面和静态资源是需要被持久缓存起来的。也就是说保证用户能在离线之后至少优先看到一个完整的 AppShell。")]),t._v(" "),a("p",[t._v("这个和优雅的注册 Service Worker 有个啥子关系？")]),t._v(" "),a("p",[t._v("拿 SPA 为例，作为 AppShell 的载体 "),a("code",[t._v("index.html")]),t._v(" 是会被缓存起来的，AppShell 的静态资源也都会被缓存起来的，然而 Service Worker 的注册必然是需要在 "),a("code",[t._v("index.html")]),t._v(" 的 "),a("code",[t._v("<script><\/script>")]),t._v(" 标签或者被缓存住的 js 文件中做的。")]),t._v(" "),a("p",[t._v("如果 "),a("code",[t._v("sw.js")]),t._v(" 发生了更新，我们预期的是希望浏览器立即更新当前页面的缓存，并且立即加载最新的内容和资源。"),a("code",[t._v("sw.js")]),t._v(" 的更新包含她 URL 的更新和内容的更新，Service Worker 本身的机制能够 diff 到 "),a("code",[t._v("sw.js")]),t._v(" 的更新，如果在注册时候通过 "),a("a",{attrs:{href:"https://w3c.github.io/ServiceWorker/#update-algorithm",target:"_blank",rel:"noopener noreferrer"}},[t._v("Service Worker Update 算法"),a("OutboundLink")],1),t._v(" diff 到 URL 或者 内容的更新，则马上启动新的 "),a("code",[t._v("sw.js")]),t._v(" 文件的安装、激活，但因为用户当前的页面已经使用老的缓存中的内容加载完成，所以需要等到第二次进入页面的时候才能真正使用新的静态资源和网络请求。")]),t._v(" "),a("p",[t._v("这个机制是有以下两个坑的：")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("sw.js")]),t._v(" 自身也会被浏览器缓存（也就是 diff 不能做到实时）")]),t._v(" "),a("li",[t._v("就算 diff 到了最新的 "),a("code",[t._v("sw.js")]),t._v("，用户在当前的这次访问中的任何交互还是使用老的缓存内容，需要等到第二次进入页面才能更新缓存")])]),t._v(" "),a("p",[t._v("对于 "),a("code",[t._v("sw.js")]),t._v(" HTTP 缓存的问题解决方案肯定是让这个文件永远都不缓存（暂时不讨论请求开销的问题）")]),t._v(" "),a("h2",{attrs:{id:"no-cache-处理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#no-cache-处理","aria-hidden":"true"}},[t._v("#")]),t._v(" no-cache 处理")]),t._v(" "),a("p",[t._v("为了能让 Service Worker 做到实时更新，必须要解决 Service Worker 文件 "),a("code",[t._v("sw.js")]),t._v(" HTTP 缓存的问题。\n通常需要让文件完全无缓存，有两种思路：一种是在服务器端控制请求文件的 "),a("code",[t._v("Cache-Control")]),t._v("，另一种就是在前端通过版本号来改变浏览器缓存策略。")]),t._v(" "),a("h3",{attrs:{id:"服务器-cache-control"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#服务器-cache-control","aria-hidden":"true"}},[t._v("#")]),t._v(" 服务器 Cache-Control")]),t._v(" "),a("p",[t._v("服务器端的 Cache-Control 的控制是将 "),a("code",[t._v("sw.js")]),t._v(" 的请求设置成 "),a("code",[t._v("no-cache")]),t._v("，以 nginx 为例：")]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{attrs:{class:"token keyword"}},[t._v("location")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("~")]),t._v(" \\"),a("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("sw\\"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("js$ "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{attrs:{class:"token keyword"}},[t._v("add_header")]),t._v(" Cache"),a("span",{attrs:{class:"token operator"}},[t._v("-")]),t._v("Control no"),a("span",{attrs:{class:"token operator"}},[t._v("-")]),t._v("store"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{attrs:{class:"token keyword"}},[t._v("add_header")]),t._v(" Pragma no"),a("span",{attrs:{class:"token operator"}},[t._v("-")]),t._v("cache"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("通过配置服务器这种方式的"),a("strong",[t._v("好处")]),t._v("是：只要做好了 "),a("code",[t._v("sw.js")]),t._v(" 缓存实时更新问题之后，就可以不用关心整个 Web App 的实时更新问题，浏览器都会参照 「"),a("code",[t._v("sw.js")]),t._v(" 的 diff」 -> 「重新安装新 "),a("code",[t._v("sw.js")]),t._v("」 -> 「激活并删除老的缓存」 ->「用户第二次进入页面重新更新缓存」的套路来自行搞定。")]),t._v(" "),a("p",[t._v("当然，这种处理方式也有很大的局限性，如果您将静态资源都部署在第三方的 CDN 静态资源服务器，单独针对某一个文件进行服务器设置 "),a("code",[t._v("sw.js")]),t._v(" 还是感觉很麻烦。尤其是对于大型站点的运维人员来说，在服务器新增一个路由不是一件很随意的事情。")]),t._v(" "),a("h3",{attrs:{id:"前端版本控制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前端版本控制","aria-hidden":"true"}},[t._v("#")]),t._v(" 前端版本控制")]),t._v(" "),a("p",[t._v("对于前端版本控制，前端开发者应该并不陌生，如果需要一个静态资源的请求永远不会被缓存，下面这种做法就很好理解了")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("navigator"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("serviceWorker"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  navigator"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("serviceWorker"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("register")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v("'/sw.js?v='")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("+")]),t._v(" Date"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("now")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("这段代码一祭出，就解决了之前所提到的 "),a("code",[t._v("sw.js")]),t._v(" 被浏览器缓存的问题了。")]),t._v(" "),a("p",[t._v("但是，这种做法又引发出了其他的问题，每次执行注册 Service Worker 代码逻辑的时候，Service Worker 都能 diff 到变化（URL 的变化也是一种更新的 diff），每次都会在第一次安装，第二次激活并且更新缓存，这种做法使得 Service Worker 的缓存完全没有生效，和每次都和请求最新的 Network 请求内容没什么区别，理论上讲，这种方式由于缓存的频繁读取和删除，甚至比每次直接无缓存刷新的性能更加糟糕。")]),t._v(" "),a("div",{staticClass:"warning custom-block"},[a("p",{staticClass:"custom-block-title"},[t._v("提醒")]),t._v(" "),a("p",[t._v("在 Service Worker 得注册过程中，慎用时间戳来做版本控制，会导致一些意想不到的坑。事实也证明这种做法也是不可取的。")])]),t._v(" "),a("p",[t._v("接下来转变一下思路，这个时候需要先想一想如何优雅的做好无缓存的版本控制了。如果不能对 "),a("code",[t._v("sw.js")]),t._v(" 直接做版本控制，能不能对别的文件做无缓存的版本控制，然后在这个文件中再执行 Service Worker 的注册逻辑？")]),t._v(" "),a("p",[t._v("假设这个文件叫 "),a("code",[t._v("sw-register.js")]),t._v("，其代码如下：")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{attrs:{class:"token comment"}},[t._v("// sw-register.js")]),t._v("\n"),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("navigator"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("serviceWorker"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  navigator"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("serviceWorker"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("register")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v("'/sw.js'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("then")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("reg"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n  "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("然后在 "),a("code",[t._v("index.html")]),t._v(" 中对 "),a("code",[t._v("sw-register.js")]),t._v(" 做版本控制就好了：")]),t._v(" "),a("div",{staticClass:"language-html extra-class"},[a("pre",{pre:!0,attrs:{class:"language-html"}},[a("code",[a("span",{attrs:{class:"token tag"}},[a("span",{attrs:{class:"token tag"}},[a("span",{attrs:{class:"token punctuation"}},[t._v("<")]),t._v("script")]),a("span",{attrs:{class:"token punctuation"}},[t._v(">")])]),a("span",{attrs:{class:"token script language-javascript"}},[t._v("\nwindow"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function-variable function"}},[t._v("onload")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{attrs:{class:"token keyword"}},[t._v("var")]),t._v(" script "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" document"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("createElement")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v("'script'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{attrs:{class:"token keyword"}},[t._v("var")]),t._v(" firstScript "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" document"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("getElementsByTagName")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v("'script'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token number"}},[t._v("0")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  script"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("type "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token string"}},[t._v("'text/javascript'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  script"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token boolean"}},[t._v("true")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  script"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("src "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token string"}},[t._v("'/sw-register.js?v='")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("+")]),t._v(" Date"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("now")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  firstScript"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("parentNode"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("insertBefore")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("script"),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" firstScript"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")]),a("span",{attrs:{class:"token tag"}},[a("span",{attrs:{class:"token tag"}},[a("span",{attrs:{class:"token punctuation"}},[t._v("</")]),t._v("script")]),a("span",{attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),a("p",[t._v("这样处理之后，"),a("code",[t._v("sw-register.js")]),t._v(" 就不会被浏览器缓存了，并且由于 "),a("code",[t._v("sw-register.js")]),t._v(" 是异步加载的，也不会造成页面 block，但还有个问题，当前的 "),a("code",[t._v("sw.js")]),t._v(" 依然会被浏览器 HTTP 缓存。根本问题还是没有解决。")]),t._v(" "),a("p",[t._v("其实设想一下，每次 Service Worker 的更新都是因为工程的上线，如果能够保证每次上线一次就赋给 "),a("code",[t._v("sw.js")]),t._v(" 一个版本，等新上线之后就用新的版本号替换老的版本号，从而触发 Service Worker 的 diff，并且能保证每次上线之后就更新了新的 "),a("code",[t._v("sw.js")]),t._v("。")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{attrs:{class:"token comment"}},[t._v("// sw-register.js")]),t._v("\n"),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("navigator"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("serviceWorker"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  navigator"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("serviceWorker"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("register")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v("'/sw.js?v=buildVersion'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("then")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("reg"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n  "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("其中 "),a("code",[t._v("buildVersion")]),t._v(" 是每次上线前构建的一个唯一版本号。")]),t._v(" "),a("p",[t._v("这样看来，是解决了之前 Service Worker 更新不及时的问题。但是代价是增加了一次 "),a("code",[t._v("sw-register.js")]),t._v(" 的请求，由于 "),a("code",[t._v("sw-register.js")]),t._v(" 通常只做 Service Worker 的注册工作，体量不会太大，所以应该还是可以接受，相比于在服务器端的配置，前端的版本控制的方案应该更加的简单方便。")]),t._v(" "),a("h3",{attrs:{id:"为什么不直接使用-buildtime-做版本控制？"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#为什么不直接使用-buildtime-做版本控制？","aria-hidden":"true"}},[t._v("#")]),t._v(" 为什么不直接使用 buildTime 做版本控制？")]),t._v(" "),a("p",[t._v("绕了一圈，版本控制为什么不直接在 注册 "),a("code",[t._v("sw.js")]),t._v(" 时候做，为什么非要借助一个 "),a("code",[t._v("sw-register.js")]),t._v(" 文件？就像如下代码：")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("navigator"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("serviceWorker"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  navigator"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("serviceWorker"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("register")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v("'/sw.js?v=buildTime'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("then")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("为了保证离线可用，所有和 AppShell 相关的 html 和静态资源都要被缓存住，此时，就算上线时候更改了 "),a("code",[t._v("buildTime")]),t._v(", 但是 Service Worker 所有可能被注册的地方由于被缓存了是感知不到变化的，除非是用 "),a("code",[t._v("Date.now()")]),t._v(" 这种变量时间戳的方式自动轮询，但是这种方案的弊端在前面已经分析过了。")]),t._v(" "),a("h2",{attrs:{id:"service-worker-缓存实时生效"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#service-worker-缓存实时生效","aria-hidden":"true"}},[t._v("#")]),t._v(" Service Worker 缓存实时生效")]),t._v(" "),a("p",[t._v("Service Worker 是一个独立于浏览器主线程的 Worker 线程，在这个线程 Context 中是不允许操作页面的 DOM，但是 Worker 线程可以通过 postMessage 机制与主线程进行通信。")]),t._v(" "),a("p",[t._v("通过前面对 Service Worker 的介绍，已经了解到 Service Worker 更新的第二个痛点是必须要等到用户第二次进入页面的时候才能使用 Service Worker 更新之后的内容，我们的预期是如果 Web App 重新上线了，那用户在任何时候打开页面都能使用到最新的内容，并且同时还要保持 Service Worker 离线缓存的特性。")]),t._v(" "),a("p",[t._v("通过对 "),a("code",[t._v("sw.js")]),t._v(" 文件的无缓存处理，我们能做到实时的检测更新，接下来需要处理缓存更新实时生效的问题。")]),t._v(" "),a("p",[t._v("当注册 Service Worker 得时候，实时监测到 "),a("code",[t._v("sw.js")]),t._v(" 更新之后，则浏览器会立即立即安装、激活，然而激活完成并清除老的缓存之后，如果有一种途径告诉主线程 "),a("code",[t._v("sw 完成了更新")]),t._v(" 这样也会对用户比较友好。")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{attrs:{class:"token comment"}},[t._v("// sw.js 文件")]),t._v("\n"),a("span",{attrs:{class:"token comment"}},[t._v("// 新的 Service Worker 更新时，进入激活状态后，会触发 activate 事件")]),t._v("\nself"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("addEventListener")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v("'activate'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("event"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{attrs:{class:"token keyword"}},[t._v("var")]),t._v(" cacheName "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token string"}},[t._v("'a_cache_name'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  event"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("waitUntil")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    caches"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("open")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cacheName"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("then")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cache"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{attrs:{class:"token comment"}},[t._v("// 进行老缓存的清除...(略过..)")]),t._v("\n      "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("then")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{attrs:{class:"token comment"}},[t._v("// 完成缓存删除之后就可以通知浏览器主线程啦")]),t._v("\n        "),a("span",{attrs:{class:"token comment"}},[t._v("// 当然这里也可以判断如果缓存内本来就没内容")]),t._v("\n        "),a("span",{attrs:{class:"token comment"}},[t._v("// 就代表是首次安装，就不要发 message了 (这个逻辑略过...)")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" self"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("clients"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("matchAll")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n          "),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("then")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("clients"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("clients "),a("span",{attrs:{class:"token operator"}},[t._v("&&")]),t._v(" clients"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n              clients"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("forEach")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("client"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                "),a("span",{attrs:{class:"token comment"}},[t._v("// 给每个已经打开的标签都 postMessage")]),t._v("\n                client"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("postMessage")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v("'sw.update'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n              "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n          "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("p",[t._v("这样的话，相当于我们在自己的业务代码中只要监听 "),a("code",[t._v("message")]),t._v(" 事件，监听到 "),a("code",[t._v("sw.update")]),t._v(" 这个 message 就知道 Service Worker 更新成功了。看来这段代码写在 "),a("code",[t._v("sw-register.js")]),t._v(" 中比较优雅，我们可以把 "),a("code",[t._v("sw-register.js")]),t._v(" 这个文件就当成专门处理 Service Worker 的文件好了。")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{attrs:{class:"token comment"}},[t._v("// sw-register.js")]),t._v("\n"),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("navigator"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("serviceWorker"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  navigator"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("serviceWorker"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("addEventListener")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token string"}},[t._v("'message'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("e"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("e"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data "),a("span",{attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),a("span",{attrs:{class:"token string"}},[t._v("'sw.update'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{attrs:{class:"token comment"}},[t._v("// 如果代码走到了在这里，就知道了，Service Worker 已经更新完成了")]),t._v("\n      "),a("span",{attrs:{class:"token comment"}},[t._v("// 可以做点什么事情让用户体验更好")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h3",{attrs:{id:"service-worker-实时生效的策略"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#service-worker-实时生效的策略","aria-hidden":"true"}},[t._v("#")]),t._v(" Service Worker 实时生效的策略")]),t._v(" "),a("p",[t._v("通常对用户比较友好的实时生效策略有两种：")]),t._v(" "),a("ul",[a("li",[t._v("监听到 Service Worker 成功更新后，直接 location.reload() 刷新当前页面")]),t._v(" "),a("li",[t._v("通过 toast 的形式提示用户主动刷新当前页面")])]),t._v(" "),a("p",[t._v("目前百度 Lavas 解决方案推荐的是第二种引导用户刷新的方式。")]),t._v(" "),a("imgLink",{attrs:{src:"shortcut/141.png/small"}})],1)},[],!1,null,null,null);o.options.__file="SW_Update.md";s.default=o.exports}}]);