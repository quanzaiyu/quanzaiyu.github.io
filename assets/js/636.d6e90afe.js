(window.webpackJsonp=window.webpackJsonp||[]).push([[636],{584:function(t,s,a){"use strict";a.r(s);var n={props:["slot-key"],mounted(){this.$nextTick(function(){this.$vuepress.$emit("AsyncMarkdownContentMounted",this.slotKey)})}},e=a(0),r=Object(e.a)(n,function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.slotKey}},[a("h1",{attrs:{id:"nginx-服务器中-php-调用本地接口失败的解决方案"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#nginx-服务器中-php-调用本地接口失败的解决方案","aria-hidden":"true"}},[t._v("#")]),t._v(" Nginx 服务器中 PHP 调用本地接口失败的解决方案")]),t._v(" "),a("h2",{attrs:{id:"问题现象"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#问题现象","aria-hidden":"true"}},[t._v("#")]),t._v(" 问题现象")]),t._v(" "),a("p",[t._v("当在同一个 PHP 项目中访问同一个项目中的接口的时候，会出现访问超时、加载不出数据甚至卡死的问题。")]),t._v(" "),a("h2",{attrs:{id:"问题原因"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#问题原因","aria-hidden":"true"}},[t._v("#")]),t._v(" 问题原因")]),t._v(" "),a("p",[t._v("NGINX 中，看 PHP 文件块 fastcig-pass 的设置值(127.0.0.1:9000)。设置都是以 keepalive 方式请求，接收到 PHP 文件时，交于后端过程 PHPCGI 解析处理(127.0.0.1:9000)，等待响应。")]),t._v(" "),a("p",[t._v("而在本地文件以 CURL 请求本地环境中 PHP 文件时，之前的 PHP 还在等待 CURL 后的结果，这时 9000 端口已经被占用。导致 CURL 一直在处于等待状态。不设置 timeout 超时，程序就会卡死。")]),t._v(" "),a("h2",{attrs:{id:"解决方案"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解决方案","aria-hidden":"true"}},[t._v("#")]),t._v(" 解决方案")]),t._v(" "),a("p",[t._v("第一步，使用负载均衡的方式为 php-cgi 设置多个端口，比如:")]),t._v(" "),a("div",{staticClass:"language-nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{attrs:{class:"token keyword"}},[t._v("upstream")]),t._v(" backend"),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{attrs:{class:"token keyword"}},[t._v("server")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("127.0")]),a("span",{attrs:{class:"token number"}},[t._v(".0")]),a("span",{attrs:{class:"token number"}},[t._v(".1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{attrs:{class:"token number"}},[t._v("9000")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{attrs:{class:"token keyword"}},[t._v("server")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("127.0")]),a("span",{attrs:{class:"token number"}},[t._v(".0")]),a("span",{attrs:{class:"token number"}},[t._v(".1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{attrs:{class:"token number"}},[t._v("9001")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{attrs:{class:"token keyword"}},[t._v("server")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{attrs:{class:"token keyword"}},[t._v("listen")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("80")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{attrs:{class:"token keyword"}},[t._v("server_name")]),t._v("  www"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dyt_api"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("com "),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{attrs:{class:"token keyword"}},[t._v("root")]),t._v("   "),a("span",{attrs:{class:"token string"}},[t._v('"D:/projects/dyt_api/public"')]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{attrs:{class:"token keyword"}},[t._v("location")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("index")]),t._v("  "),a("span",{attrs:{class:"token keyword"}},[t._v("index")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("html "),a("span",{attrs:{class:"token keyword"}},[t._v("index")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("htm "),a("span",{attrs:{class:"token keyword"}},[t._v("index")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("php"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token comment"}},[t._v("#autoindex  on;")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token operator"}},[t._v("!")]),a("span",{attrs:{class:"token operator"}},[t._v("-")]),t._v("e "),a("span",{attrs:{class:"token variable"}},[t._v("$request_filename")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{attrs:{class:"token keyword"}},[t._v("rewrite")]),t._v("  "),a("span",{attrs:{class:"token operator"}},[t._v("^")]),a("span",{attrs:{class:"token operator"}},[t._v("/")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("$  "),a("span",{attrs:{class:"token operator"}},[t._v("/")]),a("span",{attrs:{class:"token keyword"}},[t._v("index")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("php"),a("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("$"),a("span",{attrs:{class:"token number"}},[t._v("1")]),t._v("  last"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),a("span",{attrs:{class:"token keyword"}},[t._v("break")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{attrs:{class:"token keyword"}},[t._v("location")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("~")]),t._v(" \\"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token function"}},[t._v("php")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token operator"}},[t._v("*")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("$ "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("fastcgi_pass")]),t._v("   backend"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("fastcgi_index")]),t._v("  "),a("span",{attrs:{class:"token keyword"}},[t._v("index")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("php"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("fastcgi_split_path_info")]),t._v("  "),a("span",{attrs:{class:"token operator"}},[t._v("^")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token operator"}},[t._v("?")]),t._v("U"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token operator"}},[t._v("+")]),t._v("\\"),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("php"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token operator"}},[t._v("/")]),a("span",{attrs:{class:"token operator"}},[t._v("?")]),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token operator"}},[t._v("+")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("$"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("fastcgi_param")]),t._v("  SCRIPT_FILENAME  "),a("span",{attrs:{class:"token variable"}},[t._v("$document_root")]),a("span",{attrs:{class:"token variable"}},[t._v("$fastcgi_script_name")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("fastcgi_param")]),t._v("  PATH_INFO  "),a("span",{attrs:{class:"token variable"}},[t._v("$fastcgi_path_info")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("fastcgi_param")]),t._v("  PATH_TRANSLATED  "),a("span",{attrs:{class:"token variable"}},[t._v("$document_root")]),a("span",{attrs:{class:"token variable"}},[t._v("$fastcgi_path_info")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("include")]),t._v("        fastcgi_params"),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("第二步，重启 nginx，并新开启一个 phpcgi 进程监听不同端口，比如:")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("D:\\phpStudy\\php70n\\php-cgi.exe -b 127.0.0.1:9001 -c D:\\phpStudy\\php70n\\php.ini\n")])])]),a("p",[t._v("使用 "),a("code",[t._v("netstat -no")]),t._v(" 命令查看端口是否工作正常。")]),t._v(" "),a("h2",{attrs:{id:"参考资料"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考资料","aria-hidden":"true"}},[t._v("#")]),t._v(" 参考资料")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://www.cnblogs.com/wamptao/p/6381913.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("PHP----------用curl方式请求接口在同一个项目里面的时候不能请求的情况"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("a",{attrs:{href:"https://blog.csdn.net/yicixing7/article/details/77323706",target:"_blank",rel:"noopener noreferrer"}},[t._v("为什么本地开发时使用CURL请求本地URL会卡死"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("a",{attrs:{href:"https://blog.csdn.net/php_younger/article/details/54890136",target:"_blank",rel:"noopener noreferrer"}},[t._v("搭建nginx负载均衡"),a("OutboundLink")],1)])])},[],!1,null,null,null);r.options.__file="Local_API.md";s.default=r.exports}}]);